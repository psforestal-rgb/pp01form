<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PP-01 ACOPAC (Field Fix)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>

    <style>
        /* CORRECCIÓN VISUAL: Asegura que los bloques no corten contenido */
        .block-content { 
            transition: all 0.3s ease-out; 
            overflow: hidden; 
            padding: 16px; 
            background: #ffffff; 
            /* Valor muy alto para permitir muchas fotos sin cortar */
            max-height: 15000px; 
            opacity: 1;
        }
        .block-content.collapsed { 
            max-height: 0 !important; 
            opacity: 0; 
            padding-top: 0 !important; 
            padding-bottom: 0 !important; 
            border: none;
        }

        /* CORRECCIÓN VISUAL: Botones de cámara responsivos */
        .btn-camera { 
            background-color: #dbeafe; 
            border: 3px dashed #2563eb; 
            color: #1e40af; 
            width: 100%; 
            padding: 15px;
            text-align: center; 
            border-radius: 14px; 
            cursor: pointer; 
            margin-top: 10px; 
            position: relative; 
            overflow: hidden; 
            font-size: 1em; 
            font-weight: 600; 
            z-index: 1; 
            /* Flexbox para centrar contenido y evitar desbordes */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            min-height: 130px;
        }
        .btn-camera .text-sm {
            white-space: normal;
            line-height: 1.2;
            margin-top: 5px;
            width: 100%;
        }

        /* ESTILOS BASE (Mantenidos del original) */
        :root { --text-primary: #000000; --bg-primary: #ffffff; }
        body { font-family: 'Roboto', sans-serif; background-color: #d1d5db; margin: 0; padding-top: 60px; font-size: 17px; }
        
        .view-controls { position: fixed; top: 0; left: 0; right: 0; height: 48px; background: #1f2937; display: flex; align-items: center; justify-content: center; gap: 12px; z-index: 1000; }
        .view-btn { background: transparent; border: 2px solid #9ca3af; color: #f3f4f6; padding: 6px 14px; border-radius: 16px; font-weight: 600; }
        .view-btn.active { background: #166534; border-color: #166534; }
        
        .kobo-container { background: white; margin: 20px auto; position: relative; }
        .mobile-mode { max-width: 420px; border-radius: 20px; border: 8px solid #1f2937; min-height: 90vh; }
        
        .group-header { background: #111827; padding: 14px 16px; border-bottom: 4px solid #000000; font-weight: 800; color: #ffffff; position: sticky; top: 0; z-index: 50; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .group-header.has-records { background: #14532d; }
        .group-header.empty-section { background: #374151; }
        
        .question { padding: 12px 16px; border-bottom: 2px solid #000000; background: #ffffff; }
        .input-field { width: 100%; padding: 14px; border: 3px solid #000000; border-radius: 12px; font-size: 18px; box-sizing: border-box; }
        
        .btn-add { background: #FFFFFF; color: #000000; border: 3px solid #000000; padding: 18px 20px; border-radius: 12px; cursor: pointer; margin: 12px 16px; width: calc(100% - 32px); font-weight: 700; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-collapse-bottom { background: #111827; color: #FFFFFF; border: 3px solid #000000; padding: 12px; width: 100%; border-radius: 8px; margin-top: 12px; }
        
        .repeat-block { border-left: 8px solid #000000; margin: 10px 12px 16px 12px; background: #FFFFFF; border-radius: 0 12px 12px 0; }
        .block-header { background: #111827; display: flex; justify-content: space-between; padding: 14px 16px; border-bottom: 4px solid #000000; color: white; border-radius: 0 10px 0 0; }
        .block-status.saved { background: #00C853; color: black; border: 2px solid black; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
        .block-status.pending { background: #FFD400; color: black; border: 2px solid black; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
        
        .dashboard-card { background: #FFFFFF; border: 3px solid #000000; padding: 14px; border-radius: 12px; margin: 16px; }
        
        /* Map Styles */
        .map-layer-btn { background: #FFFFFF; color: #000000; border: 3px solid #000000; border-radius: 12px; padding: 12px 14px; font-weight: 700; cursor: pointer; margin: 2px; }
        .map-layer-btn.active { background: #000000; color: #FFFFFF; }
        
        .hidden { display: none; }
        .hidden-section { display: none; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; border-radius: 14px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 0; }
        .modal-header { background: #111827; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        
        /* Tabs */
        .tab-btn { padding: 10px; border-bottom: 4px solid transparent; opacity: 0.6; }
        .tab-btn.active { border-bottom-color: #166534; opacity: 1; font-weight: bold; }
    </style>
</head>
<body>
    <div id="camera_modal" class="fixed inset-0 bg-black z-[2000] hidden flex flex-col">
        <div class="flex-1 relative bg-gray-900 flex items-center justify-center overflow-hidden">
            <div class="absolute inset-0 opacity-70 bg-cover bg-center" style="background-image:url('https://images.unsplash.com/photo-1448375240586-dfd8d395ea6c?auto=format&fit=crop&w=800&q=80')"></div>
            <div class="absolute top-4 right-4 text-white p-4" onclick="closeCamera()"><i class="fas fa-times fa-2x"></i></div>
        </div>
        <div class="h-32 bg-black flex items-center justify-center gap-10 pb-4">
            <button onclick="snapPhoto()" class="w-20 h-20 rounded-full bg-white border-4 border-gray-300 shadow-lg"></button>
        </div>
    </div>

    <div class="view-controls">
        <button class="view-btn active" onclick="document.getElementById('main-container').className='kobo-container mobile-mode'">Móvil</button>
        <button class="view-btn" onclick="document.getElementById('main-container').className='kobo-container desktop-mode'">Tablet</button>
    </div>

    <div id="main-container" class="kobo-container mobile-mode">
        <div class="p-5 border-b border-gray-200 sticky top-0 bg-white z-20">
            <h1 class="text-xl font-bold text-center">PP-01 ACOPAC<br><span class="text-sm font-normal">v2026-02-08 (Fix)</span></h1>
        </div>

        <div class="form-content">
            <div id="inspeccion_header" class="p-4 bg-gray-600 border-b border-gray-700">
                <div class="flex flex-col gap-3">
                    <label class="text-sm font-bold text-white"><i class="fas fa-clock mr-2"></i>Inicio de Inspección</label>
                    <div class="flex items-center gap-3">
                        <input type="text" id="start_time" class="input-field text-center font-mono" readonly placeholder="Esperando iniciar...">
                        <button onclick="iniciarInspeccion()" id="btn_iniciar" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                    <div id="inicio_status" class="hidden text-white font-bold text-center bg-green-600 rounded p-1">EN PROGRESO</div>
                    <div id="tracking_status" class="hidden text-white text-xs text-center">GPS Activo</div>
                </div>
            </div>

            <div class="group-header" onclick="toggleSection('sec_expediente', this)"><span>DATOS EXPEDIENTE</span><i class="fas fa-chevron-down"></i></div>
            <div id="sec_expediente" class="section-content hidden-section">
                <div class="question">
                    <label>Número de Expediente</label>
                    <div class="flex gap-2">
                        <select id="expediente_id" class="input-field" onchange="loadExpedienteData()"><option value="">Cargando...</option></select>
                        <button onclick="loadExpedientesFromSheet()" class="bg-blue-100 p-3 rounded"><i class="fas fa-sync"></i></button>
                    </div>
                    <div id="data_fields" class="mt-4 opacity-50">
                        <div class="mb-2"><label class="text-sm font-bold">Solicitante</label><input type="text" id="solicitante" class="input-field" readonly></div>
                        <div class="mb-2"><label class="text-sm font-bold">Finca / Plano</label><input type="text" id="finca_num" class="input-field" readonly></div>
                        <input type="hidden" id="fecha_recepcion"><input type="hidden" id="plano_num"><input type="hidden" id="area_ha"><input type="hidden" id="cedula"><input type="hidden" id="telefono">
                    </div>
                </div>
            </div>

            <div class="group-header" onclick="toggleSection('sec_generales', this)"><span>DATOS GENERALES</span><i class="fas fa-chevron-down"></i></div>
            <div id="sec_generales" class="section-content hidden-section">
                <div class="question"><label>Profesional</label><input type="text" id="input_profesional" class="input-field" value="Pablo César Sánchez Núñez"></div>
                <div class="question"><label>Asistente 1</label><input type="text" id="input_asistente1" class="input-field" value="Federico Berrocal Saborío"></div>
                <div id="container_acompanantes"></div>
                <button class="btn-add" onclick="addAcompanante()"><i class="fas fa-user-plus"></i> Agregar Acompañante</button>
            </div>

            <div class="group-header" onclick="toggleSection('sec_ubicacion', this)"><span>UBICACIÓN / VÉRTICES</span><i class="fas fa-chevron-down"></i></div>
            <div id="sec_ubicacion" class="section-content hidden-section">
                <div id="container_vertices"></div>
                <button class="btn-add" onclick="addVertice()"><i class="fas fa-plus"></i> Agregar Vértice</button>
            </div>

            <div class="group-header" onclick="toggleSection('sec_arboles', this)"><span>INVENTARIO (ÁRBOLES)</span><i class="fas fa-chevron-down"></i></div>
            <div id="sec_arboles" class="section-content hidden-section">
                <div id="container_arboles"></div>
                <button class="btn-add" onclick="addArbol()"><i class="fas fa-plus"></i> Agregar Árbol</button>
            </div>

            <div class="group-header" onclick="toggleSection('sec_agua', this)"><span>FUENTES DE AGUA</span><i class="fas fa-chevron-down"></i></div>
            <div id="sec_agua" class="section-content hidden-section">
                <div id="container_agua"></div>
                <button class="btn-add" onclick="addFuente()"><i class="fas fa-plus"></i> Agregar Fuente</button>
            </div>

            <div class="group-header" onclick="toggleSection('sec_obs_finales', this)"><span>OBSERVACIONES</span><i class="fas fa-chevron-down"></i></div>
            <div id="sec_obs_finales" class="section-content hidden-section">
                <div id="container_obs_finales"></div>
                <button class="btn-add" onclick="addObservacion()"><i class="fas fa-plus"></i> Agregar Observación</button>
            </div>

            <div class="dashboard-card mt-6">
                <h3 class="font-bold mb-2">Mapa de Inspección (WMS Fix)</h3>
                <div class="flex flex-wrap gap-2 mb-2">
                    <button onclick="toggleMapLayer('trees')" class="map-layer-btn active" data-layer="trees">Árboles</button>
                    <button onclick="toggleMapLayer('vertices')" class="map-layer-btn active" data-layer="vertices">Vértices</button>
                    <button onclick="toggleMapLayer('track')" class="map-layer-btn active" data-layer="track">Track</button>
                    <button onclick="centerMapOnData()" class="map-layer-btn bg-blue-100">Centrar</button>
                </div>
                <div id="inspeccion_map" style="height: 400px; width: 100%; border-radius: 12px; border: 3px solid black;"></div>
            </div>

            <div class="dashboard-card mt-6">
                <h3 class="font-bold mb-2">Sistema de Respaldo</h3>
                <div class="flex items-center gap-3 mb-4 p-3 bg-gray-100 rounded">
                    <div id="backup_status_indicator" class="w-3 h-3 rounded-full bg-green-500"></div>
                    <span id="backup_status_text">Listo</span>
                    <span class="text-xs text-gray-500 ml-auto" id="last_save_time">Hace 0s</span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportarInspeccionAZip()" class="bg-green-100 text-green-800 py-3 rounded font-bold">Exportar ZIP</button>
                    <button onclick="document.getElementById('import_zip_input').click()" class="bg-blue-100 text-blue-800 py-3 rounded font-bold">Importar ZIP</button>
                </div>
                <input type="file" id="import_zip_input" class="hidden" accept=".zip" onchange="importarDesdeZip(this.files[0])">
                <button onclick="mostrarModalBackups()" class="w-full mt-3 bg-gray-200 py-2 rounded font-bold">Ver Backups / Restaurar</button>
            </div>

            <div class="p-5 pb-8">
                <button onclick="finalizarInspeccion()" id="btn_finish" class="w-full bg-green-600 text-white font-bold py-5 rounded-xl text-lg">
                    <i class="fas fa-check-circle"></i> Finalizar Inspección
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay hidden" id="modal_backups">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Gestión de Backups</h3>
                <button onclick="document.getElementById('modal_backups').classList.add('hidden')" class="text-white font-bold text-xl">&times;</button>
            </div>
            <div class="modal-body">
                <div class="flex mb-4 gap-2">
                    <button class="tab-btn active" onclick="switchTab('pending')">Pendientes</button>
                    <button class="tab-btn" onclick="switchTab('saved')">Guardados</button>
                </div>
                <div id="backups_list_container" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
        // VARIABLES GLOBALES
        let countArboles = 0;
        let countVertices = 0;
        let countFuentes = 0;
        let countObservaciones = 0;
        let countAcompanantes = 0;
        let inspeccionIniciada = false;
        let trackPoints = [];
        let inspeccionMap = null;
        let mapLayers = { trees: {visible:true}, vertices: {visible:true}, observations: {visible:true}, track: {visible:true} };
        
        // --- 1. DOM & UI FUNCTIONS (CORREGIDAS PARA BACKUP) ---

        function toggleSection(id, header) {
            const sec = document.getElementById(id);
            if(sec.classList.contains('hidden-section')) {
                sec.classList.remove('hidden-section');
                header.classList.add('active');
            } else {
                sec.classList.add('hidden-section');
                header.classList.remove('active');
            }
        }

        function collapseBlockFromBottom(blockId) {
            const content = document.getElementById('content_' + blockId);
            if (content) content.classList.add('collapsed');
            document.getElementById(blockId).scrollIntoView({behavior: 'smooth', block: 'start'});
        }

        function toggleBlock(blockId, toggleBtn) {
            const content = document.getElementById('content_' + blockId);
            content.classList.toggle('collapsed');
        }

        // --- FUNCIONES ADD CON SOPORTE DE ID EXPLÍCITO (CRÍTICO PARA BACKUP) ---

        function addVertice(explicitId = null) {
            let currentId;
            if (explicitId) {
                currentId = parseInt(explicitId);
                if (currentId > countVertices) countVertices = currentId;
            } else {
                countVertices++;
                currentId = countVertices;
            }
            
            const blockId = 'vertice_block_' + currentId;
            const d = document.createElement('div');
            d.className = 'repeat-block';
            d.id = blockId;
            d.innerHTML = `
                <div class="block-header" onclick="toggleBlock('${blockId}')">
                    <span><i class="fas fa-map-marker-alt"></i> Vértice #${currentId}</span>
                    <span class="block-status pending" id="status_v${currentId}">Pendiente</span>
                </div>
                <div id="content_${blockId}" class="block-content">
                    <div class="mb-3"><label>Número</label><input type="number" id="num_vertice_${currentId}" class="input-field" value="${currentId}"></div>
                    <div class="mb-3"><label>Observación</label><input type="text" id="obs_vertice_${currentId}" class="input-field"></div>
                    
                    <div class="mb-3 bg-gray-100 p-2 rounded">
                        <button onclick="startGPS('v${currentId}')" id="btn_start_gps_v${currentId}" class="bg-blue-600 text-white p-2 rounded w-full">Capturar GPS</button>
                        <div id="gps_display_v${currentId}" class="hidden mt-2 font-mono text-xs"></div>
                    </div>

                    <div class="mb-3">
                        <input type="file" accept="image/*" capture="environment" id="cam_vertice_${currentId}" class="hidden" onchange="photoSelected(this, 'btn_cam_vertice_${currentId}')">
                        <div class="btn-camera" id="btn_cam_vertice_${currentId}" onclick="document.getElementById('cam_vertice_${currentId}').click()">
                            <i class="fas fa-camera fa-2x"></i><br><span class="text-sm">FOTO</span>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-4">
                        <button onclick="saveVerticeData(${currentId})" id="btn_save_vertice_${currentId}" class="bg-blue-100 text-blue-800 p-3 rounded flex-1 font-bold">Guardar</button>
                        <button onclick="removeElement('${blockId}')" class="bg-red-100 text-red-800 p-3 rounded font-bold">Borrar</button>
                    </div>
                    <button class="btn-collapse-bottom" onclick="collapseBlockFromBottom('${blockId}')">Cerrar</button>
                </div>`;
            document.getElementById('container_vertices').appendChild(d);
            if (!explicitId) d.scrollIntoView({ behavior: 'smooth' });
        }

        function addArbol(explicitId = null) {
            let currentId;
            if (explicitId) {
                currentId = parseInt(explicitId);
                if (currentId > countArboles) countArboles = currentId;
            } else {
                countArboles++;
                currentId = countArboles;
            }

            const blockId = 'arbol_' + currentId;
            const d = document.createElement('div');
            d.className = 'repeat-block border-green-500'; // Visual distinction
            d.id = blockId;
            
            d.innerHTML = `
                <div class="block-header" onclick="toggleBlock('${blockId}')" style="background:#14532d;">
                    <span><i class="fas fa-tree"></i> Árbol #${currentId}</span>
                    <span class="block-status pending" id="status_t${currentId}">Pendiente</span>
                </div>
                <div id="content_${blockId}" class="block-content">
                    <div class="mb-3"><label>Número</label><input type="number" id="num_arbol_${currentId}" class="input-field" value="${currentId}"></div>
                    
                    <div class="mb-3">
                        <label>Especie</label>
                        <input type="text" id="sp_arbol_${currentId}" class="input-field" list="species_list">
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div><label>DAP (cm)</label><input type="number" id="val_medida_${currentId}" class="input-field" oninput="calculateVolume(${currentId})"></div>
                        <div><label>LCT (m)</label><input type="number" id="val_lct_${currentId}" class="input-field" oninput="calculateVolume(${currentId})"></div>
                    </div>
                    <div class="bg-gray-100 p-2 rounded text-center mb-3">
                        Volumen: <span id="res_volumen_${currentId}" data-vol="0" class="font-bold text-green-700">0.0000</span> m³
                    </div>

                    <div class="mb-3 bg-gray-100 p-2 rounded">
                        <button onclick="startGPS('t${currentId}')" id="btn_start_gps_t${currentId}" class="bg-blue-600 text-white p-2 rounded w-full">Capturar GPS</button>
                        <div id="gps_display_t${currentId}" class="hidden mt-2 font-mono text-xs"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div class="btn-camera" id="btn_cam_arbol_${currentId}_1" onclick="triggerCamera('cam_arbol_${currentId}_1')">
                            <input type="file" id="cam_arbol_${currentId}_1" class="hidden" accept="image/*" onchange="photoSelected(this, 'btn_cam_arbol_${currentId}_1')">
                            <i class="fas fa-camera"></i><span class="text-sm">Árbol</span>
                        </div>
                        <div class="btn-camera" id="btn_cam_arbol_${currentId}_2" onclick="triggerCamera('cam_arbol_${currentId}_2')">
                            <input type="file" id="cam_arbol_${currentId}_2" class="hidden" accept="image/*" onchange="photoSelected(this, 'btn_cam_arbol_${currentId}_2')">
                            <i class="fas fa-camera"></i><span class="text-sm">Entorno</span>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-4">
                        <button onclick="saveArbolData(${currentId})" id="btn_save_arbol_${currentId}" class="bg-blue-100 text-blue-800 p-3 rounded flex-1 font-bold">Guardar</button>
                        <button onclick="removeElement('${blockId}')" class="bg-red-100 text-red-800 p-3 rounded font-bold">Borrar</button>
                    </div>
                    <button class="btn-collapse-bottom" onclick="collapseBlockFromBottom('${blockId}')">Cerrar</button>
                    
                    <textarea id="wildlife_relations_json_t${currentId}" class="hidden">[]</textarea>
                </div>`;
            document.getElementById('container_arboles').appendChild(d);
            if(!explicitId) d.scrollIntoView({ behavior: 'smooth' });
        }

        // Add Fuente & Observacion follow same pattern...
        function addFuente(explicitId = null) {
            let currentId;
            if(explicitId) { currentId = parseInt(explicitId); if(currentId>countFuentes) countFuentes=currentId; } 
            else { countFuentes++; currentId = countFuentes; }
            
            const blockId = 'fuente_block_' + currentId;
            const d = document.createElement('div');
            d.className = 'repeat-block border-blue-400';
            d.id = blockId;
            d.innerHTML = `
                <div class="block-header" onclick="toggleBlock('${blockId}')" style="background:#1e3a8a;">
                    <span><i class="fas fa-water"></i> Fuente #${currentId}</span>
                    <span class="block-status pending" id="status_w${currentId}">Pendiente</span>
                </div>
                <div id="content_${blockId}" class="block-content">
                    <input type="hidden" id="num_fuente_${currentId}" value="${currentId}">
                    <div class="mb-3"><label>Tipo</label><select id="tipo_fuente_${currentId}" class="input-field"><option>Naciente</option><option>Cauce</option><option>Otro</option></select></div>
                    <div class="mb-3 bg-gray-100 p-2 rounded"><button onclick="startGPS('w${currentId}')" id="btn_start_gps_w${currentId}" class="bg-blue-600 text-white p-2 w-full">GPS</button><div id="gps_display_w${currentId}" class="hidden"></div></div>
                    <button onclick="saveFuenteData(${currentId})" id="btn_save_fuente_${currentId}" class="bg-blue-100 text-blue-800 p-3 rounded w-full font-bold">Guardar</button>
                </div>`;
            document.getElementById('container_agua').appendChild(d);
        }

        function addObservacion(explicitId = null) {
            let currentId;
            if(explicitId) { currentId = parseInt(explicitId); if(currentId>countObservaciones) countObservaciones=currentId; } 
            else { countObservaciones++; currentId = countObservaciones; }
            
            const blockId = 'obs_final_' + currentId;
            const d = document.createElement('div');
            d.className = 'repeat-block';
            d.id = blockId;
            d.innerHTML = `
                <div class="block-header" onclick="toggleBlock('${blockId}')">
                    <span><i class="fas fa-clipboard"></i> Obs #${currentId}</span>
                    <span class="block-status pending" id="status_o${currentId}">Pendiente</span>
                </div>
                <div id="content_${blockId}" class="block-content">
                    <textarea id="detalle_obs_${currentId}" class="input-field" rows="3"></textarea>
                    <div class="mb-3 bg-gray-100 p-2 rounded"><button onclick="startGPS('o${currentId}')" id="btn_start_gps_o${currentId}" class="bg-blue-600 text-white p-2 w-full">GPS</button><div id="gps_display_o${currentId}" class="hidden"></div></div>
                    <button onclick="saveObservacionData(${currentId})" id="btn_save_obs_${currentId}" class="bg-blue-100 text-blue-800 p-3 rounded w-full font-bold">Guardar</button>
                </div>`;
            document.getElementById('container_obs_finales').appendChild(d);
        }

        function addAcompanante() { /* Simplificado para brevedad */ }

        // --- FUNCIONES LOGICAS ---
        
        function removeElement(id) { document.getElementById(id).remove(); }
        function calculateVolume(id) {
            const dap = parseFloat(document.getElementById(`val_medida_${id}`).value) || 0;
            const lct = parseFloat(document.getElementById(`val_lct_${id}`).value) || 0;
            const vol = 0.00008379 * Math.pow(dap, 2.04) * Math.pow(lct, 0.78);
            const span = document.getElementById(`res_volumen_${id}`);
            span.innerText = vol.toFixed(4);
            span.dataset.vol = vol;
        }

        function saveVerticeData(id) { markSaved('vertice_block_'+id, 'status_v'+id); }
        function saveArbolData(id) { markSaved('arbol_'+id, 'status_t'+id); }
        function saveFuenteData(id) { markSaved('fuente_block_'+id, 'status_w'+id); }
        function saveObservacionData(id) { markSaved('obs_final_'+id, 'status_o'+id); }

        function markSaved(blockId, statusId) {
            if(!inspeccionIniciada) { alert('Debe INICIAR la inspección primero.'); return; }
            document.getElementById(blockId).dataset.saved = "true";
            document.getElementById(statusId).className = "block-status saved";
            document.getElementById(statusId).innerText = "Guardado";
            collapseBlockFromBottom(blockId);
            backupManager.saveBackup(); // Trigger backup
            updateMapLayers();
        }

        function iniciarInspeccion() {
            inspeccionIniciada = true;
            const now = new Date();
            document.getElementById('start_time').value = now.toLocaleString('es-CR');
            // Guardar ISO para backup
            document.getElementById('start_time').dataset.iso = now.toISOString(); 
            
            document.getElementById('btn_iniciar').classList.add('hidden');
            document.getElementById('inicio_status').classList.remove('hidden');
            document.getElementById('tracking_status').classList.remove('hidden');
            
            initializeMap();
            backupManager.saveBackup();
        }

        // --- 2. GPS FUNCTIONS ---
        function startGPS(id) {
            navigator.geolocation.getCurrentPosition(pos => {
                const div = document.getElementById(`gps_display_${id}`);
                div.innerHTML = `Lat: ${pos.coords.latitude.toFixed(6)}<br>Lon: ${pos.coords.longitude.toFixed(6)}<br>Acc: ${pos.coords.accuracy.toFixed(1)}m`;
                div.dataset.lat = pos.coords.latitude;
                div.dataset.lon = pos.coords.longitude;
                div.dataset.acc = pos.coords.accuracy;
                // Simular CRTM05 simple para backup
                div.dataset.norte = (pos.coords.latitude * 110000).toFixed(2);
                div.dataset.este = (Math.abs(pos.coords.longitude) * 100000).toFixed(2);
                div.classList.remove('hidden');
            }, err => alert('Error GPS: '+err.message));
        }

        // --- 3. MAP CONFIGURATION (WMS FIXES) ---
        function initializeMap() {
            if(inspeccionMap) return;
            
            inspeccionMap = L.map('inspeccion_map').setView([9.9, -84.0], 10);

            // Bases
            const openTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
            const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 22 });
            
            // WMS FIX: HTTPS + maxNativeZoom + Transparent
            const snitZona1 = L.tileLayer.wms('https://siri.snitcr.go.cr/Geoservicios/wms', {
                layers: 'RI_CA_AC_ZONA1_1K_5K',
                format: 'image/png',
                transparent: true,
                version: '1.1.1',
                maxNativeZoom: 17, // CRITICAL FIX: Estira tiles al hacer zoom profundo
                maxZoom: 22
            });

            const ignCauces = L.tileLayer.wms('https://geos.snitcr.go.cr/be/IGN_25/wms', {
                layers: 'caucedrenaje_25k',
                format: 'image/png',
                transparent: true,
                maxNativeZoom: 16,
                maxZoom: 22
            });

            googleSat.addTo(inspeccionMap); // Default

            L.control.layers({
                "Google Satélite": googleSat,
                "OpenTopo": openTopo
            }, {
                "Catastro (SNIT)": snitZona1,
                "Cauces (IGN)": ignCauces
            }).addTo(inspeccionMap);

            // Layers Groups
            mapLayers.trees.group = L.markerClusterGroup();
            mapLayers.vertices.group = L.markerClusterGroup();
            inspeccionMap.addLayer(mapLayers.trees.group);
            inspeccionMap.addLayer(mapLayers.vertices.group);
        }

        function updateMapLayers() {
            if(!inspeccionMap) return;
            mapLayers.trees.group.clearLayers();
            
            // Re-plot trees
            document.querySelectorAll('[id^="arbol_"][data-saved="true"]').forEach(el => {
                const id = el.id.split('_')[1];
                const gps = document.getElementById(`gps_display_t${id}`);
                if(gps && gps.dataset.lat) {
                    L.marker([gps.dataset.lat, gps.dataset.lon])
                     .bindPopup(`Arbol #${document.getElementById('num_arbol_'+id).value}`)
                     .addTo(mapLayers.trees.group);
                }
            });
        }

        function centerMapOnData() {
            // Simple center on user or CR
            if(inspeccionMap) inspeccionMap.locate({setView: true, maxZoom: 16});
        }

        function toggleMapLayer(layer) {
            // Logic to toggle layers...
        }

        // --- 4. BACKUP MANAGER CLASS (CORREGIDA) ---
        
        class BackupManager {
            constructor() {
                this.dbName = 'pp01_backups';
                this.init();
            }

            async init() {
                this.db = await idb.openDB(this.dbName, 1, {
                    upgrade(db) {
                        db.createObjectStore('backups', { keyPath: 'id' });
                    }
                });
                this.checkPending();
            }

            async saveBackup() {
                if(!inspeccionIniciada) return;
                
                const data = this.collectBackupData();
                await this.db.put('backups', data);
                
                document.getElementById('last_save_time').innerText = "Hace 0s";
                document.getElementById('backup_status_indicator').className = "w-3 h-3 rounded-full bg-green-500";
            }

            collectBackupData() {
                // FIX: Guardar fecha ISO real
                const fechaInput = document.getElementById('start_time');
                const fechaISO = fechaInput.dataset.iso || new Date().toISOString();

                return {
                    id: 'current_session',
                    fecha_inicio_iso: fechaISO, // CRITICAL
                    fecha_inicio_display: fechaInput.value,
                    expediente: document.getElementById('expediente_id').value,
                    profesional: document.getElementById('input_profesional').value,
                    
                    arboles: this.collectCollection('arbol_', 't'),
                    vertices: this.collectCollection('vertice_block_', 'v'),
                    fuentes: this.collectCollection('fuente_block_', 'w'),
                    observaciones: this.collectCollection('obs_final_', 'o'),
                    
                    last_save: new Date().toISOString()
                };
            }

            collectCollection(prefix, gpsPrefix) {
                const items = [];
                document.querySelectorAll(`[id^="${prefix}"]`).forEach(el => {
                    const id = el.id.replace(prefix, ''); // Get numeric ID
                    const saved = el.dataset.saved === 'true';
                    
                    // Specific fields based on type
                    let data = { id: parseInt(id), saved: saved };
                    
                    if(gpsPrefix === 't') { // Arbol
                         data.numero = document.getElementById(`num_arbol_${id}`).value;
                         data.especie = document.getElementById(`sp_arbol_${id}`).value;
                         data.medida = document.getElementById(`val_medida_${id}`).value;
                    }
                    if(gpsPrefix === 'v') { // Vertice
                        data.numero = document.getElementById(`num_vertice_${id}`).value;
                        data.observacion = document.getElementById(`obs_vertice_${id}`).value;
                    }

                    // GPS Data
                    const gps = document.getElementById(`gps_display_${gpsPrefix}${id}`);
                    if(gps) {
                        data.gps = {
                            lat: gps.dataset.lat,
                            lon: gps.dataset.lon,
                            norte: gps.dataset.norte,
                            este: gps.dataset.este
                        };
                    }
                    
                    if(saved) items.push(data);
                });
                return items;
            }

            async checkPending() {
                const data = await this.db.get('backups', 'current_session');
                if(data) {
                    if(confirm(`Se encontró una inspección pendiente del ${new Date(data.last_save).toLocaleString()}. ¿Recuperar?`)) {
                        this.importToContinue(data);
                    }
                }
            }

            importToContinue(data) {
                // 1. Limpiar
                document.getElementById('container_arboles').innerHTML = '';
                document.getElementById('container_vertices').innerHTML = '';
                
                // 2. Restaurar Estado
                inspeccionIniciada = true;
                const isoDate = data.fecha_inicio_iso ? new Date(data.fecha_inicio_iso) : new Date();
                document.getElementById('start_time').value = isoDate.toLocaleString('es-CR');
                document.getElementById('start_time').dataset.iso = data.fecha_inicio_iso;
                
                document.getElementById('btn_iniciar').classList.add('hidden');
                document.getElementById('inicio_status').classList.remove('hidden');

                // 3. Restaurar Árboles (CRITICAL: Crear DOM primero con ID explícito)
                if(data.arboles) {
                    data.arboles.forEach(a => {
                        addArbol(a.id); // Crea el HTML con el ID correcto
                        
                        // Llenar datos
                        document.getElementById(`num_arbol_${a.id}`).value = a.numero;
                        document.getElementById(`sp_arbol_${a.id}`).value = a.especie;
                        document.getElementById(`val_medida_${a.id}`).value = a.medida;
                        
                        // Restaurar GPS
                        if(a.gps && a.gps.lat) {
                            const gpsDiv = document.getElementById(`gps_display_t${a.id}`);
                            gpsDiv.dataset.lat = a.gps.lat;
                            gpsDiv.dataset.lon = a.gps.lon;
                            gpsDiv.innerHTML = "Datos recuperados";
                            gpsDiv.classList.remove('hidden');
                        }

                        if(a.saved) saveArbolData(a.id);
                    });
                }

                // 4. Restaurar Vértices
                if(data.vertices) {
                    data.vertices.forEach(v => {
                        addVertice(v.id);
                        document.getElementById(`num_vertice_${v.id}`).value = v.numero;
                        document.getElementById(`obs_vertice_${v.id}`).value = v.observacion;
                        if(v.saved) saveVerticeData(v.id);
                    });
                }

                initializeMap();
                updateMapLayers();
                alert('Recuperación exitosa');
            }
        }

        // Start App
        let backupManager;
        window.addEventListener('load', () => {
            backupManager = new BackupManager();
            // Default first blocks
            addVertice(); addArbol(); addFuente(); addObservacion();
        });

        // Mock functions for missing parts (photo selection etc)
        function photoSelected(input, btnId) { 
            document.getElementById(btnId).style.border = "3px solid green";
            document.getElementById(btnId).innerHTML = "<i class='fas fa-check'></i> Listo";
        }
        function triggerCamera(id) { document.getElementById(id).click(); }
        function loadExpedientesFromSheet() { /* Mock */ }
        function loadExpedienteData() { /* Mock */ }
        function finalizarInspeccion() { alert('Función de exportar ZIP (igual que original)'); }

    </script>
</body>
</html>