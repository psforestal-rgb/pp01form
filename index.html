<!DOCTYPE html>
<!--
================================================================================
PROYECTO: PP-01 ACOPAC - Formulario de Inspección Forestal de Campo
================================================================================
VERSIÓN: 2026-01-21
AUTOR: Pablo César Sánchez Núñez (SINAC-ACOPAC, Costa Rica)
ASISTIDO POR: Claude AI (Anthropic)

================================================================================
DESCRIPCIÓN GENERAL
================================================================================
Formulario HTML single-page para inspecciones forestales de campo, optimizado
para uso móvil en condiciones de trabajo outdoor (alto contraste, botones grandes).
Integra captura GPS, inventario de árboles, cálculo de volumen, y generación de
reportes ZIP con CSV y GPX.

================================================================================
CARACTERÍSTICAS PRINCIPALES
================================================================================
1. DATOS DEL EXPEDIENTE
   - Integración con Google Sheets vía Apps Script API
   - URL API: https://script.google.com/macros/s/AKfycbyAy42TFA31tCs389AUEjHRnix2RQVRIJv25yobzB6Tnysbjerb2Ho3iwGl841JCsmK/exec
   - Columnas: A=EXPEDIENTE, B=FECHA_RECEPCION, G=SOLICITANTE, H=CEDULA, I=TELEFONO, K=FINCA, L=PLANO, M=AREA

2. SISTEMA DE COORDENADAS
   - Proyección oficial: CR-SIRGAS / CRTM05 (EPSG:8908)
   - Modos de captura: GPS automático, entrada manual
   - Conversión interna a WGS84 para compatibilidad GPX

3. INVENTARIO FORESTAL (Árboles)
   - Número de árbol editable (consecutivo automático)
   - Uso del suelo: Agropecuario, Urbano, Regeneración natural, Ecosistema boscoso,
     Sistema agroforestal, Plantación forestal, Otro (con campo de texto)
   - Inclinación del terreno: %, Grados, Cálculo (dist/alt), Clinómetro (sensores del teléfono)
   - Medición: DAP o CAP (circunferencia), resultado siempre en DAP
   - Fórmula volumen: V = 0.00008379 × DAP^2.04 × LCT^0.78
   - Base de datos de 200+ especies costarricenses
   - Alertas de especies en veda (Decreto 25700-MINAE, 19 especies)
   - Estados de conservación (Estrada et al. 2005, Jiménez 1999)

4. VÉRTICES DE UBICACIÓN
   - Número editable (consecutivo automático)
   - Captura GPS o entrada manual CRTM05
   - Foto opcional

5. FUENTES DE AGUA
   - Tipos: Naciente, Cauce, Lago/Laguna, Otro
   - Ubicación GPS/manual

6. OBSERVACIONES GENERALES
   - Texto libre con ubicación GPS
   - Múltiples fotos por observación

7. SISTEMA DE INSPECCIONES
   - Inicio de inspección con timestamp
   - Recuadro gris antes de iniciar, azul después
   - Tracking GPS automático cada 5 segundos
   - Generación de ZIP: PP01_{EXPEDIENTE}_{FECHA}_{HORA}.zip
   - Contenido ZIP: arboles.csv, puntos_gps.gpx, track_recorrido.gpx, resumen.txt

8. INTERFAZ DE USUARIO
   - Alto contraste para uso exterior (sol directo)
   - Tipografía: 17-18px base, pesos 700-800, texto negro puro
   - Headers de sección: gradiente oscuro, texto blanco, sticky
   - Indicador visual de secciones vacías (gris) vs con registros guardados (verde)
   - Botón "Cerrar" al final de cada sección y bloque colapsable
   - Bloques colapsables con estado Pendiente/Guardado

================================================================================
MÓDULOS EXTERNOS PENDIENTES
================================================================================
- CLINÓMETRO: Herramienta integrada para medir inclinación con sensores del teléfono
  * Usa DeviceOrientationEvent para medir pendiente
  * Sistema de calibración en superficie plana (persiste en localStorage)
  * Diagnóstico de sensores integrado
  * Llama a: setSlopeFromClinometer(arbolId, pendientePorcentaje)
  * Ver función openClinometer() para integración

================================================================================
NOTAS IMPORTANTES PARA CONTINUIDAD DEL DESARROLLO
================================================================================
⚠️ NO MODIFICAR sin entender completamente:
- La estructura de funciones add* (addArbol, addVertice, addFuente, addObservacion)
  genera HTML dinámico con IDs basados en contadores
- Los selectores de modo (GPS/Manual, DAP/CAP, inclinación) usan toggle functions
- El sistema de estado de secciones (updateSectionStatus) detecta .block-status.saved
- Los max-height de .block-content controlan la animación de colapso

⚠️ NO SIMPLIFICAR:
- El CSS de alto contraste es intencional para uso en campo
- Los botones grandes son para uso con guantes o pantallas sucias
- La redundancia en algunos estilos es para compatibilidad móvil

⚠️ MANTENER COMPATIBILIDAD:
- Google Sheets API tiene columnas específicas mapeadas
- Formato de exportación CSV/GPX es consumido por otros sistemas
- Especies en veda siguen legislación costarricense vigente

================================================================================
HISTORIAL DE CAMBIOS (Resumen)
================================================================================
- Formulario base con GPS simulado y cálculo de volumen
- Integración Google Sheets para expedientes
- Sistema de inspecciones con ZIP export
- Workflow por inspección con track GPS
- Bloques colapsables con estados
- Alta contraste UI para campo
- Entrada manual de coordenadas CRTM05
- Números editables para vértices y árboles
- Actualización a EPSG:8908
- Recuadro de inicio gris/azul según estado
- Campo de inclinación del terreno (4 métodos)
- Selector DAP/CAP mejorado con resultado siempre en DAP
- Nuevos usos del suelo (agroforestal, plantación, otro)
- Botones de colapsar al final de secciones
- Indicadores visuales de secciones vacías/con contenido

================================================================================
-->

<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista Previa - Formulario PP-01 ACOPAC (GPS Pro)</title>
    <!-- Tailwind CSS - Static build (NO JIT compiler, NO MutationObserver) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <style>
        /* JIT-only classes replaced with static CSS */
        .text-\[10px\] { font-size: 10px; }
        .bg-black\/30 { background-color: rgba(0,0,0,0.3); }
        .border-white\/50 { border-color: rgba(255,255,255,0.5); }
        .h-\[400px\] { height: 400px; }
        .h-\[500px\] { height: 500px; }
        .z-\[2000\] { z-index: 2000; }
        .z-\[3000\] { z-index: 3000; }
        /* Tailwind v3 classes not in v2 static build */
        .from-green-50 { --tw-gradient-from: #ecfdf5; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(236, 253, 245, 0)); }
        .to-emerald-50 { --tw-gradient-to: #ecfdf5; }
        .from-cyan-400 { --tw-gradient-from: #22d3ee; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(34, 211, 238, 0)); }
        .to-blue-500 { --tw-gradient-to: #3b82f6; }
        .from-gray-50 { --tw-gradient-from: #f9fafb; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(249, 250, 251, 0)); }
        .to-gray-100 { --tw-gradient-to: #f3f4f6; }
        .from-blue-50 { --tw-gradient-from: #eff6ff; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(239, 246, 255, 0)); }
        .to-blue-100 { --tw-gradient-to: #dbeafe; }
        .from-teal-400 { --tw-gradient-from: #2dd4bf; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(45, 212, 191, 0)); }
        .to-cyan-300 { --tw-gradient-to: #67e8f9; }
        .active\:scale-95:active { transform: scale(0.95); }
        .active\:bg-green-700:active { background-color: #047857; }
        .active\:bg-green-800:active { background-color: #065f46; }
        .gap-14 { gap: 3.5rem; }
        .border-3 { border-width: 3px; }
        .border-4 { border-width: 4px; }
        .border-b-4 { border-bottom-width: 4px; }
        .border-l-4 { border-left-width: 4px; }
        .border-r-4 { border-right-width: 4px; }
        .border-t-4 { border-top-width: 4px; }
        .shadow-inner { box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); }
        .bg-amber-50 { background-color: #fffbeb; }
        .bg-amber-500 { background-color: #f59e0b; }
        .hover\:bg-amber-600:hover { background-color: #d97706; }
        .border-amber-200 { border-color: #fde68a; }
        .border-amber-300 { border-color: #fcd34d; }
        .border-amber-500 { border-color: #f59e0b; }
        .text-amber-600 { color: #d97706; }
        .text-amber-700 { color: #b45309; }
        .bg-emerald-50 { background-color: #ecfdf5; }
        .border-emerald-200 { border-color: #a7f3d0; }
        .text-emerald-700 { color: #047857; }
        .bg-purple-50 { background-color: #faf5ff; }
        .bg-purple-600 { background-color: #9333ea; }
        .hover\:bg-purple-700:hover { background-color: #7e22ce; }
        .border-purple-100 { border-color: #f3e8ff; }
        .border-purple-200 { border-color: #e9d5ff; }
        .text-purple-500 { color: #a855f7; }
        .text-purple-700 { color: #7e22ce; }
        .bg-orange-400 { background-color: #fb923c; }
        .text-orange-400 { color: #fb923c; }
        .bg-cyan-400 { background-color: #22d3ee; }
        .text-cyan-400 { color: #22d3ee; }
        .bg-teal-400 { background-color: #2dd4bf; }
        .text-teal-400 { color: #2dd4bf; }
        .space-y-2 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.5rem; }
        .space-y-3 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.75rem; }
    </style>
    <!-- Leaflet (Mapa interactivo) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
<style>
        /* === MODO ALTO CONTRASTE PARA SOL === */
        :root {
            --text-primary: #000000;
            --text-secondary: #1f2937;
            --text-muted: #374151;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --accent-green: #166534;
            --accent-green-light: #dcfce7;
            --border-color: #9ca3af;
            --shadow-strong: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        body { 
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: #d1d5db; 
            margin: 0; 
            padding-top: 60px; 
            font-size: 17px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        
        .view-controls { position: fixed; top: 0; left: 0; right: 0; height: 48px; background: #1f2937; display: flex; align-items: center; justify-content: center; gap: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 1000; }
        .view-btn { background: transparent; border: 2px solid #9ca3af; color: #f3f4f6; padding: 6px 14px; border-radius: 16px; cursor: pointer; font-size: 0.92em; font-weight: 600; min-height: 38px; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .view-btn:hover { background: rgba(255,255,255,0.15); border-color: white; }
        .view-btn.active { background: #166534; border-color: #166534; font-weight: bold; }
        
        .kobo-container { background: white; border-top: 6px solid #166534; margin: 20px auto; transition: all 0.3s ease; position: relative; }
        .mobile-mode { max-width: 420px; border-radius: 20px; border: 8px solid #1f2937; border-top-width: 25px; border-bottom-width: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); overflow: hidden; min-height: 90vh; overflow-y: auto; }
        .mobile-mode::-webkit-scrollbar { width: 0px; background: transparent; }
        .desktop-mode { max-width: 850px; box-shadow: var(--shadow-strong); border-radius: 8px; min-height: 100vh; }
        
        /* === ENCABEZADOS DE SECCIÓN - ALTO CONTRASTE === */
        .group-header { 
            background: linear-gradient(to bottom, #1f2937, #111827); 
            padding: 20px 22px; 
            border-bottom: 3px solid #166534; 
            font-weight: 800; 
            color: #ffffff; 
            font-size: 1.15em; 
            letter-spacing: 0.3px;
            position: sticky; 
            top: 0; 
            z-index: 10; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: background 0.2s; 
            min-height: 32px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .group-header:hover { background: linear-gradient(to bottom, #374151, #1f2937); }
        .group-header:active { background: #166534; }
        .group-header.empty-section { background: linear-gradient(to bottom, #6b7280, #4b5563); border-bottom-color: #9ca3af; }
        .group-header.empty-section .chevron-icon { color: #9ca3af; }
        .group-header.has-records { background: linear-gradient(to bottom, #166534, #14532d); border-bottom-color: #22c55e; }
        .group-header.has-records::after { content: ''; position: absolute; right: 50px; top: 50%; transform: translateY(-50%); width: 10px; height: 10px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 6px #22c55e; }
        .btn-collapse-bottom { background: linear-gradient(to bottom, #374151, #1f2937); color: #d1d5db; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-top: 10px; }
        .btn-collapse-bottom:hover { background: linear-gradient(to bottom, #4b5563, #374151); color: white; }
        .btn-collapse-bottom:active { transform: scale(0.98); }
        .section-content { transition: all 0.3s ease-in-out; }
        .section-content.hidden-section { display: none; }
        .chevron-icon { transition: transform 0.3s ease; font-size: 1.3em; color: #22c55e; }
        .group-header.active .chevron-icon { transform: rotate(180deg); }
        
        /* === CAMPOS DE FORMULARIO - LEGIBILIDAD MÁXIMA === */
        .question { padding: 18px 22px; border-bottom: 2px solid #e5e7eb; background: #ffffff; }
        .question label { 
            display: block; 
            margin-bottom: 12px; 
            font-weight: 700; 
            color: #000000; 
            font-size: 1.05em;
            letter-spacing: 0.2px;
        }
        .question .hint { font-size: 0.9em; color: #4b5563; margin-top: -6px; margin-bottom: 14px; font-style: italic; font-weight: 500; }
        
        .input-field { 
            width: 100%; 
            padding: 16px 14px; 
            border: 3px solid #6b7280; 
            border-radius: 10px; 
            font-size: 18px; 
            font-weight: 500;
            color: #000000;
            background: #ffffff;
            box-sizing: border-box; 
            -webkit-appearance: none; 
        }
        .input-field::placeholder { color: #6b7280; font-weight: 400; }
        .input-field:focus { border-color: #166534; outline: none; box-shadow: 0 0 0 4px rgba(22, 101, 52, 0.3); }
        .input-field:disabled, button:disabled { background-color: #f3f4f6; color: #374151; border-color: #9ca3af; cursor: not-allowed; }
        .read-only { background-color: #f0fdf4; cursor: not-allowed; color: #166534; font-weight: 600; border-color: #86efac; }
        
        .note { background-color: #dcfce7; border-left: 5px solid #166534; padding: 14px 16px; margin-top: 14px; font-size: 1em; font-weight: 500; border-radius: 0 10px 10px 0; color: #166534; }
        
        /* === BOTONES TÁCTILES GRANDES === */
        .btn-add { 
            background: linear-gradient(to bottom, #f8fafc, #e5e7eb); 
            color: #1f2937; 
            border: 3px solid #6b7280; 
            padding: 18px 20px; 
            border-radius: 12px; 
            cursor: pointer; 
            margin: 14px 22px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            width: calc(100% - 44px); 
            font-size: 1.1em; 
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-add:hover { background: linear-gradient(to bottom, #ffffff, #f3f4f6); border-color: #374151; }
        .btn-add:active { background: #e5e7eb; transform: scale(0.98); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        
        /* === BOTONES DE CÁMARA === */
        .btn-camera { background-color: #dbeafe; border: 4px dashed #2563eb; color: #1e40af; width: 100%; padding: 28px; text-align: center; border-radius: 14px; cursor: pointer; margin-top: 10px; transition: all 0.3s; background-size: cover; background-position: center; position: relative; overflow: hidden; font-size: 1.1em; font-weight: 600; z-index: 1; }
        .btn-camera:hover { background-color: #bfdbfe; border-color: #1d4ed8; }
        .btn-camera:active { transform: scale(0.98); }
        .btn-camera.has-image { border-style: solid; border-color: #166534; }
        .btn-camera.has-image .camera-content { background: rgba(0,0,0,0.7); color: white; padding: 10px 14px; border-radius: 8px; display: inline-block; font-weight: 600; }
        
        .hidden { display: none; }
        .hidden-field { display: none; }
        
        /* === BLOQUES REPETIBLES CON MEJOR CONTRASTE === */
        .repeat-block { 
            border-left: 5px solid #166534; 
            margin: 12px 14px 20px 14px; 
            background: #f8fafc; 
            border-radius: 0 12px 12px 0; 
            overflow: visible; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        .remove-btn { color: #dc2626; font-size: 1em; cursor: pointer; margin-top: 5px; display: inline-block; font-weight: 600; }
        
        /* === MAPA PREVIEW === */
        .map-preview { height: 170px; background-color: #d1d5db; border-radius: 12px; display: flex; align-items: center; justify-content: center; background-image: url('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/10/285/550'); background-size: cover; background-position: center; position: relative; overflow: hidden; margin-top: 12px; border: 3px solid #6b7280; }
        .map-pin { color: #dc2626; font-size: 2.2rem; text-shadow: 0 2px 6px rgba(0,0,0,0.6); z-index: 10; }
        .map-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; color: white; flex-direction: column; text-align: center; padding: 12px; font-weight: 600; }
        
        @keyframes pulse-ring { 0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 12px rgba(22, 163, 74, 0); } 100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); } }
        .gps-active-dot { width: 14px; height: 14px; background: #22c55e; border-radius: 50%; animation: pulse-ring 1.5s infinite; }
        
        /* Grids en móvil */
        .mobile-mode .grid-cols-2 { grid-template-columns: 1fr; }
        
        .alert-box { background-color: #fef2f2; border-left: 5px solid #dc2626; color: #991b1b; padding: 14px 16px; margin-top: 14px; font-weight: 700; font-size: 1em; border-radius: 0 10px 10px 0; }
        
        /* === DASHBOARD CARD === */
        .dashboard-card { background: linear-gradient(to bottom, #f0fdf4, #dcfce7); border: 3px solid #86efac; padding: 20px; border-radius: 14px; margin: 22px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .dash-label { font-size: 0.9em; color: #166534; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; }
        .dash-value { font-size: 2em; font-weight: 900; color: #14532d; }
        
        /* === INSPECCIONES FINALIZADAS === */
        .inspecciones-list { margin: 22px; }
        .inspeccion-item { background: linear-gradient(to right, #f0fdf4, #dcfce7); border: 3px solid #86efac; border-left: 6px solid #166534; padding: 16px 18px; border-radius: 12px; margin-bottom: 14px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .inspeccion-item:hover { background: linear-gradient(to right, #dcfce7, #bbf7d0); transform: translateX(5px); }
        .inspeccion-item:active { transform: scale(0.98); }
        .inspeccion-item .exp-num { font-weight: 800; color: #14532d; font-size: 1.2em; }
        .inspeccion-item .exp-info { font-size: 0.9em; color: #374151; margin-top: 8px; font-weight: 500; }
        .inspeccion-item .exp-stats { display: flex; flex-wrap: wrap; gap: 14px; margin-top: 12px; font-size: 0.9em; color: #166534; font-weight: 600; }
        
        /* === MODAL MEJORADO === */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 15px; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; border-radius: 14px; max-width: 650px; width: 100%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
        .modal-header { background: linear-gradient(to right, #14532d, #166534); color: white; padding: 18px 22px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; border-radius: 14px 14px 0 0; }
        .modal-body { padding: 22px; }
        .modal-close { background: none; border: none; color: white; font-size: 2em; cursor: pointer; padding: 5px 12px; }
        .detail-section { margin-bottom: 22px; border-bottom: 2px solid #e5e7eb; padding-bottom: 18px; }
        .detail-section h4 { font-weight: 800; color: #1f2937; margin-bottom: 14px; font-size: 1.1em; }
        .detail-row { display: flex; justify-content: space-between; padding: 10px 0; font-size: 1em; border-bottom: 2px dotted #e5e7eb; }
        .detail-label { color: #4b5563; font-weight: 600; }
        .detail-value { color: #000000; font-weight: 700; text-align: right; max-width: 60%; }
        .detail-table { width: 100%; font-size: 0.95em; border-collapse: collapse; margin-top: 12px; }
        .detail-table th, .detail-table td { border: 2px solid #d1d5db; padding: 12px 10px; text-align: left; }
        .detail-table th { background: #1f2937; color: white; font-weight: 700; }
        .detail-table td { font-weight: 500; }
        
        /* === AUTOCOMPLETADO DE ESPECIES === */
        .species-autocomplete { position: relative; }
        .species-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 3px solid #6b7280; border-top: none; border-radius: 0 0 10px 10px; max-height: 250px; overflow-y: auto; z-index: 100; box-shadow: 0 6px 16px rgba(0,0,0,0.2); display: none; }
        .species-suggestions.active { display: block; }
        .species-suggestion { padding: 16px 14px; cursor: pointer; border-bottom: 2px solid #e5e7eb; font-size: 17px; font-weight: 500; }
        .species-suggestion:hover, .species-suggestion.selected { background-color: #dcfce7; }
        .species-suggestion:active { background-color: #bbf7d0; }
        .species-suggestion .sci-name { font-style: italic; color: #166534; font-weight: 700; }
        .species-suggestion .common-name { color: #374151; font-size: 15px; margin-top: 4px; font-weight: 500; }
        .species-suggestion .match { background-color: #fde047; font-weight: 800; padding: 0 2px; }
        
        /* === BOTONES DE ACCIÓN PRINCIPALES === */
        .btn-action-primary { 
            background: linear-gradient(to bottom, #2563eb, #1d4ed8); 
            color: white; 
            font-weight: 800; 
            padding: 18px 22px; 
            border-radius: 12px; 
            border: none; 
            font-size: 1.15em; 
            width: 100%; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 12px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn-action-primary:hover { background: linear-gradient(to bottom, #1d4ed8, #1e40af); }
        .btn-action-primary:active { transform: scale(0.98); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        .btn-action-primary:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; }
        
        /* === BOTONES GPS GRANDES === */
        .btn-gps { padding: 16px 14px; border-radius: 12px; font-weight: 700; font-size: 1em; display: flex; align-items: center; justify-content: center; gap: 8px; border: none; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
        .btn-gps:active { transform: scale(0.96); }
        
        /* === BOTONES DE GUARDAR/EDITAR/BORRAR === */
        .btn-icon { padding: 14px 16px; border-radius: 10px; font-size: 1.2em; }
        
        /* Espaciado mejorado para campos en grid */
        .grid { gap: 14px; }
        
        /* Header del formulario sticky mejorado */
        .form-header { position: sticky; top: 0; z-index: 20; background: white; }
        
        /* === BLOQUES COLAPSABLES - ALTO CONTRASTE === */
        .block-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 14px 16px; 
            background: linear-gradient(to right, #1f2937, #374151); 
            border-bottom: 3px solid #22c55e; 
            cursor: pointer; 
            border-radius: 10px 10px 0 0;
        }
        .block-header:active { background: linear-gradient(to right, #166534, #22c55e); }
        .block-header-left { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .block-header-right { display: flex; align-items: center; gap: 10px; }
        .block-number { font-weight: 800; font-size: 1.15em; color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .block-summary { font-size: 0.9em; color: #d1d5db; max-width: 160px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        .block-toggle { background: #22c55e; border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.3s, background 0.2s; color: white; }
        .block-toggle:hover { background: #16a34a; }
        .block-toggle.collapsed { transform: rotate(-90deg); }
        .block-content { transition: max-height 0.3s ease-out, opacity 0.2s ease-out, padding 0.3s ease-out; overflow: visible; padding: 16px; background: #ffffff; }
        .block-content.collapsed { max-height: 0 !important; opacity: 0; padding-top: 0 !important; padding-bottom: 0 !important; overflow: hidden; }
        .block-status { font-size: 0.8em; padding: 5px 10px; border-radius: 14px; font-weight: 700; }
        .block-status.saved { background: #22c55e; color: #ffffff; }
        .block-status.pending { background: #f59e0b; color: #ffffff; }
        
        /* === INFO DE CONSERVACIÓN - ALTO CONTRASTE === */
        .conservation-info { margin-top: 10px; padding: 14px 16px; border-radius: 10px; font-size: 0.95em; font-weight: 600; }
        .conservation-info.cr { background: #fef2f2; border-left: 5px solid #dc2626; color: #991b1b; }
        .conservation-info.en { background: #fff7ed; border-left: 5px solid #ea580c; color: #9a3412; }
        .conservation-info.vu { background: #fefce8; border-left: 5px solid #ca8a04; color: #854d0e; }
        .conservation-info.nt { background: #f0fdf4; border-left: 5px solid #16a34a; color: #166534; }
        .conservation-info.lc { background: #f0f9ff; border-left: 5px solid #0284c7; color: #075985; }
        .conservation-info .status-label { font-weight: 800; font-size: 1em; }
        .conservation-info .cites-badge { display: inline-block; background: #7c3aed; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85em; margin-left: 10px; font-weight: 700; }
        .conservation-info .source { font-size: 0.85em; color: #4b5563; margin-top: 6px; font-weight: 500; }
        
        /* === SELECTS MEJORADOS === */
        select.input-field {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23374151' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 44px;
        }
        
        /* === TEXTAREAS MEJORADOS === */
        textarea.input-field {
            min-height: 100px;
            resize: vertical;
            line-height: 1.6;
        }
        
        /* === COORDENADAS GPS DISPLAY === */
        .gps-display {
            background: linear-gradient(to right, #1f2937, #374151);
            color: #22c55e;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 1em;
            font-weight: 700;
            padding: 14px 16px;
            border-radius: 10px;
            text-align: center;
            letter-spacing: 0.5px;
            border: 3px solid #22c55e;
        }
        
        /* === INDICADORES DE ESTADO === */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9em;
        }
        .status-indicator.active { background: #22c55e; color: white; }
        .status-indicator.pending { background: #f59e0b; color: white; }
        .status-indicator.error { background: #dc2626; color: white; }
    
        /* === MAPA INSPECCIÓN (Leaflet) === */
        .map-layer-btn {
            padding: 10px 14px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
            border: 2px solid #6b7280;
            background: linear-gradient(to bottom, #f8fafc, #e5e7eb);
            color: #1f2937;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            white-space: nowrap;
            transition: all 0.2s;
            min-width: 44px;
            min-height: 44px;
            justify-content: center;
            touch-action: manipulation;
        }

        .map-layer-btn.active {
            background: linear-gradient(to bottom, #166534, #14532d);
            color: white;
            border-color: #166534;
        }

        .map-layer-btn:hover {
            background: linear-gradient(to bottom, #ffffff, #f3f4f6);
        }

        .map-layer-btn.active:hover {
            background: linear-gradient(to bottom, #14532d, #166534);
        }

        .leaflet-container {
            font-family: 'Roboto', -apple-system, sans-serif !important;
            font-size: 14px !important;
        }

        .leaflet-control-zoom a {
            width: 36px !important;
            height: 36px !important;
            line-height: 34px !important;
            font-size: 20px !important;
        }

        /* Botonera: evitar desbordes en móvil */
        @media (max-width: 480px) {
            .map-controls-wrap {
                flex-direction: column;
                align-items: stretch;
            }
            .map-controls-wrap .map-layer-btn {
                width: 100%;
            }
        }

    
        /* === ESTILOS PARA SISTEMA DE BACKUP === */
        .tab-btn {
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            border-bottom-color: #166534;
            color: #166534;
            font-weight: 700;
        }

        .tab-content {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .backup-item {
            transition: all 0.2s;
        }

        .backup-item:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Indicador de estado */
        .status-indicator-backup {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-saving { background-color: #3b82f6; animation: pulse 1.5s infinite; }
        .status-saved { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-pending { background-color: #f59e0b; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }


        /* ============================================================================
           2026-01-30 - MEJORAS UX MOBILE + ACCESIBILIDAD (SIN TOCAR LÓGICA)
           - Full width en "Datos del Expediente"
           - Contraste solar extremo (colores sólidos)
           - Targets táctiles 55-60px
           - Densidad legible (menos padding / menos scroll)
           - Feedback visual más drástico (active / saved)
           ============================================================================ */

        :root{
            --text-primary: #000000;
            --text-secondary: #000000;
            --text-muted: #000000;
            --bg-primary: #FFFFFF;
            --bg-secondary: #FFFFFF;
            --border-color: #000000;
            --shadow-strong: none;
        }

        body{
            background-color:#FFFFFF !important;
            color:#000000 !important;
        }

        /* Elimina degradados/sombras suaves -> sólidos de alto contraste */
        .kobo-container{ background:#FFFFFF !important; box-shadow:none !important; }
        .desktop-mode{ box-shadow:none !important; }
        .mobile-mode{ box-shadow:none !important; border-color:#000000 !important; }

        .group-header{
            background:#111827 !important; /* oscuro sólido */
            color:#FFFFFF !important;
            border-bottom:4px solid #000000 !important;
            text-shadow:none !important;
            padding:14px 16px !important;
        }
        .group-header:hover{ background:#000000 !important; }
        .group-header:active{ background:#000000 !important; }
        .group-header.empty-section{ background:#374151 !important; border-bottom-color:#000000 !important; }
        .group-header.has-records{ background:#14532d !important; border-bottom-color:#000000 !important; }
        .group-header.has-records::after{ display:none !important; }

        .question{
            padding:12px 16px !important;
            border-bottom:2px solid #000000 !important;
            background:#FFFFFF !important;
        }
        .question label{ color:#000000 !important; }
        .question .hint{ color:#000000 !important; font-style:normal !important; opacity:0.85; }

        .dashboard-card{
            background:#FFFFFF !important;
            border:3px solid #000000 !important;
            box-shadow:none !important;
            margin:16px !important;
            padding:14px !important;
            border-radius:12px !important;
        }
        .dash-label{ color:#000000 !important; }
        .dash-value{ color:#000000 !important; }

        /* Full width: expediente (etiqueta arriba, valor abajo resaltado) */
        .exp-fullwidth-fields{ width:100% !important; }
        .exp-field{
            width:100% !important;
            border:3px solid #000000 !important;
            border-radius:12px !important;
            padding:10px 12px !important;
            background:#FFFFFF !important;
        }
        .exp-label{
            display:block !important;
            font-size:12px !important;
            font-weight:800 !important;
            letter-spacing:0.4px !important;
            text-transform:uppercase !important;
            color:#000000 !important;
            margin-bottom:8px !important;
        }
        .exp-value{
            font-weight:900 !important;
            color:#000000 !important;
            background:#FFFFFF !important;
            border:3px solid #000000 !important;
        }
        /* evita que se “aplane” el input dentro del contenedor */
        .exp-field .input-field{ margin:0 !important; }


        /* Bloques colapsables para expediente (PREDIO y SOLICITANTE) */
        .collapse-group {
            border: 3px solid #374151;
            border-radius: 12px;
            background: #f9fafb;
            overflow: hidden;
        }
        
        .collapse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        
        .collapse-header:active {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
        }
        
        .collapse-header span {
            color: #ffffff !important;
            font-size: 15px;
            font-weight: 800;
            letter-spacing: 0.5px;
        }
        
        .collapse-header i.fa-chevron-down {
            color: #ffffff;
            font-size: 16px;
            transition: transform 0.3s ease;
        }
        
        .collapse-content {
            background: #ffffff;
            transition: max-height 0.3s ease;
        }
        
        .collapse-content .exp-field {
            border: 2px solid #d1d5db !important;
            background: #ffffff !important;
        }

        /* Ergonomía táctil: targets 55-60px */
        .input-field,
        select.input-field,
        textarea.input-field{
            min-height:58px !important;
            padding:14px 14px !important;
            border:3px solid #000000 !important;
            border-radius:12px !important;
            box-shadow:none !important;
        }
        textarea.input-field{ min-height:120px !important; }

        button,
        .btn-add,
        .btn-action-primary,
        .btn-gps,
        .btn-collapse-bottom,
        .map-layer-btn{
            min-height:58px !important;
            touch-action:manipulation;
        }

        /* Botones sólidos (sin gradientes) + separación táctil */
        .btn-add{
            background:#FFFFFF !important;
            color:#000000 !important;
            border:3px solid #000000 !important;
            box-shadow:none !important;
            margin:12px 16px !important;
            width:calc(100% - 32px) !important;
            gap:10px !important;
        }

        .btn-collapse-bottom{
            background:#111827 !important;
            color:#FFFFFF !important;
            box-shadow:none !important;
            border:3px solid #000000 !important;
            margin-top:12px !important;
        }

        .btn-action-primary{
            background:#000000 !important;
            color:#FFFFFF !important;
            box-shadow:none !important;
            text-shadow:none !important;
            border:3px solid #000000 !important;
        }
        .btn-action-primary:hover{ background:#111827 !important; }

        /* Icon buttons (guardar/editar/borrar) -> targets grandes */
        .btn-icon,
        #sec_generales button{
            min-height:58px !important;
            min-width:58px !important;
            border:3px solid #000000 !important;
            border-radius:12px !important;
            box-shadow:none !important;
        }

        /* Separación entre botones para guantes/manos sucias */
        .flex.gap-2{ gap:12px !important; }
        .flex.gap-3{ gap:12px !important; }
        .flex.gap-14{ gap:18px !important; } /* cámara */

        /* Feedback visual drástico al presionar */
        button:active,
        .btn-add:active,
        .btn-collapse-bottom:active,
        .btn-action-primary:active,
        #btn_iniciar:active,
        #btn_finish:active,
        .map-layer-btn:active{
            background:#000000 !important;
            color:#FFFFFF !important;
            border-color:#000000 !important;
            transform:scale(0.98) !important;
            outline:4px solid #FFFFFF !important;
            outline-offset:0px !important;
        }

        /* Estados de guardado: cambio de color inmediato y visible */
        .block-status.saved{
            background:#00C853 !important;
            color:#000000 !important;
            border:2px solid #000000 !important;
        }
        .block-status.pending{
            background:#FFD400 !important;
            color:#000000 !important;
            border:2px solid #000000 !important;
        }
        .repeat-block{
            background:#FFFFFF !important;
            border-left:8px solid #000000 !important;
            box-shadow:none !important;
            margin:10px 12px 16px 12px !important;
            border-radius:0 12px 12px 0 !important;
        }
        .repeat-block .block-header{
            background:#111827 !important;
            border-bottom:4px solid #000000 !important;
        }
        .block-toggle{ background:#FFFFFF !important; color:#000000 !important; border:3px solid #000000 !important; }
        .block-toggle:hover{ background:#FFFFFF !important; }

        /* Mapa: botones sólidos y más grandes en móvil */
        .map-layer-btn{
            background:#FFFFFF !important;
            color:#000000 !important;
            border:3px solid #000000 !important;
            box-shadow:none !important;
            border-radius:12px !important;
            padding:12px 14px !important;
        }
        .map-layer-btn.active{
            background:#000000 !important;
            color:#FFFFFF !important;
        }

        /* Sistema de respaldo: alto contraste */
        #backup_status_indicator{ box-shadow:none !important; }
        #backup_status_text, #last_save_time{ color:#000000 !important; }
        .status-saving{ background-color:#000000 !important; }
        .status-saved{ background-color:#00C853 !important; }
        .status-error{ background-color:#FF0000 !important; }
        .status-pending{ background-color:#FFD400 !important; }

        /* Reduce paddings extra en header y pie */
        .form-content > .p-5{ padding:12px 16px !important; }

</style>

    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

</head>
<body>
    <div id="camera_modal" class="fixed inset-0 bg-black z-[2000] hidden flex flex-col">
        <div class="flex-1 relative bg-gray-900 flex items-center justify-center overflow-hidden">
            <div class="absolute inset-0 opacity-70 bg-cover bg-center" style="background-image:url('https://images.unsplash.com/photo-1448375240586-dfd8d395ea6c?auto=format&fit=crop&w=800&q=80')"></div>
            <div class="w-64 h-64 border-2 border-white/50 rounded-lg relative z-10 box-content"><div class="absolute top-0 left-0 w-4 h-4 border-t-4 border-l-4 border-white"></div><div class="absolute top-0 right-0 w-4 h-4 border-t-4 border-r-4 border-white"></div><div class="absolute bottom-0 left-0 w-4 h-4 border-b-4 border-l-4 border-white"></div><div class="absolute bottom-0 right-0 w-4 h-4 border-b-4 border-r-4 border-white"></div></div>
            <div class="absolute top-4 right-4 text-white p-4"><i class="fas fa-bolt"></i></div>
            <div class="absolute top-4 left-4 text-white p-4 font-mono text-xs bg-black/30 rounded">HDR ON</div>
        </div>
        <div class="h-32 bg-black flex items-center justify-center gap-14 pb-4">
            <button onclick="closeCamera()" class="text-white p-4 opacity-70 hover:opacity-100"><i class="fas fa-times fa-2x"></i></button>
            <button onclick="snapPhoto()" class="w-16 h-16 rounded-full bg-white border-4 border-gray-300 shadow-lg active:scale-95 transition-transform"></button>
            <button class="text-white p-4 opacity-70 hover:opacity-100"><i class="fas fa-sync fa-2x"></i></button>
        </div>
    </div>
    <div class="view-controls">
        <button class="view-btn active" id="btn-mobile" onclick="setMobileView()"><i class="fas fa-mobile-alt"></i> Vista Móvil</button>
        <button class="view-btn" id="btn-desktop" onclick="setTabletView()"><i class="fas fa-tablet-alt"></i> Vista Tablet</button>
    </div>
    <div id="main-container" class="kobo-container mobile-mode">
        <div class="p-5 border-b border-gray-200 sticky top-0 bg-white z-20">
            <h1 class="text-xl font-bold text-gray-800 text-center leading-tight">Formulario PP-01<br>ACOPAC</h1>
            <p class="text-gray-500 text-xs mt-2 text-center">Proyección: CR-SIRGAS / CRTM05 (EPSG:8908)</p>
        </div>
        <div class="form-content">
            <!-- Fecha y hora de inicio visible -->
            <div id="inspeccion_header" class="p-4 bg-gradient-to-r from-gray-500 to-gray-600 border-b border-gray-700 transition-all duration-300">
                <div class="flex flex-col gap-3">
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-bold text-white"><i class="fas fa-clock mr-2"></i>Inicio de Inspección</label>
                        <div class="flex items-center gap-3">
                            <span id="tracking_status" class="text-xs bg-green-600 text-white px-2 py-1 rounded hidden"><i class="fas fa-route mr-1"></i>0 pts</span>
                            <span id="inicio_status" class="text-xs text-blue-100 hidden"><i class="fas fa-check-circle mr-1"></i>Iniciada</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="text" id="start_time" class="input-field flex-1 text-center font-mono font-bold text-blue-800 bg-white border-blue-300 py-3 px-3 text-lg" readonly>
                        <button onclick="iniciarInspeccion()" id="btn_iniciar" class="bg-green-500 hover:bg-green-600 active:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center gap-2 text-base whitespace-nowrap">
                            <i class="fas fa-play"></i> Iniciar
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="group-header" onclick="toggleSection('sec_expediente', this)"><span><i class="fas fa-folder-open mr-2"></i>DATOS DEL EXPEDIENTE</span><i class="fas fa-chevron-down chevron-icon"></i></div>
            <div id="sec_expediente" class="section-content hidden-section">
                <div class="question">
                    <label>Número de Expediente <span class="text-red-500">*</span></label>
                    <div class="hint">Datos desde Google Sheets (se actualizan automáticamente)</div>
                    <div class="flex gap-2">
                        <select id="expediente_id" class="input-field flex-1" onchange="loadExpedienteData()">
                            <option value="">Cargando expedientes...</option>
                        </select>
                        <button id="btn_refresh_expedientes" onclick="loadExpedientesFromSheet()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded" title="Refrescar lista">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button id="btn_lock_expediente" onclick="toggleExpedienteLock()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded" title="Fijar expediente (evita cambios accidentales)">
                            <i id="icon_lock_expediente" class="fas fa-lock-open"></i>
                        </button>
                    </div>
                    
                    <div id="data_fields" class="mt-4 transition-all opacity-50">
                        <!-- Fecha de Recepción - Campo individual -->
                        <div class="exp-field mb-3">
                            <label class="exp-label">Fecha de Recepción</label>
                            <input type="text" id="fecha_recepcion" class="input-field read-only" exp-value readonly>
                        </div>

                        <!-- BLOQUE COLAPSABLE: PREDIO -->
                        <div class="collapse-group mb-3">
                            <div class="collapse-header" onclick="toggleExpedienteCollapse('predio_collapse')">
                                <span class="font-bold text-gray-700">
                                    <i class="fas fa-home mr-2"></i>PREDIO
                                </span>
                                <i class="fas fa-chevron-down transition-transform" id="predio_chevron"></i>
                            </div>
                            <div id="predio_collapse" class="collapse-content" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease;">
                                <div class="p-3 space-y-3">
                                    <div class="exp-field">
                                        <label class="exp-label">Finca</label>
                                        <input type="text" id="finca_num" class="input-field read-only" exp-value readonly>
                                    </div>
                                    <div class="exp-field">
                                        <label class="exp-label">Plano</label>
                                        <input type="text" id="plano_num" class="input-field read-only" exp-value readonly>
                                    </div>
                                    <div class="exp-field">
                                        <label class="exp-label">Área (ha)</label>
                                        <input type="text" id="area_ha" class="input-field read-only" exp-value readonly>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- BLOQUE COLAPSABLE: SOLICITANTE -->
                        <div class="collapse-group mb-3">
                            <div class="collapse-header" onclick="toggleExpedienteCollapse('solicitante_collapse')">
                                <span class="font-bold text-gray-700">
                                    <i class="fas fa-user mr-2"></i>SOLICITANTE
                                </span>
                                <i class="fas fa-chevron-down transition-transform" id="solicitante_chevron"></i>
                            </div>
                            <div id="solicitante_collapse" class="collapse-content" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease;">
                                <div class="p-3 space-y-3">
                                    <div class="exp-field">
                                        <label class="exp-label">Solicitante</label>
                                        <input type="text" id="solicitante" class="input-field read-only" exp-value readonly>
                                    </div>
                                    <div class="exp-field">
                                        <label class="exp-label">Cédula</label>
                                        <input type="text" id="cedula" class="input-field read-only" exp-value readonly>
                                    </div>
                                    <div class="exp-field">
                                        <label class="exp-label">Teléfono</label>
                                        <input type="text" id="telefono" class="input-field read-only" exp-value readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="note mt-3 hidden" id="found_msg">
                        <i class="fas fa-check-circle"></i> Información recuperada.
                    </div>
                    <button class="btn-collapse-bottom mt-4" onclick="collapseFromBottom('sec_expediente')">
                        <i class="fas fa-chevron-up"></i> Cerrar Sección
                    </button>
                </div>
            </div>
            <div class="group-header" onclick="toggleSection('sec_generales', this)"><span><i class="fas fa-info-circle mr-2"></i>DATOS GENERALES</span><i class="fas fa-chevron-down chevron-icon"></i></div>
            <div id="sec_generales" class="section-content hidden-section"><div id="container_profesional" class="question border-b border-gray-100"><div class="flex justify-between items-center mb-2"><label class="font-bold text-gray-700">Profesional responsable</label><div class="flex items-center gap-3"><button onclick="saveSimpleField('profesional')" id="btn_save_profesional" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded shadow-sm transition-colors" title="Guardar"><i class="fas fa-save fa-lg"></i></button><button onclick="editSimpleField('profesional')" id="btn_edit_profesional" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 px-3 py-2 rounded shadow-sm transition-colors hidden" title="Editar"><i class="fas fa-edit fa-lg"></i></button><button onclick="clearSimpleField('profesional')" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded shadow-sm transition-colors" title="Limpiar"><i class="fas fa-trash fa-lg"></i></button></div></div><input type="text" id="input_profesional" class="input-field" value="Pablo César Sánchez Núñez"></div><div id="container_asistente1" class="question border-b border-gray-100"><div class="flex justify-between items-center mb-2"><label class="font-bold text-gray-700">Asistente 1</label><div class="flex items-center gap-3"><button onclick="saveSimpleField('asistente1')" id="btn_save_asistente1" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded shadow-sm transition-colors" title="Guardar"><i class="fas fa-save fa-lg"></i></button><button onclick="editSimpleField('asistente1')" id="btn_edit_asistente1" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 px-3 py-2 rounded shadow-sm transition-colors hidden" title="Editar"><i class="fas fa-edit fa-lg"></i></button><button onclick="clearSimpleField('asistente1')" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded shadow-sm transition-colors" title="Limpiar"><i class="fas fa-trash fa-lg"></i></button></div></div><input type="text" id="input_asistente1" class="input-field" value="Federico Berrocal Saborío"></div><div id="container_asistentes_extras" class="question border-b border-gray-100"></div><div class="question bg-gray-50"><button class="btn-add mt-2" onclick="addAsistente()"><i class="fas fa-user-plus"></i> Agregar Asistente</button></div><div class="question border-t border-gray-100 bg-gray-50 mt-4"><label class="mb-3 text-gray-700 font-bold">Acompañantes (Adicionales)</label><div id="container_acompanantes"></div><button class="btn-add mt-2" onclick="addAcompanante()"><i class="fas fa-user-plus"></i> Agregar Acompañante</button><button class="btn-collapse-bottom mt-3" onclick="collapseFromBottom('sec_generales')"><i class="fas fa-chevron-up"></i> Cerrar Sección</button></div></div>
            <div class="group-header" onclick="toggleSection('sec_ubicacion', this)"><span><i class="fas fa-map-marker-alt mr-2"></i>UBICACIÓN DE PREDIO</span><i class="fas fa-chevron-down chevron-icon"></i></div>
            <div id="sec_ubicacion" class="section-content hidden-section"><div id="container_vertices"></div><button class="btn-add" onclick="addVertice()"><i class="fas fa-plus"></i> Agregar Vértice</button><button class="btn-collapse-bottom" onclick="collapseFromBottom('sec_ubicacion')"><i class="fas fa-chevron-up"></i> Cerrar Sección</button></div>
            <div class="group-header" onclick="toggleSection('sec_arboles', this)"><span><i class="fas fa-tree mr-2"></i>INVENTARIO FORESTAL</span><i class="fas fa-chevron-down chevron-icon"></i></div>
            <div id="sec_arboles" class="section-content hidden-section"><div id="container_arboles"></div><button class="btn-add" onclick="addArbol()"><i class="fas fa-plus"></i> Agregar Árbol</button><button class="btn-collapse-bottom" onclick="collapseFromBottom('sec_arboles')"><i class="fas fa-chevron-up"></i> Cerrar Sección</button></div>
            <div class="group-header" onclick="toggleSection('sec_agua', this)"><span><i class="fas fa-water mr-2"></i>FUENTES DE AGUA</span><i class="fas fa-chevron-down chevron-icon"></i></div>
            <div id="sec_agua" class="section-content hidden-section"><div id="container_agua"></div><button class="btn-add" onclick="addFuente()"><i class="fas fa-plus"></i> Agregar Fuente</button><button class="btn-collapse-bottom" onclick="collapseFromBottom('sec_agua')"><i class="fas fa-chevron-up"></i> Cerrar Sección</button></div>
            <div class="group-header" onclick="toggleSection('sec_obs_finales', this)"><span><i class="fas fa-clipboard-list mr-2"></i>OBSERVACIONES FINALES</span><i class="fas fa-chevron-down chevron-icon"></i></div>
            <div id="sec_obs_finales" class="section-content hidden-section"><div id="container_obs_finales"></div><button class="btn-add" onclick="addObservacion()"><i class="fas fa-plus"></i> Agregar Observación</button><button class="btn-collapse-bottom" onclick="collapseFromBottom('sec_obs_finales')"><i class="fas fa-chevron-up"></i> Cerrar Sección</button></div>
            
            <!-- DASHBOARD -->
            <div class="dashboard-card">
                <h3 class="font-bold text-gray-700 mb-3 border-b border-green-200 pb-2"><i class="fas fa-chart-pie mr-2"></i>Resumen de Inspección Actual</h3>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div><div class="dash-label">Total Árboles (Guardados)</div><div id="summary_count" class="dash-value">0</div></div>
                    <div><div class="dash-label">Volumen (m3)</div><div id="summary_vol" class="dash-value">0.00</div></div>
                </div>
            </div>

            <!-- MAPA DE INSPECCIÓN (Leaflet) - Insertado después del Resumen de Inspección Actual -->
            <div class="dashboard-card mt-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                    <h3 class="font-bold text-gray-700 text-lg">
                        <i class="fas fa-map-marked-alt mr-2 text-blue-600"></i>Mapa de Inspección
                    </h3>
                    <div class="flex flex-wrap gap-2 w-full sm:w-auto map-controls-wrap">
                        <button onclick="toggleMapLayer('trees')" class="map-layer-btn active" data-layer="trees">
                            <i class="fas fa-tree mr-1"></i>Árboles
                        </button>
                        <button onclick="toggleMapLayer('vertices')" class="map-layer-btn active" data-layer="vertices">
                            <i class="fas fa-map-marker-alt mr-1"></i>Vértices
                        </button>
                        <button onclick="toggleMapLayer('observations')" class="map-layer-btn active" data-layer="observations">
                            <i class="fas fa-clipboard-list mr-1"></i>Observaciones
                        </button>
                        <button onclick="toggleMapLayer('track')" class="map-layer-btn active" data-layer="track">
                            <i class="fas fa-route mr-1"></i>Track
                        </button>
                        <button onclick="centerMapOnData()" class="map-layer-btn bg-blue-100 text-blue-800" data-layer="center">
                            <i class="fas fa-crosshairs mr-1"></i>Centrar
                        </button>
                    </div>
                </div>

                <div id="inspeccion_map" class="h-[400px] sm:h-[500px] w-full rounded-xl border-3 border-gray-400 bg-gray-200 overflow-hidden">
                    <!-- Mapa se cargará aquí -->
                    <div class="h-full flex items-center justify-center text-gray-600">
                        <div class="text-center">
                            <i class="fas fa-map fa-3x mb-3 opacity-50"></i>
                            <p class="font-bold text-lg">Mapa de inspección</p>
                            <p class="text-sm mt-2">El mapa se activará al iniciar la inspección</p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 pt-3 border-t border-gray-300">
                    <div class="flex flex-wrap items-center justify-between gap-3">
                        <div class="flex flex-wrap gap-3">
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded-full bg-green-600 mr-2"></div>
                                <span class="text-sm font-medium">Árboles</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded-full bg-blue-600 mr-2"></div>
                                <span class="text-sm font-medium">Vértices</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded-full bg-purple-600 mr-2"></div>
                                <span class="text-sm font-medium">Observaciones</span>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>Actualiza al guardar elementos
                        </div>
                    </div>
                </div>
            </div>

            
            <!-- SISTEMA DE AUTOGUARDADO Y EXPORTACIÓN -->
            <div class="dashboard-card mt-6">
                <h3 class="font-bold text-gray-700 mb-3 border-b border-blue-200 pb-2">
                    <i class="fas fa-database mr-2 text-blue-600"></i>Sistema de Respaldo
                </h3>

                <!-- Indicador de estado -->
                <div class="flex items-center justify-between mb-4 p-3 bg-gray-50 rounded-lg border">
                    <div class="flex items-center gap-3">
                        <div id="backup_status_indicator" class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                        <span id="backup_status_text" class="text-sm font-medium text-gray-700">Guardando automáticamente...</span>
                    </div>
                    <div class="text-xs text-gray-500" id="last_save_time">Hace 0s</div>
                </div>

                <!-- Botones de acción -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <!-- Exportar -->
                    <button onclick="exportarInspeccionAZip()" class="bg-green-100 hover:bg-green-200 text-green-700 py-3 px-4 rounded-lg font-bold flex items-center justify-center gap-2">
                        <i class="fas fa-file-export"></i>
                        <span>Exportar ZIP</span>
                    </button>

                    <!-- Importar -->
                    <button onclick="document.getElementById('import_zip_input').click()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 py-3 px-4 rounded-lg font-bold flex items-center justify-center gap-2">
                        <i class="fas fa-file-import"></i>
                        <span>Importar ZIP</span>
                    </button>
                </div>

                <!-- Subir archivo ZIP (oculto) -->
                <input type="file" id="import_zip_input" class="hidden" accept=".zip" onchange="importarDesdeZip(this.files[0])">

                <!-- Gestión de backups -->
                <div class="mt-4 pt-3 border-t border-gray-200">
                    <button onclick="mostrarModalBackups()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded text-sm font-medium flex items-center justify-center gap-2">
                        <i class="fas fa-history"></i>
                        <span>Ver backups y sesiones anteriores</span>
                        <span id="backup_count_badge" class="bg-green-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                    </button>
                </div>
            </div>

<div class="p-5 border-t border-gray-200 mt-4 bg-gray-50"><label class="block text-sm font-bold text-gray-700 mb-2">Fecha y Hora de Finalización</label><input type="text" id="end_time_clock" class="input-field font-mono text-center text-gray-600 bg-gray-100 font-bold text-lg py-3" readonly value="Cargando..."><div class="hint text-center mt-2">Se detendrá al finalizar</div></div>
            <div class="p-5 pb-6"><button onclick="finalizarInspeccion()" id="btn_finish" class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-bold py-5 px-4 rounded-xl shadow-lg text-lg transition-all flex items-center justify-center gap-3"><i class="fas fa-check-circle fa-lg"></i> Finalizar Inspección y Generar Reporte</button></div>
            
            <!-- INSPECCIONES FINALIZADAS -->
            <div class="inspecciones-list" id="sec_inspecciones_finalizadas">
                <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2"><i class="fas fa-clipboard-check text-green-600"></i> Inspecciones Finalizadas <span id="count_inspecciones" class="bg-green-600 text-white text-xs px-2 py-1 rounded-full">0</span></h3>
                <div id="lista_inspecciones"></div>
                <div id="no_inspecciones" class="text-center text-gray-400 py-4 text-sm">No hay inspecciones finalizadas aún</div>
            </div>
            
            <div class="p-5 text-center text-xs text-gray-400 pb-8"><p class="font-semibold">Elaborado por Ing. Pablo César Sánchez Núñez</p><p>Oficina Subregional Orotina</p><p>ACOPAC</p></div>
        </div>
    </div>
    
    <!-- Modal de detalle de inspección -->
    <div class="modal-overlay" id="modal_inspeccion">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal_title"><i class="fas fa-folder-open mr-2"></i>Expediente</h3>
                <button class="modal-close" onclick="cerrarModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal_body">
            </div>
        </div>
    </div>

    <script>
        const speciesList = ["otra", "Abarema idiopoda (Guabilla / Tamarindo)", "Acacia mangium (Acacia / Mangium)", "Acrocomia aculeata (Coyol)", "Alchornea latifolia (Targuá)", "Alnus acuminata (Jaúl)", "Anacardium excelsum (Espavel)", "Andira inermis (Carne asada / Almendro de río)", "Annona muricata (Guanábana)", "Annona spraguei (Anona de montaña)", "Anthodiscus chocoensis (Ajo negro - VEDADA)", "Apeiba tibourbou (Peine de mico)", "Ardisia revoluta (Tucuico)", "Astronium graveolens (Ron Ron)", "Attalea butyracea (Palma Real)", "Avicennia bicolor (Mangle salado / Palo de sal)", "Avicennia germinans (Mangle negro)", "Bactris gasipaes (Pejibaye)", "Balizia elegans (Gavilán)", "Bernoullia flammea (Amapola)", "Billia hippocastanum (Cocora)", "Bombacopsis quinata (Pochote)", "Bravaisia integerrima (Mangle blanco)", "Brosimum alicastrum (Ojoche)", "Brosimum utile (Lechoso)", "Bursera simaruba (Indio Desnudo / Jiñocuabe)", "Byrsonima crassifolia (Nance)", "Calophyllum brasiliense (Cedro María)", "Calycophyllum candidissimum (Madroño)", "Carapa guianensis (Caobilla)", "Caryocar costaricense (Ajo / Ajillo)", "Caryodaphnopsis burgeri (Quira / Cocobola - VEDADA)", "Casearia corymbosa (Raspa lengua)", "Castilla elastica (Hule)", "Cecropia insignis (Burío)", "Cecropia obtusifolia (Guarumo)", "Cecropia peltata (Guarumo)", "Cedrela fissilis (Cedro real - VEDADA)", "Cedrela odorata (Cedro Amargo)", "Cedrela salvadorensis (Cedro - VEDADA)", "Cedrela tonduzii (Cedro Dulce)", "Ceiba pentandra (Ceiba)", "Cespedesia spathulata (Tabaco de danta)", "Chloroleucon mangense (Cenízaro macho / Guayacán blanco)", "Chrysobalanus icaco (Icaco)", "Chrysophyllum cainito (Caimito)", "Clusia rosea (Copey)", "Coccoloba tuerkheimii (Zapatón)", "Cochlospermum vitifolium (Poroporo)", "Cojoba arborea (Quebracho)", "Copaifera aromatica (Camíbar)", "Copaifera camibar (Camíbar - VEDADA)", "Cordia alliodora (Laurel)", "Cordia collococca (Muñeco)", "Cordia gerascanthus (Laurel negro - VEDADA)", "Couratari guianensis (Cachimbo)", "Couratari scottmorii (Cachimbo / Copo - VEDADA)", "Couropita nicaraguensis (Zapote de mico)", "Crescentia cujete (Jícaro)", "Croton draco (Targuá)", "Cupressus lusitanica (Ciprés)", "Dalbergia retusa (Cocobolo)", "Delonix regia (Malinche)", "Dendropanax arboreus (Zopilote / Cacho de venado)", "Dialium guianense (Tamarindo de montaña)", "Diphysa americana (Guachipelín)", "Dipteryx panamensis (Almendro de montaña - VEDADA)", "Drimys granadensis (Chile muelo)", "Enterolobium cyclocarpum (Guanacaste)", "Erythrina fusca (Poró extranjero)", "Erythrina poeppigiana (Poró)", "Eucalyptus deglupta (Eucalipto deglupta)", "Eucalyptus saligna (Eucalipto saligna)", "Eugenia sp (Murta)", "Ficus costaricana (Higuerón / Matapalo)", "Ficus insipida (Chilamate)", "Garcinia intermedia (Zatra / Mangulillo)", "Genipa americana (Guaitil)", "Gliricidia sepium (Madero Negro)", "Gmelina arborea (Melina)", "Goethalsia meiantha (Guácimo blanco)", "Guaiacum sanctum (Guayacán Real - VEDADA)", "Guarea glabra (Cocora / Manu)", "Guazuma ulmifolia (Guácimo)", "Heliocarpus appendiculatus (Burío)", "Hernandia didymantha (Zoncho)", "Hieronyma alchorneoides (Pilón)", "Hura crepitans (Jabillo)", "Hymenaea courbaril (Guapinol)", "Hymenolobium mesoamericanum (Cola de pavo - VEDADA)", "Inga densiflora (Guaba)", "Inga edulis (Guaba)", "Jacaranda copaia (Gallinazo)", "Jacaranda mimosifolia (Jacaranda)", "Laguncularia racemosa (Mangle mariquita)", "Lecythis ampla (Olla de Mono)", "Licania operculipetala (Zapotillo)", "Licania platypus (Zapote mechudo / Zonzapote)", "Lonchocarpus felipei (Chaperno)", "Luehea seemannii (Guácimo Macho)", "Luehea speciosa (Guácimo Macho)", "Maclura tinctoria (Mora)", "Macrohasseltia macroterantha (Cacho de venado)", "Magnolia poasana (Magnolia)", "Manilkara chicle (Níspero)", "Mauria heterophylla (Cirrí)", "Miconia sp (Lengua de vaca)", "Minquartia guianensis (Manú / Manu negro)", "Myroxylon balsamum (Bálsamo / Chirraca - VEDADA)", "Nectandra sp (Aguacatillo / Quizarrá)", "Ochroma pyramidale (Balsa)", "Ocotea sp (Quizarrá)", "Pachira aquatica (Zapotón)", "Pachira quinata (Pochote)", "Paramachaerium gruberi (Sangrillo colorado - VEDADA)", "Parkia pendula (Tamarindo gigante - VEDADA)", "Peltogyne purpurea (Nazareno)", "Pentaclethra macroloba (Gavilán)", "Persea americana (Aguacate)", "Pinus caribaea (Pino Caribe)", "Pinus oocarpa (Pino)", "Pithecellobium dulce (Michiguiste)", "Pithecellobium saman (Cenízaro)", "Platymiscium parviflorum (Cristóbal / Ñambar - VEDADA)", "Platymiscium pinnatum (Cristóbal / Quira - VEDADA)", "Podocarpus costaricensis (Cipresillo - VEDADA)", "Podocarpus guatemalensis (Cipresillo / Pinillo - VEDADA)", "Posoqueria latifolia (Guayaba de mono)", "Pouteria viridis (Zapote)", "Prioria copaifera (Cativo)", "Pseudobombax septenatum (Ceibo barrigón)", "Psidium guajava (Guayaba)", "Pterocarpus officinalis (Sangrillo de estero)", "Qualea paraensis (Chancho / Areño)", "Quercus costaricensis (Roble / Encino)", "Rhizophora mangle (Mangle rojo)", "Samanea saman (Cenízaro)", "Sapium glandulosum (Yos)", "Schizolobium parahyba (Gallinazo)", "Sciadodendron excelsum (Lagarto)", "Sclerolobium costarricense (Tostado - VEDADA)", "Sideroxylon capiri (Tempisque)", "Simarouba amara (Aceituno)", "Sloanea sp (Terciopelo)", "Spondias mombin (Jobo)", "Spondias purpurea (Jocote)", "Sterculia apetala (Panamá)", "Swietenia humilis (Caoba del Pacífico)", "Swietenia macrophylla (Caoba - VEDADA)", "Symphonia globulifera (Cerillo)", "Tabebuia ochracea (Corteza Amarilla)", "Tabebuia rosea (Roble de Sabana)", "Tapirira guianensis (Cirrí)", "Tectona grandis (Teca)", "Terminalia amazonia (Roble Coral)", "Terminalia catappa (Almendro de playa)", "Terminalia ivorensis (Terminalia)", "Terminalia oblonga (Surá)", "Tetrathylacium macrophyllum (Zapote de monte)", "Trema micrantha (Capulín)", "Trichilia havanensis (Uruca)", "Virola koschnyi (Fruta Dorada)", "Virola sebifera (Fruta Dorada)", "Vismia baccifera (Achiotillo)", "Vochysia allenii (Botarrama)", "Vochysia ferruginea (Botarrama / Chancho)", "Vochysia guatemalensis (Ceibo / Mayo)", "Vochysia hondurensis (San Juan)", "Xylopia sericophylla (Majagua)", "Zanthoxylum mayanum (Lagarto)", "Zygia longifolia (Sotacaballo)"];
        
        // Base de datos de estado de conservación (Estrada 2005) y CITES
        const conservationData = {
            "Astronium graveolens": { status: "En Peligro (EN)", source: "Estrada et al. 2005", cites: null },
            "Balizia elegans": { status: "Vulnerable (VU)", source: "Estrada et al. 2005", cites: null },
            "Brosimum utile": { status: "Vulnerable (VU)", source: "Estrada et al. 2005", cites: null },
            "Caryocar costaricense": { status: "Vulnerable (VU)", source: "Estrada et al. 2005", cites: "Apéndice II" },
            "Cedrela odorata": { status: "Vulnerable (VU)", source: "Estrada et al. 2005", cites: "Apéndice III" },
            "Cedrela tonduzii": { status: "En Peligro (EN)", source: "Estrada et al. 2005", cites: null },
            "Ceiba pentandra": { status: "Vulnerable (VU)", source: "Estrada et al. 2005", cites: null },
            "Copaifera aromatica": { status: "En Peligro (EN)", source: "Estrada et al. 2005", cites: null },
            "Couratari guianensis": { status: "En Peligro (EN)", source: "Estrada et al. 2005", cites: null },
            "Cynometra hemitomophylla": { status: "En Peligro (EN)", source: "Estrada et al. 2005", cites: null },
            "Dalbergia retusa": { status: "En Peligro (EN)", source: "Estrada et al. 2005", cites: "Apéndice II" },
            "Dussia macroprophyllata": { status: "Vulnerable (VU)", source: "Estrada et al. 2005", cites: null },
            "Humiriastrum diguense": { status: "En Peligro Crítico (CR)", source: "Estrada et al. 2005", cites: null },
            "Lecythis ampla": { status: "Casi Amenazada (NT)", source: "Estrada et al. 2005", cites: null },
            "Minquartia guianensis": { status: "Vulnerable (VU)", source: "Estrada et al. 2005", cites: null },
            "Mora oleifera": { status: "Vulnerable (VU)", source: "Estrada et al. 2005", cites: null },
            "Oreomunnea pterocarpa": { status: "En Peligro Crítico (CR)", source: "Estrada et al. 2005", cites: "Apéndice II" },
            "Peltogyne purpurea": { status: "Vulnerable (VU)", source: "Estrada et al. 2005", cites: null },
            "Prioria copaifera": { status: "En Peligro (EN)", source: "Estrada et al. 2005", cites: null },
            "Sideroxylon capiri": { status: "Vulnerable (VU)", source: "Estrada et al. 2005", cites: null },
            "Swietenia humilis": { status: "En Peligro Crítico (CR)", source: "Estrada et al. 2005", cites: "Apéndice II" },
            "Tachigalia versicolor": { status: "Vulnerable (VU)", source: "Estrada et al. 2005", cites: null },
            "Terminalia amazonia": { status: "Preocupación Menor (LC)", source: "Estrada et al. 2005", cites: null },
            "Terminalia oblonga": { status: "Vulnerable (VU)", source: "Estrada et al. 2005", cites: null },
            "Vantanea barbourii": { status: "En Peligro (EN)", source: "Estrada et al. 2005", cites: null },
            "Hymenaea courbaril": { status: "Vulnerable (VU)", source: "Jiménez 1999", cites: null },
            "Platymiscium pleiostachyum": { status: "En Peligro Crítico (CR)", source: "Jiménez 1999", cites: "Apéndice III" },
            "Tabebuia guayacan": { status: "Vulnerable (VU)", source: "Estrada et al. 2005", cites: null }
        };
        
        function getConservationInfo(speciesName) {
            // Extraer nombre científico (antes del paréntesis)
            const sciName = speciesName.split('(')[0].trim();
            return conservationData[sciName] || null;
        }
        
        // Sistema de autocompletado de especies
        function initSpeciesDatalist() { }
        
        function setupSpeciesAutocomplete(inputId, arbolId) {
            const input = document.getElementById(inputId);
            const container = input.parentElement;
            container.classList.add('species-autocomplete');
            
            // Crear contenedor de sugerencias
            let suggestionsDiv = document.getElementById(`suggestions_${arbolId}`);
            if (!suggestionsDiv) {
                suggestionsDiv = document.createElement('div');
                suggestionsDiv.id = `suggestions_${arbolId}`;
                suggestionsDiv.className = 'species-suggestions';
                container.appendChild(suggestionsDiv);
            }
            
            let selectedIndex = -1;
            
            input.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                if (query.length < 2) {
                    suggestionsDiv.classList.remove('active');
                    return;
                }
                
                const matches = speciesList.filter(sp => {
                    const lower = sp.toLowerCase();
                    return lower.includes(query);
                }).slice(0, 8);
                
                if (matches.length === 0) {
                    suggestionsDiv.classList.remove('active');
                    return;
                }
                
                selectedIndex = -1;
                suggestionsDiv.innerHTML = matches.map((sp, idx) => {
                    const parts = sp.match(/^([^(]+)\s*\(([^)]+)\)$/);
                    let sciName = sp, commonName = '';
                    if (parts) {
                        sciName = parts[1].trim();
                        commonName = parts[2].trim();
                    }
                    
                    // Resaltar coincidencia
                    const highlightText = (text, query) => {
                        const regex = new RegExp(`(${query})`, 'gi');
                        return text.replace(regex, '<span class="match">$1</span>');
                    };
                    
                    return `<div class="species-suggestion" data-value="${sp}" data-index="${idx}">
                        <div class="sci-name">${highlightText(sciName, query)}</div>
                        ${commonName ? `<div class="common-name">${highlightText(commonName, query)}</div>` : ''}
                    </div>`;
                }).join('');
                
                suggestionsDiv.classList.add('active');
                
                // Eventos de clic en sugerencias
                suggestionsDiv.querySelectorAll('.species-suggestion').forEach(item => {
                    item.addEventListener('click', function() {
                        input.value = this.dataset.value;
                        suggestionsDiv.classList.remove('active');
                        checkSpecies(arbolId);
                    });
                });
            });
            
            // Navegación con teclado
            input.addEventListener('keydown', function(e) {
                const items = suggestionsDiv.querySelectorAll('.species-suggestion');
                if (!suggestionsDiv.classList.contains('active') || items.length === 0) return;
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    updateSelection(items);
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    input.value = items[selectedIndex].dataset.value;
                    suggestionsDiv.classList.remove('active');
                    checkSpecies(arbolId);
                } else if (e.key === 'Escape') {
                    suggestionsDiv.classList.remove('active');
                }
            });
            
            function updateSelection(items) {
                items.forEach((item, idx) => {
                    item.classList.toggle('selected', idx === selectedIndex);
                });
                if (selectedIndex >= 0) {
                    items[selectedIndex].scrollIntoView({ block: 'nearest' });
                }
            }
            
            // Cerrar al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!container.contains(e.target)) {
                    suggestionsDiv.classList.remove('active');
                }
            });
        }
        
        let activeCameraBtnId=null;

        // ============================================================================
        // RELACIONES CRÍTICAS CON VIDA SILVESTRE (por árbol)
        // Fuente: SINAC / CITES / IUCN / ICT (según corresponda). Última actualización: 2026-01-29.
        // ============================================================================

        const wildlifeRelationsSpeciesDB = [
            {
                category: "Ave",
                commonName: "Lapa Verde",
                scientificName: "Ara ambiguus",
                officialDisplayName: "Lapa Verde (Ara ambiguus)",
                legalBasis: "Resolución R-SINAC-CONAC-092-2017 (En Peligro de Extinción en CR); CITES Apéndice I; IUCN Red List: En Peligro Crítico (CR).",
                threatCategory: "En Peligro de Extinción. Importancia Turística: Alta (especie bandera del Caribe Norte).",
                keywords: ["ara ambiguus", "lapa verde", "guacamaya verde"]
            },
            {
                category: "Ave",
                commonName: "Lapa Roja",
                scientificName: "Ara macao",
                officialDisplayName: "Lapa Roja (Ara macao)",
                legalBasis: "Resolución R-SINAC-CONAC-092-2017 (En Peligro/Poblaciones Reducidas); CITES Apéndice I.",
                threatCategory: "Poblaciones Reducidas. Importancia Turística: Muy Alta (ave más fotografiada en el Pacífico Central).",
                keywords: ["ara macao", "lapa roja", "guacamaya roja"]
            },
            {
                category: "Ave",
                commonName: "Quetzal",
                scientificName: "Pharomachrus mocinno",
                officialDisplayName: "Quetzal (Pharomachrus mocinno)",
                legalBasis: "Resolución R-SINAC-CONAC-092-2017 (En Peligro/Poblaciones Reducidas); CITES Apéndice I.",
                threatCategory: "Poblaciones Reducidas. Importancia Turística: Muy Alta (especie \"meta\" principal del aviturismo de montaña).",
                keywords: ["quetzal", "pharomachrus mocinno"]
            },
            {
                category: "Ave",
                commonName: "Pájaro Campana",
                scientificName: "Procnias tricarunculatus",
                officialDisplayName: "Pájaro Campana (Procnias tricarunculatus)",
                legalBasis: "Lista Oficial de Aves de Costa Rica (Poblaciones Reducidas); IUCN: Vulnerable (VU).",
                threatCategory: "Poblaciones Reducidas.",
                keywords: ["pajaro campana", "procnias tricarunculatus", "campanero"]
            },
            {
                category: "Ave",
                commonName: "Jabirú",
                scientificName: "Jabiru mycteria",
                officialDisplayName: "Jabirú (Jabiru mycteria)",
                legalBasis: "Resolución R-SINAC-CONAC-092-2017 (En Peligro de Extinción).",
                threatCategory: "En Peligro de Extinción.",
                keywords: ["jabiru mycteria", "jabiru", "jabirú"]
            },
            {
                category: "Mamífero",
                commonName: "Jaguar",
                scientificName: "Panthera onca",
                officialDisplayName: "Jaguar (Panthera onca)",
                legalBasis: "Ley de Conservación de la Vida Silvestre No. 7317; CITES Apéndice I; IUCN: Casi Amenazado (NT). Considerado especie en peligro a nivel nacional.",
                threatCategory: "Ley de Conservación de la Vida Silvestre No. 7317; IUCN: Casi Amenazado (NT). Considerado especie en peligro a nivel nacional.",
                keywords: ["panthera onca", "jaguar"]
            },
            {
                category: "Mamífero",
                commonName: "Danta o Tapir Centroamericano",
                scientificName: "Tapirus bairdii",
                officialDisplayName: "Danta o Tapir Centroamericano (Tapirus bairdii)",
                legalBasis: "Resolución R-SINAC-CONAC-092-2017 (En Peligro de Extinción); CITES Apéndice I; IUCN: En Peligro (EN).",
                threatCategory: "En Peligro de Extinción.",
                keywords: ["tapirus bairdii", "danta", "tapir"]
            },
            {
                category: "Mamífero",
                commonName: "Mono Tití o Saimiri",
                scientificName: "Saimiri oerstedii",
                officialDisplayName: "Mono Tití o Saimiri (Saimiri oerstedii)",
                legalBasis: "Resolución R-SINAC-CONAC-092-2017 (En Peligro de Extinción); IUCN: Vulnerable (VU).",
                threatCategory: "En Peligro de Extinción.",
                keywords: ["saimiri oerstedii", "mono tití", "saimiri"]
            },
            {
                category: "Epífita",
                commonName: "Orquídea Guaria Morada",
                scientificName: "Guarianthe skinneri",
                officialDisplayName: "Orquídea Guaria Morada (Guarianthe skinneri)",
                legalBasis: "Decreto Ejecutivo N° 11924 (1939, Flor Nacional); CITES Apéndice II.",
                threatCategory: "Flor Nacional, comercio regulado.",
                keywords: ["guarianthe skinneri", "guaria morada"]
            },
            {
                category: "Epífita",
                commonName: "Orquídea",
                scientificName: "Cattleya dowiana",
                officialDisplayName: "Orquídea (Cattleya dowiana)",
                legalBasis: "CITES Apéndice I (prohibición total de comercio internacional).",
                threatCategory: "Comercio internacional vedado.",
                keywords: ["cattleya dowiana", "orquidea", "orquídea"]
            }
        ];

        function initWildlifeRelationsForArbol(arbolId) {
            const jsonEl = document.getElementById(`wildlife_relations_json_t${arbolId}`);
            if (jsonEl && !jsonEl.value) jsonEl.value = '[]';
        }

        function addWildlifeRelation(arbolId, presetData) {
            const treeKey = `t${arbolId}`;
            const container = document.getElementById(`container_relaciones_${treeKey}`);
            if (!container) return;

            const relIdx = container.querySelectorAll('[data-wildlife-rel="1"]').length + 1;
            const relKey = `${treeKey}_${relIdx}`;

            const block = document.createElement('div');
            block.className = 'repeat-block border border-green-100 bg-white';
            block.setAttribute('data-wildlife-rel', '1');
            block.id = `wildlife_rel_${relKey}`;

            block.innerHTML = `
                <div class="block-header" onclick="toggleBlock('wildlife_rel_${relKey}', this.querySelector('.block-toggle'))">
                    <div class="block-header-left">
                        <span class="block-number"><i class="fas fa-leaf mr-2 text-green-400"></i>Relación #${relIdx}</span>
                        <span class="block-summary" id="summary_wrel_${relKey}">Sin especie</span>
                        <span class="block-status pending" id="status_wrel_${relKey}">Pendiente</span>
                    </div>
                    <div class="block-header-right">
                        <button class="block-toggle" onclick="event.stopPropagation()"><i class="fas fa-chevron-down"></i></button>
                    </div>
                </div>
                <div id="content_wildlife_rel_${relKey}" class="block-content p-4" style="max-height: 2200px;">
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">Tipo de Relación <span class="text-red-600">*</span></label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <select id="wrel_tipo_${relKey}" class="input-field" onchange="handleWildlifeTipoChange('${relKey}'); updateWildlifeRelationsJSON(${arbolId});">
                                    <option value="">Seleccione...</option>
                                    <option value="Hospedero">Hospedero</option>
                                    <option value="Madriguera/Anidación">Madriguera/Anidación</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div style="display:none">
                                <label class="block text-xs font-bold text-gray-600 mb-1">Especificar</label>
                                <input type="text" id="wrel_tipo_otro_${relKey}" class="input-field" placeholder="Describa el tipo..." disabled oninput="updateWildlifeRelationsJSON(${arbolId});">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">Especie Asociada</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="species-autocomplete">
                                <input type="text" id="wrel_especie_${relKey}" class="input-field" placeholder="Buscar especie..." oninput="wildlifeAutocompleteInput('${relKey}', ${arbolId}); updateWildlifeRelationsJSON(${arbolId});">
                                <div id="wrel_suggestions_${relKey}" class="species-suggestions"></div>
                            </div>
                            <div class="bg-gray-50 p-2 rounded border border-gray-200">
                                <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                                    <input type="checkbox" id="wrel_manual_chk_${relKey}" onchange="toggleWildlifeManual('${relKey}', ${arbolId}); updateWildlifeRelationsJSON(${arbolId});">
                                    Registrar especie manualmente
                                </label>
                                <input type="text" id="wrel_especie_manual_${relKey}" class="input-field mt-2" style="display:none" placeholder="Nombre de la especie..." disabled oninput="updateWildlifeRelationsJSON(${arbolId});">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">Información de Conservación, Normativa y Grado de Amenaza</label>
                        <div class="bg-white p-3 rounded border-2 border-green-100">
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-600 mb-1">Nombre Oficial Mostrado</label>
                                <input type="text" id="wrel_official_${relKey}" class="input-field read-only" placeholder="Ej: Lapa Verde (Ara ambiguus)" readonly oninput="updateWildlifeRelationsJSON(${arbolId});">
                            </div>
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-600 mb-1">Fundamento Normativo y Documentos de Referencia</label>
                                <textarea id="wrel_legal_${relKey}" class="input-field read-only" rows="3" placeholder="Listado completo de normas..." readonly oninput="updateWildlifeRelationsJSON(${arbolId});"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-600 mb-1">Grado de Amenaza o Categoría de Importancia</label>
                                <textarea id="wrel_threat_${relKey}" class="input-field read-only" rows="2" placeholder="Categoría y/o importancia..." readonly oninput="updateWildlifeRelationsJSON(${arbolId});"></textarea>
                            </div>
                            <div class="text-xs text-gray-500">
                                Fuente: SINAC / CITES / IUCN / ICT (según corresponda). Última actualización: 2026-01-29.
                            </div>
                        </div>
                    </div>

                    <div class="mt-3 flex gap-2">
                        <button type="button" class="bg-blue-100 text-blue-700 py-3 px-4 rounded flex-1 font-bold" onclick="saveWildlifeRelation('${relKey}', ${arbolId});">Guardar Relación</button>
                        <button type="button" class="bg-yellow-100 text-yellow-700 py-3 px-4 rounded flex-1 font-bold hidden" id="btn_edit_wrel_${relKey}" onclick="editWildlifeRelation('${relKey}', ${arbolId});">Editar</button>
                        <button type="button" class="bg-red-100 hover:bg-red-200 text-red-700 py-3 px-4 rounded font-bold" onclick="removeWildlifeRelation('${relKey}', ${arbolId});">Borrar</button>
                    </div>
                    <button class="btn-collapse-bottom" type="button" onclick="collapseBlockFromBottom('wildlife_rel_${relKey}')"><i class="fas fa-chevron-up"></i> Cerrar</button>
                </div>
            `;

            container.appendChild(block);
            updateWildlifeRelationSummary(relKey);
            updateWildlifeRelationsJSON(arbolId);

            // Si se proporcionan datos preexistentes, cargarlos
            if (presetData) {
                try { loadWildlifeRelation(relKey, arbolId, presetData); } catch(e) {}
            }
        }

        function handleWildlifeTipoChange(relKey) {
            const tipo = document.getElementById(`wrel_tipo_${relKey}`);
            const otro = document.getElementById(`wrel_tipo_otro_${relKey}`);
            if (!tipo || !otro) return;
            const wrap = otro.parentElement;
            if (wrap) wrap.style.display = (tipo.value === 'Otro') ? 'block' : 'none';
            if (tipo.value === 'Otro') {
                otro.disabled = false;
                otro.classList.remove('bg-gray-100');
            } else {
                otro.value = '';
                otro.disabled = true;
                otro.classList.add('bg-gray-100');
            }
            updateWildlifeRelationSummary(relKey);
        }

        function toggleWildlifeManual(relKey, arbolId) {
            const chk = document.getElementById(`wrel_manual_chk_${relKey}`);
            const autoInput = document.getElementById(`wrel_especie_${relKey}`);
            const manualInput = document.getElementById(`wrel_especie_manual_${relKey}`);
            const official = document.getElementById(`wrel_official_${relKey}`);
            const legal = document.getElementById(`wrel_legal_${relKey}`);
            const threat = document.getElementById(`wrel_threat_${relKey}`);

            if (!chk || !autoInput || !manualInput || !official || !legal || !threat) return;

            // UI only: mostrar/ocultar sin cambiar la lógica existente
            autoInput.style.display = chk.checked ? 'none' : 'block';
            manualInput.style.display = chk.checked ? 'block' : 'none';

            if (chk.checked) {
                // Manual
                autoInput.value = '';
                autoInput.disabled = true;
                autoInput.classList.add('bg-gray-100');
                manualInput.disabled = false;
                manualInput.classList.remove('bg-gray-100');

                [official, legal, threat].forEach(el => {
                    el.readOnly = false;
                    el.classList.remove('read-only');
                });

                official.value = '';
                legal.value = '';
                threat.value = '';
            } else {
                // Autocompletado
                autoInput.disabled = false;
                autoInput.classList.remove('bg-gray-100');
                manualInput.value = '';
                manualInput.disabled = true;
                manualInput.classList.add('bg-gray-100');

                [official, legal, threat].forEach(el => {
                    el.readOnly = true;
                    el.classList.add('read-only');
                });
            }

            updateWildlifeRelationSummary(relKey);
            updateWildlifeRelationsJSON(arbolId);
        }

        function wildlifeAutocompleteInput(relKey, arbolId) {
            const input = document.getElementById(`wrel_especie_${relKey}`);
            const sugg = document.getElementById(`wrel_suggestions_${relKey}`);
            const chk = document.getElementById(`wrel_manual_chk_${relKey}`);
            if (!input || !sugg || (chk && chk.checked)) return;

            const query = (input.value || '').toLowerCase().trim();
            if (query.length < 2) { sugg.classList.remove('active'); return; }

            const matches = wildlifeRelationsSpeciesDB.filter(sp => {
                const hay = `${sp.commonName} ${sp.scientificName} ${sp.officialDisplayName} ${(sp.keywords||[]).join(' ')}`.toLowerCase();
                return hay.includes(query);
            }).slice(0, 8);

            if (matches.length === 0) { sugg.classList.remove('active'); return; }

            const highlight = (t,q)=>t.replace(new RegExp(`(${q})`,'gi'), '<span class="match">$1</span>');

            sugg.innerHTML = matches.map((sp, idx) => {
                const common = highlight(sp.commonName, query);
                const sci = highlight(sp.scientificName, query);
                return `<div class="species-suggestion" data-index="${idx}" onclick="selectWildlifeSpecies('${relKey}', ${arbolId}, '${escapeHTML(sp.officialDisplayName)}')">
                            <div class="sci-name">${sci}</div>
                            <div class="common-name">${common}</div>
                        </div>`;
            }).join('');

            sugg.classList.add('active');
        }

        function selectWildlifeSpecies(relKey, arbolId, displayName) {
            const input = document.getElementById(`wrel_especie_${relKey}`);
            const sugg = document.getElementById(`wrel_suggestions_${relKey}`);
            const official = document.getElementById(`wrel_official_${relKey}`);
            const legal = document.getElementById(`wrel_legal_${relKey}`);
            const threat = document.getElementById(`wrel_threat_${relKey}`);
            if (!input || !official || !legal || !threat) return;

            const sp = wildlifeRelationsSpeciesDB.find(x => x.officialDisplayName === unescapeHTML(displayName));
            if (!sp) return;

            input.value = sp.officialDisplayName;
            if (sugg) sugg.classList.remove('active');

            official.value = sp.officialDisplayName;
            legal.value = sp.legalBasis;
            threat.value = sp.threatCategory;

            // Mantener como solo lectura cuando es predefinida
            [official, legal, threat].forEach(el => {
                el.readOnly = true;
                el.classList.add('read-only');
            });

            updateWildlifeRelationSummary(relKey);
            updateWildlifeRelationsJSON(arbolId);
        }

        function updateWildlifeRelationSummary(relKey) {
            const sum = document.getElementById(`summary_wrel_${relKey}`);
            const tipo = document.getElementById(`wrel_tipo_${relKey}`);
            const especieAuto = document.getElementById(`wrel_especie_${relKey}`);
            const chk = document.getElementById(`wrel_manual_chk_${relKey}`);
            const especieManual = document.getElementById(`wrel_especie_manual_${relKey}`);

            const tipoVal = tipo && tipo.value ? tipo.value : 'Sin tipo';
            let especieVal = 'Sin especie';
            if (chk && chk.checked) {
                especieVal = especieManual && especieManual.value ? especieManual.value : 'Sin especie';
            } else {
                especieVal = especieAuto && especieAuto.value ? especieAuto.value : 'Sin especie';
            }

            if (sum) sum.textContent = `${tipoVal} | ${especieVal}`.substring(0, 28);
        }

        function saveWildlifeRelation(relKey, arbolId) {
            // Validación mínima: tipo requerido
            const tipo = document.getElementById(`wrel_tipo_${relKey}`);
            if (tipo && !tipo.value) { alert('Seleccione el Tipo de Relación.'); return; }

            const content = document.getElementById(`content_wildlife_rel_${relKey}`);
            if (content) {
                content.querySelectorAll('input, select, textarea').forEach(el => {
                    // No bloquear el botón Editar
                    if (el.id !== `btn_edit_wrel_${relKey}`) el.disabled = true;
                });
            }

            const status = document.getElementById(`status_wrel_${relKey}`);
            if (status) { status.className = 'block-status saved'; status.textContent = 'Guardado'; }
            const btnEdit = document.getElementById(`btn_edit_wrel_${relKey}`);
            if (btnEdit) btnEdit.classList.remove('hidden');

            updateWildlifeRelationsJSON(arbolId);
            collapseBlock(`wildlife_rel_${relKey}`);
        }

        function editWildlifeRelation(relKey, arbolId) {
            const content = document.getElementById(`content_wildlife_rel_${relKey}`);
            if (!content) return;
            content.querySelectorAll('input, select, textarea').forEach(el => el.disabled = false);

            // Respetar modo manual y solo lectura
            const chk = document.getElementById(`wrel_manual_chk_${relKey}`);
            if (chk && chk.checked) {
                toggleWildlifeManual(relKey, arbolId);
            } else {
                // forzar solo lectura en campos c
                const official = document.getElementById(`wrel_official_${relKey}`);
                const legal = document.getElementById(`wrel_legal_${relKey}`);
                const threat = document.getElementById(`wrel_threat_${relKey}`);
                [official, legal, threat].forEach(el => { if (el) { el.readOnly = true; el.classList.add('read-only'); } });
            }

            const status = document.getElementById(`status_wrel_${relKey}`);
            if (status) { status.className = 'block-status pending'; status.textContent = 'Pendiente'; }
            updateWildlifeRelationsJSON(arbolId);
        }

        function removeWildlifeRelation(relKey, arbolId) {
            const el = document.getElementById(`wildlife_rel_${relKey}`);
            if (el) el.remove();
            updateWildlifeRelationsJSON(arbolId);
        }

        function loadWildlifeRelation(relKey, arbolId, data) {
            const tipo = document.getElementById(`wrel_tipo_${relKey}`);
            const tipoOtro = document.getElementById(`wrel_tipo_otro_${relKey}`);
            const chk = document.getElementById(`wrel_manual_chk_${relKey}`);
            const autoInput = document.getElementById(`wrel_especie_${relKey}`);
            const manualInput = document.getElementById(`wrel_especie_manual_${relKey}`);
            const official = document.getElementById(`wrel_official_${relKey}`);
            const legal = document.getElementById(`wrel_legal_${relKey}`);
            const threat = document.getElementById(`wrel_threat_${relKey}`);

            if (tipo && data.tipo) tipo.value = data.tipo;
            handleWildlifeTipoChange(relKey);
            if (tipoOtro && data.tipoOtro) tipoOtro.value = data.tipoOtro;

            if (chk) chk.checked = !!data.especieManualActiva;
            toggleWildlifeManual(relKey, arbolId);

            if (data.especieManualActiva) {
                if (manualInput && data.especieManual) manualInput.value = data.especieManual;
                if (official && data.official) official.value = data.official;
                if (legal && data.legalBasis) legal.value = data.legalBasis;
                if (threat && data.threatCategory) threat.value = data.threatCategory;
            } else {
                if (autoInput && data.especieAuto) autoInput.value = data.especieAuto;
                if (official && data.official) official.value = data.official;
                if (legal && data.legalBasis) legal.value = data.legalBasis;
                if (threat && data.threatCategory) threat.value = data.threatCategory;
            }

            updateWildlifeRelationSummary(relKey);
            updateWildlifeRelationsJSON(arbolId);
        }

        function updateWildlifeRelationsJSON(arbolId) {
            const treeKey = `t${arbolId}`;
            const jsonEl = document.getElementById(`wildlife_relations_json_${treeKey}`);
            const container = document.getElementById(`container_relaciones_${treeKey}`);
            if (!jsonEl || !container) return;

            const rels = [];
            container.querySelectorAll('[data-wildlife-rel="1"]').forEach(block => {
                const relKey = block.id.replace('wildlife_rel_', '');
                const tipo = document.getElementById(`wrel_tipo_${relKey}`);
                const tipoOtro = document.getElementById(`wrel_tipo_otro_${relKey}`);
                const chk = document.getElementById(`wrel_manual_chk_${relKey}`);
                const especieAuto = document.getElementById(`wrel_especie_${relKey}`);
                const especieManual = document.getElementById(`wrel_especie_manual_${relKey}`);
                const official = document.getElementById(`wrel_official_${relKey}`);
                const legal = document.getElementById(`wrel_legal_${relKey}`);
                const threat = document.getElementById(`wrel_threat_${relKey}`);

                rels.push({
                    tipo: tipo ? tipo.value : '',
                    tipoOtro: tipoOtro ? tipoOtro.value : '',
                    especieManualActiva: chk ? !!chk.checked : false,
                    especieAuto: especieAuto ? especieAuto.value : '',
                    especieManual: especieManual ? especieManual.value : '',
                    official: official ? official.value : '',
                    legalBasis: legal ? legal.value : '',
                    threatCategory: threat ? threat.value : ''
                });
            });

            jsonEl.value = JSON.stringify(rels);
        }

        // Utilidades HTML escapado para atributos inline
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        function unescapeHTML(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'");
        }

        function openCameraModal(btnId){ activeCameraBtnId=btnId; const btn=document.getElementById(btnId); if(btn.classList.contains('has-image')){ if(!confirm("¿Desea volver a tomar la fotografía?")) return; btn.classList.remove('has-image'); btn.innerHTML='<i class="fas fa-camera fa-2x"></i><br>Tomar Foto'; btn.style.backgroundImage='none'; } document.getElementById('camera_modal').classList.remove('hidden'); }
        function closeCamera(){ document.getElementById('camera_modal').classList.add('hidden'); activeCameraBtnId=null; }
        function snapPhoto(){ const f=document.createElement('div'); f.className='fixed inset-0 bg-white z-[3000] transition-opacity duration-200'; document.body.appendChild(f); setTimeout(()=>f.style.opacity='0',50); setTimeout(()=>f.remove(),250); setTimeout(()=>{ if(activeCameraBtnId){ const b=document.getElementById(activeCameraBtnId); b.classList.add('has-image'); b.style.backgroundImage="url('https://images.unsplash.com/photo-1448375240586-dfd8d395ea6c?auto=format&fit=crop&w=150&q=80')"; b.innerHTML=`<div class="camera-content"><i class="fas fa-sync fa-2x mb-1"></i><br>Cambiar Foto</div>`; } closeCamera(); },300); }
        function triggerCamera(id){ document.getElementById(id).click(); }
        function photoSelected(inp,btnId){ if(inp.files&&inp.files[0]){ const r=new FileReader(); r.onload=function(e){ const b=document.getElementById(btnId); b.classList.add('has-image'); b.style.backgroundImage=`url(${e.target.result})`; b.innerHTML=`<div class="camera-content"><i class="fas fa-sync fa-2x mb-1"></i><br>Cambiar Foto</div>`; }; r.readAsDataURL(inp.files[0]); } }
        let clockInterval;
        let inspeccionIniciada = false;
        let trackingInterval = null;
        let trackPoints = [];

        // --- Filtro anti-"bailoteo" GPS para el mapa/track (no cambia APIs ni flujos; solo depura puntos ruidosos) ---
        let _lastAcceptedTrackPoint = null;
        let _smoothBuffer = [];

        function _haversineMeters(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const toRad = (d) => d * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function addTrackPointFiltered(point) {
    // Filtro anti-"bailoteo" GPS:
    // - NO cambia el formato de trackPoints ni el GPX exportado
    // - Solo decide si un punto entra o no al track, y mantiene un buffer para suavizar el marcador actual
    try {
        if (!point || !isFinite(point.lat) || !isFinite(point.lon)) return false;

        // Helper interno: agrega el punto al track y refresca mapa/marker si aplica
        const _addTrackPointCore = (pt) => {
            trackPoints.push(pt);

            // Si existe el mapa, refrescar track y marcador actual (sin tocar estilos)
            if (typeof updateTrackOnMap === 'function') updateTrackOnMap();
            if (typeof updateCurrentLocationOnMap === 'function') updateCurrentLocationOnMap();
        };

        // Umbrales: prioriza estabilidad visual bajo canopy/sol y reduce "recorridos fantasmas"
        const acc = isFinite(point.accuracy) ? Number(point.accuracy) : null;

        // Si la precisión es muy mala, no agregar al track (evita saltos)
        if (acc && acc > 35) return false;

        if (_lastAcceptedTrackPoint) {
            const dist = _haversineMeters(
                _lastAcceptedTrackPoint.lat, _lastAcceptedTrackPoint.lon,
                point.lat, point.lon
            );

            // Si el punto se movió muy poco, se considera jitter y se ignora (a menos que haya pasado suficiente tiempo)
            const tPrev = _lastAcceptedTrackPoint.time ? new Date(_lastAcceptedTrackPoint.time).getTime() : 0;
            const tNow = point.time ? new Date(point.time).getTime() : Date.now();
            const dt = (tPrev && tNow) ? (tNow - tPrev) : 0;

            // 6m y 25s: reduce zigzag sin "matar" el track real
            if (dist < 6 && dt < 25000) return false;

            // Saltos grandes con mala precisión también se filtran
            if (dist > 80 && acc && acc > 20) return false;
        }

        _addTrackPointCore(point);
        _lastAcceptedTrackPoint = point;

        // Buffer para suavizar SOLO el marcador actual (no altera el track exportado)
        _smoothBuffer.push({ lat: point.lat, lon: point.lon });
        if (_smoothBuffer.length > 5) _smoothBuffer.shift();

        return true;
    } catch (e) {
        // En caso de error, mantener comportamiento "original": agregar el punto sin filtrar
        try {
            trackPoints.push(point);
            if (typeof updateTrackOnMap === 'function') updateTrackOnMap();
            if (typeof updateCurrentLocationOnMap === 'function') updateCurrentLocationOnMap();
            _lastAcceptedTrackPoint = point;
        } catch(_) {}
        return true;
    }
}

function getSmoothedLatLngFromBuffer(
) {
            try {
                if (!_smoothBuffer || _smoothBuffer.length === 0) return null;
                let lat = 0, lon = 0;
                _smoothBuffer.forEach(p => { lat += p.lat; lon += p.lon; });
                lat /= _smoothBuffer.length;
                lon /= _smoothBuffer.length;
                return [lat, lon];
            } catch(e) {
                return null;
            }
        }

        
        function startClock(){ const f=document.getElementById('end_time_clock'); const u=()=>{const n=new Date(); f.value=n.toLocaleDateString('es-CR')+' '+n.toLocaleTimeString('es-CR');}; u(); clockInterval=setInterval(u,1000); }
        
        function startTracking() {
            trackPoints = [];
            
            // Grabar punto cada 5 segundos (recomendado para trabajo de campo a pie)
            trackingInterval = setInterval(() => {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const point = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude,
                                ele: position.coords.altitude || 0,
                                time: new Date().toISOString(),
                                accuracy: position.coords.accuracy
                            };
                            addTrackPointFiltered(point);
                            updateTrackingStatus();
                        },
                        function(error) {
                            console.log('Error de GPS:', error.message);
                            // Simular punto para pruebas
                            addSimulatedPoint();
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 8000,
                            maximumAge: 0
                        }
                    );
                } else {
                    // Simular tracking para pruebas
                    addSimulatedPoint();
                }
            }, 5000); // Cada 5 segundos
            
            // Grabar primer punto inmediatamente
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const point = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            ele: position.coords.altitude || 0,
                            time: new Date().toISOString(),
                            accuracy: position.coords.accuracy
                        };
                        addTrackPointFiltered(point);
                        updateTrackingStatus();
                    },
                    function(error) {
                        addSimulatedPoint();
                    },
                    { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
                );
            } else {
                addSimulatedPoint();
            }
        }
        
        let simStep = 0;
        function addSimulatedPoint() {
            const baseLat = 9.913;
            const baseLon = -84.523;
            simStep++;
            const point = {
                lat: baseLat + (Math.random() - 0.5) * 0.001 + (simStep * 0.0001),
                lon: baseLon + (Math.random() - 0.5) * 0.001 + (simStep * 0.0001),
                ele: 200 + Math.random() * 10,
                time: new Date().toISOString(),
                accuracy: 5 + Math.random() * 10
            };
            addTrackPointFiltered(point);
            updateTrackingStatus();
        }
        
        function stopTracking() {
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            simStep = 0;
        }
        
        function getDistance(p1, p2) {
            // Fórmula de Haversine simplificada
            const R = 6371000; // Radio de la Tierra en metros
            const dLat = (p2.lat - p1.lat) * Math.PI / 180;
            const dLon = (p2.lon - p1.lon) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function updateTrackingStatus() {
            const statusEl = document.getElementById('tracking_status');
            if (statusEl) {
                statusEl.innerHTML = `<i class="fas fa-route mr-1"></i>${trackPoints.length} pts`;
            }
        }
        
        function generateTrackGPX() {
            if (trackPoints.length === 0) return null;
            
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="PP01-ACOPAC" xmlns="http://www.topografix.com/GPX/1/1">
<metadata>
<name>Track de Inspección</name>
<time>${trackPoints[0].time}</time>
</metadata>
<trk>
<name>Recorrido de Inspección</name>
<trkseg>`;
            
            trackPoints.forEach(pt => {
                gpx += `
<trkpt lat="${pt.lat.toFixed(6)}" lon="${pt.lon.toFixed(6)}">
<ele>${pt.ele.toFixed(1)}</ele>
<time>${pt.time}</time>
</trkpt>`;
            });
            
            gpx += `
</trkseg>
</trk>
</gpx>`;
            return gpx;
        }
        
        function iniciarInspeccion() {
            if (inspeccionIniciada) return;
            
            const n = new Date();
            const fechaHora = n.toLocaleDateString('es-CR') + ' ' + n.toLocaleTimeString('es-CR');
            document.getElementById('start_time').value = fechaHora;
            
            // Cambiar color del recuadro de gris a azul/verde
            const header = document.getElementById('inspeccion_header');
            header.classList.remove('from-gray-500', 'to-gray-600', 'border-gray-700');
            header.classList.add('from-blue-500', 'to-blue-600', 'border-blue-700');
            
            // Cambiar estilo del campo
            const startField = document.getElementById('start_time');
            startField.classList.remove('text-blue-800', 'border-blue-300');
            startField.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
            
            // Ocultar botón y mostrar estado
            document.getElementById('btn_iniciar').classList.add('hidden');
            document.getElementById('inicio_status').classList.remove('hidden');
            document.getElementById('tracking_status').classList.remove('hidden');
            
            inspeccionIniciada = true;
            
            // Iniciar reloj de finalización
            startClock();
            
            // Iniciar tracking GPS
            startTracking();
        }
        
        // Sistema de inspecciones finalizadas
        let inspeccionesFinalizadas = [];
        let expedientesInspeccionados = [];
        
        function recopilarDatosInspeccion() {
            const expedienteId = document.getElementById('expediente_id').value;
            if (!expedienteId) {
                alert('Debe seleccionar un expediente antes de finalizar la inspección.');
                return null;
            }
            
            const datos = {
                expediente: expedienteId,
                expedienteData: expedientesDB[expedienteId] || {},
                fechaInicio: document.getElementById('start_time').value,
                fechaFin: document.getElementById('end_time_clock').value,
                profesional: document.getElementById('input_profesional').value,
                asistente1: document.getElementById('input_asistente1').value,
                arboles: [],
                vertices: [],
                fuentes: [],
                observaciones: []
            };
            
            // Recopilar árboles guardados
            document.querySelectorAll('[id^="arbol_"][data-saved="true"]').forEach(b => {
                const id = b.id.split('_')[1];
                const gpsDisplay = document.getElementById(`gps_display_t${id}`);
                datos.arboles.push({
                    numero: document.getElementById(`num_arbol_${id}`).value,
                    especie: document.getElementById(`sp_arbol_${id}`).value,
                    medida: document.getElementById(`val_medida_${id}`).value,
                    lct: document.getElementById(`val_lct_${id}`).value,
                    volumen: document.getElementById(`res_volumen_${id}`).dataset.vol,
                    norte: gpsDisplay ? gpsDisplay.dataset.norte : '',
                    este: gpsDisplay ? gpsDisplay.dataset.este : '',
                    lat: gpsDisplay ? gpsDisplay.dataset.lat : '',
                    lon: gpsDisplay ? gpsDisplay.dataset.lon : ''
                });
            });
            
            // Recopilar vértices
            document.querySelectorAll('[id^="vertice_block_"]').forEach(b => {
                const id = b.id.split('_')[2];
                const gpsDisplay = document.getElementById(`gps_display_v${id}`);
                if (gpsDisplay && gpsDisplay.dataset.lat) {
                    datos.vertices.push({
                        numero: document.getElementById(`num_vertice_${id}`).value,
                        norte: gpsDisplay.dataset.norte,
                        este: gpsDisplay.dataset.este,
                        lat: gpsDisplay.dataset.lat,
                        lon: gpsDisplay.dataset.lon
                    });
                }
            });
            
            // Recopilar fuentes
            document.querySelectorAll('[id^="fuente_block_"]').forEach(b => {
                const id = b.id.split('_')[2];
                const gpsDisplay = document.getElementById(`gps_display_w${id}`);
                const selectTipo = b.querySelector('select');
                const inputObs = b.querySelector('input[type="text"]');
                datos.fuentes.push({
                    numero: document.getElementById(`num_fuente_${id}`).value,
                    tipo: selectTipo ? selectTipo.value : '',
                    observacion: inputObs ? inputObs.value : '',
                    norte: gpsDisplay ? gpsDisplay.dataset.norte : '',
                    este: gpsDisplay ? gpsDisplay.dataset.este : '',
                    lat: gpsDisplay ? gpsDisplay.dataset.lat : '',
                    lon: gpsDisplay ? gpsDisplay.dataset.lon : ''
                });
            });
            
            // Recopilar observaciones
            document.querySelectorAll('[id^="obs_final_"]').forEach(b => {
                const num = b.id.split('_')[2];
                const gpsDisplay = document.getElementById(`gps_display_o${num}`);
                const textarea = b.querySelector('textarea');
                datos.observaciones.push({
                    numero: num,
                    detalle: textarea ? textarea.value : '',
                    norte: gpsDisplay ? gpsDisplay.dataset.norte : '',
                    este: gpsDisplay ? gpsDisplay.dataset.este : '',
                    lat: gpsDisplay ? gpsDisplay.dataset.lat : '',
                    lon: gpsDisplay ? gpsDisplay.dataset.lon : ''
                });
            });
            
            return datos;
        }
        
        function generarReporteInspeccion(datos) {
            const z = new JSZip();
            const n = new Date();
            const fn = `PP01_${datos.expediente}_${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}_${String(n.getHours()).padStart(2,'0')}-${String(n.getMinutes()).padStart(2,'0')}`;
            const fo = z.folder(fn);
            
            // CSV de árboles
            let csv = "Numero,Especie,Medida_cm,LCT_m,Volumen_m3,Norte,Este\n";
            datos.arboles.forEach(a => {
                csv += `${a.numero},"${a.especie}",${a.medida},${a.lct},${parseFloat(a.volumen).toFixed(4)},${a.norte},${a.este}\n`;
            });
            fo.file("arboles.csv", csv);
            
            // GPX
            let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1"><metadata><name>Inspección ${datos.expediente}</name></metadata>`;
            datos.vertices.forEach(v => {
                if (v.lat && v.lat !== "0.0") gpx += `<wpt lat="${v.lat}" lon="${v.lon}"><name>Vértice ${v.numero}</name><sym>Flag</sym></wpt>`;
            });
            datos.arboles.forEach(a => {
                if (a.lat && a.lat !== "0.0") gpx += `<wpt lat="${a.lat}" lon="${a.lon}"><name>Árbol ${a.numero}</name><sym>Tree</sym></wpt>`;
            });
            gpx += `</gpx>`;
            fo.file("puntos_gps.gpx", gpx);
            
            // GPX del track (recorrido)
            const trackGpx = generateTrackGPX();
            if (trackGpx) {
                fo.file("track_recorrido.gpx", trackGpx);
            }
            
            // Resumen TXT
            let resumen = `INSPECCIÓN FORESTAL PP-01 ACOPAC\n${"=".repeat(40)}\n\n`;
            resumen += `Expediente: ${datos.expediente}\n`;
            resumen += `Solicitante: ${datos.expedienteData.solicitante || 'N/A'}\n`;
            resumen += `Finca: ${datos.expedienteData.finca || 'N/A'}\n`;
            resumen += `Área: ${datos.expedienteData.area || 'N/A'} ha\n\n`;
            resumen += `Fecha inicio: ${datos.fechaInicio}\n`;
            resumen += `Fecha fin: ${datos.fechaFin}\n`;
            resumen += `Profesional: ${datos.profesional}\n\n`;
            resumen += `RESUMEN:\n`;
            resumen += `- Total árboles: ${datos.arboles.length}\n`;
            resumen += `- Volumen total: ${datos.arboles.reduce((sum, a) => sum + parseFloat(a.volumen || 0), 0).toFixed(4)} m³\n`;
            resumen += `- Vértices registrados: ${datos.vertices.length}\n`;
            resumen += `- Fuentes de agua: ${datos.fuentes.length}\n`;
            resumen += `- Puntos de track: ${trackPoints.length}\n`;
            fo.file("resumen.txt", resumen);
            
            return z.generateAsync({type:"blob"}).then(c => {
                saveAs(c, fn + ".zip");
                return fn;
            });
        }
        
        function finalizarInspeccion() {
            if (!inspeccionIniciada) {
                alert('Debe iniciar la inspección primero presionando el botón "Iniciar".');
                return;
            }
            
            const datos = recopilarDatosInspeccion();
            if (!datos) return;
            
            // Detener tracking y reloj
            stopTracking();
            clearInterval(clockInterval);
            const btnFinish = document.getElementById('btn_finish');
            btnFinish.innerHTML = '<i class="fas fa-spinner fa-spin fa-lg"></i> Generando Reporte...';
            btnFinish.classList.remove('bg-green-600','hover:bg-green-700');
            btnFinish.classList.add('bg-gray-500','cursor-not-allowed');
            btnFinish.disabled = true;
            
            generarReporteInspeccion(datos).then(filename => {
                // Guardar inspección
                datos.filename = filename;
                datos.volumenTotal = datos.arboles.reduce((sum, a) => sum + parseFloat(a.volumen || 0), 0);
                inspeccionesFinalizadas.push(datos);
                expedientesInspeccionados.push(datos.expediente);
                
                // Actualizar lista visual
                actualizarListaInspecciones();
                
                // Remover expediente del selector
                removerExpedienteDelSelector(datos.expediente);
                
                // Limpiar formulario para nueva inspección
                limpiarFormulario();
                
                alert(`Inspección del expediente ${datos.expediente} finalizada.\nArchivo generado: ${filename}.zip`);
            }).catch(err => {
                console.error(err);
                alert('Error al generar el reporte.');
                btnFinish.innerHTML = '<i class="fas fa-check mr-2"></i> Finalizar Inspección y Generar Reporte';
                btnFinish.disabled = false;
            });
        }
        
        function removerExpedienteDelSelector(expedienteId) {
            const select = document.getElementById('expediente_id');
            const option = select.querySelector(`option[value="${expedienteId}"]`);
            if (option) option.remove();
        }
        
        function actualizarListaInspecciones() {
            const lista = document.getElementById('lista_inspecciones');
            const noInsp = document.getElementById('no_inspecciones');
            const count = document.getElementById('count_inspecciones');
            
            count.textContent = inspeccionesFinalizadas.length;
            
            if (inspeccionesFinalizadas.length === 0) {
                noInsp.classList.remove('hidden');
                lista.innerHTML = '';
                return;
            }
            
            noInsp.classList.add('hidden');
            lista.innerHTML = inspeccionesFinalizadas.map((insp, idx) => `
                <div class="inspeccion-item" onclick="verDetalleInspeccion(${idx})">
                    <div class="exp-num"><i class="fas fa-folder mr-2"></i>Expediente ${insp.expediente}</div>
                    <div class="exp-info">${insp.expedienteData.solicitante || 'Sin solicitante'} • ${insp.fechaFin}</div>
                    <div class="exp-stats">
                        <span><i class="fas fa-tree mr-1"></i>${insp.arboles.length} árboles</span>
                        <span><i class="fas fa-cube mr-1"></i>${insp.volumenTotal.toFixed(3)} m³</span>
                        <span><i class="fas fa-map-marker-alt mr-1"></i>${insp.vertices.length} vértices</span>
                    </div>
                </div>
            `).join('');
        }
        
        function verDetalleInspeccion(idx) {
            const insp = inspeccionesFinalizadas[idx];
            const modal = document.getElementById('modal_inspeccion');
            const title = document.getElementById('modal_title');
            const body = document.getElementById('modal_body');
            
            title.innerHTML = `<i class="fas fa-folder-open mr-2"></i>Expediente ${insp.expediente}`;
            
            let html = `
                <div class="detail-section">
                    <h4><i class="fas fa-info-circle mr-2"></i>Datos del Expediente</h4>
                    <div class="detail-row"><span class="detail-label">Fecha Recepción:</span><span class="detail-value">${insp.expedienteData.recepcion || 'N/A'}</span></div>
                    <div class="detail-row"><span class="detail-label">Solicitante:</span><span class="detail-value">${insp.expedienteData.solicitante || 'N/A'}</span></div>
                    <div class="detail-row"><span class="detail-label">Cédula:</span><span class="detail-value">${insp.expedienteData.cedula || 'N/A'}</span></div>
                    <div class="detail-row"><span class="detail-label">Finca:</span><span class="detail-value">${insp.expedienteData.finca || 'N/A'}</span></div>
                    <div class="detail-row"><span class="detail-label">Plano:</span><span class="detail-value">${insp.expedienteData.plano || 'N/A'}</span></div>
                    <div class="detail-row"><span class="detail-label">Área:</span><span class="detail-value">${insp.expedienteData.area || 'N/A'} ha</span></div>
                </div>
                
                <div class="detail-section">
                    <h4><i class="fas fa-clock mr-2"></i>Datos de la Inspección</h4>
                    <div class="detail-row"><span class="detail-label">Inicio:</span><span class="detail-value">${insp.fechaInicio}</span></div>
                    <div class="detail-row"><span class="detail-label">Fin:</span><span class="detail-value">${insp.fechaFin}</span></div>
                    <div class="detail-row"><span class="detail-label">Profesional:</span><span class="detail-value">${insp.profesional}</span></div>
                    <div class="detail-row"><span class="detail-label">Asistente:</span><span class="detail-value">${insp.asistente1 || 'N/A'}</span></div>
                </div>
            `;
            
            if (insp.arboles.length > 0) {
                html += `
                    <div class="detail-section">
                        <h4><i class="fas fa-tree mr-2"></i>Inventario Forestal (${insp.arboles.length} árboles)</h4>
                        <table class="detail-table">
                            <thead><tr><th>#</th><th>Especie</th><th>DAP/Circ</th><th>LCT</th><th>Volumen</th></tr></thead>
                            <tbody>
                                ${insp.arboles.map(a => `<tr><td>${a.numero}</td><td>${a.especie}</td><td>${a.medida} cm</td><td>${a.lct} m</td><td>${parseFloat(a.volumen).toFixed(4)} m³</td></tr>`).join('')}
                            </tbody>
                            <tfoot><tr><td colspan="4" style="text-align:right;font-weight:bold;">Total:</td><td style="font-weight:bold;">${insp.volumenTotal.toFixed(4)} m³</td></tr></tfoot>
                        </table>
                    </div>
                `;
            }
            
            if (insp.vertices.length > 0) {
                html += `
                    <div class="detail-section">
                        <h4><i class="fas fa-map-marker-alt mr-2"></i>Vértices (${insp.vertices.length})</h4>
                        <table class="detail-table">
                            <thead><tr><th>#</th><th>Norte</th><th>Este</th></tr></thead>
                            <tbody>
                                ${insp.vertices.map(v => `<tr><td>${v.numero}</td><td>${v.norte}</td><td>${v.este}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            if (insp.fuentes.length > 0) {
                html += `
                    <div class="detail-section">
                        <h4><i class="fas fa-water mr-2"></i>Fuentes de Agua (${insp.fuentes.length})</h4>
                        <table class="detail-table">
                            <thead><tr><th>#</th><th>Tipo</th><th>Norte</th><th>Este</th><th>Observación</th></tr></thead>
                            <tbody>
                                ${insp.fuentes.map(f => `<tr><td>${f.numero}</td><td>${f.tipo || 'N/A'}</td><td>${f.norte || 'N/A'}</td><td>${f.este || 'N/A'}</td><td>${f.observacion || '-'}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            if (insp.observaciones.length > 0) {
                html += `
                    <div class="detail-section">
                        <h4><i class="fas fa-clipboard-list mr-2"></i>Observaciones (${insp.observaciones.length})</h4>
                        ${insp.observaciones.map((obs, i) => `
                            <div style="background:#f9fafb; padding:10px; border-radius:4px; margin-bottom:8px; border-left:3px solid #6b7280;">
                                <div style="font-weight:bold; color:#374151; margin-bottom:5px;">Observación ${i+1}</div>
                                <div style="font-size:0.9em; color:#4b5563;">${obs.detalle || 'Sin detalle'}</div>
                                ${obs.norte ? `<div style="font-size:0.8em; color:#6b7280; margin-top:5px;"><i class="fas fa-map-pin mr-1"></i>N: ${obs.norte} | E: ${obs.este}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            body.innerHTML = html;
            modal.classList.add('active');
        }
        
        function cerrarModal() {
            document.getElementById('modal_inspeccion').classList.remove('active');
        }
        
        function limpiarFormulario() {
            // Resetear estado de inspección iniciada
            inspeccionIniciada = false;
            
            // Resetear expediente
            document.getElementById('expediente_id').value = '';
            document.getElementById('fecha_recepcion').value = '';
            document.getElementById('finca_num').value = '';
            document.getElementById('plano_num').value = '';
            document.getElementById('area_ha').value = '';
            document.getElementById('solicitante').value = '';
            document.getElementById('cedula').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('data_fields').classList.add('opacity-50');
            document.getElementById('found_msg').classList.add('hidden');
            
            // Resetear hora de inicio
            const n = new Date();
            const startField = document.getElementById('start_time');
            startField.value = n.toLocaleDateString('es-CR') + ' ' + n.toLocaleTimeString('es-CR');
            startField.classList.remove('bg-green-100', 'border-green-500', 'text-green-800');
            startField.classList.add('text-blue-800', 'border-blue-300');
            
            // Resetear color del recuadro a gris
            const header = document.getElementById('inspeccion_header');
            header.classList.remove('from-blue-500', 'to-blue-600', 'border-blue-700');
            header.classList.add('from-gray-500', 'to-gray-600', 'border-gray-700');
            
            // Mostrar botón iniciar y ocultar estado
            document.getElementById('btn_iniciar').classList.remove('hidden');
            document.getElementById('inicio_status').classList.add('hidden');
            document.getElementById('tracking_status').classList.add('hidden');
            
            // Resetear tracking
            trackPoints = [];
            
            // Limpiar contenedores
            document.getElementById('container_vertices').innerHTML = '';
            document.getElementById('container_arboles').innerHTML = '';
            document.getElementById('container_agua').innerHTML = '';
            document.getElementById('container_obs_finales').innerHTML = '';
            document.getElementById('container_acompanantes').innerHTML = '';
            document.getElementById('container_asistentes_extras').innerHTML = '';
            
            // Resetear contadores
            countVertices = 0;
            countArboles = 0;
            countFuentes = 0;
            
            // Agregar elementos iniciales
            addVertice();
            addArbol();
            addFuente();
            addAcompanante();
            addObservacion();
            
            // Resetear dashboard
            updateDashboard();
            
            // Detener reloj y mostrar pendiente
            clearInterval(clockInterval);
            document.getElementById('end_time_clock').value = 'Pendiente de iniciar';
            document.getElementById('end_time_clock').classList.remove('text-green-800','bg-green-100','border-green-500');
            document.getElementById('end_time_clock').classList.add('text-gray-600','bg-gray-100');
            
            // Resetear botón finalizar
            const btnFinish = document.getElementById('btn_finish');
            btnFinish.innerHTML = '<i class="fas fa-check-circle fa-lg"></i> Finalizar Inspección y Generar Reporte';
            btnFinish.classList.remove('bg-gray-500','cursor-not-allowed');
            btnFinish.classList.add('bg-green-600','hover:bg-green-700');
            btnFinish.disabled = false;
            
            // Cerrar secciones
            document.querySelectorAll('.section-content').forEach(s => s.classList.add('hidden-section'));
            document.querySelectorAll('.group-header').forEach(h => h.classList.remove('active'));
        }
        
        // Cerrar modal con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') cerrarModal();
        });
        
        function stopClockAndFinish(){ finalizarInspeccion(); }
        function toggleSection(id,h){ const s=document.getElementById(id); if(s.classList.contains('hidden-section')){ s.classList.remove('hidden-section'); h.classList.add('active'); }else{ s.classList.add('hidden-section'); h.classList.remove('active'); } }
        function updateSectionStatus() {
            // Actualizar estado de cada sección principal
            // Solo marca como "has-records" si hay registros GUARDADOS
            const sections = [
                { id: 'sec_expediente', container: null, checkField: 'expediente_id' },
                { id: 'sec_generales', container: null, checkField: 'input_profesional' },
                { id: 'sec_ubicacion', container: 'container_vertices', savedSelector: '[id^="vertice_block_"]' },
                { id: 'sec_arboles', container: 'container_arboles', savedSelector: '[id^="arbol_"][data-saved="true"]' },
                { id: 'sec_agua', container: 'container_agua', savedSelector: '[id^="fuente_block_"]' },
                { id: 'sec_obs_finales', container: 'container_obs_finales', savedSelector: '[id^="obs_final_"]' }
            ];
            
            sections.forEach(sec => {
                const header = document.querySelector('[onclick*="\'' + sec.id + '\'"]');
                if (!header) return;
                
                let hasContent = false;
                if (sec.container && sec.savedSelector) {
                    // Para secciones con bloques repetibles, verificar si hay elementos con status "Guardado"
                    const container = document.getElementById(sec.container);
                    if (container) {
                        const savedItems = container.querySelectorAll('.block-status.saved');
                        hasContent = savedItems.length > 0;
                    }
                } else if (sec.checkField) {
                    const field = document.getElementById(sec.checkField);
                    if (sec.id === 'sec_generales') {
                        // Para Datos Generales, verificar si el profesional fue guardado (disabled)
                        hasContent = field && field.disabled;
                    } else {
                        // Para Expediente, verificar si hay un expediente seleccionado
                        hasContent = field && field.value && field.value.trim() !== '' && field.value !== 'Seleccione una opción...';
                    }
                }
                
                header.classList.remove('empty-section', 'has-records');
                if (hasContent) {
                    header.classList.add('has-records');
                } else {
                    header.classList.add('empty-section');
                }
            });
        }
        function collapseFromBottom(sectionId) {
            const section = document.getElementById(sectionId);
            const header = document.querySelector('[onclick*="' + sectionId + '"]');
            if (section && header) {
                section.classList.add('hidden-section');
                header.classList.remove('active');
                header.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        function collapseBlockFromBottom(blockId) {
            const content = document.getElementById('content_' + blockId);
            const toggle = document.querySelector('#' + blockId + ' .block-toggle');
            if (content && !content.classList.contains('collapsed')) {
                content.classList.add('collapsed');
                if (toggle) toggle.classList.add('collapsed');
            }
            const block = document.getElementById(blockId);
            if (block) block.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function toggleExpedienteCollapse(collapseId) {
            const content = document.getElementById(collapseId);
            const chevron = document.getElementById(collapseId.replace('_collapse', '_chevron'));
            
            if (!content) return;
            
            if (content.style.maxHeight === '0px' || content.style.maxHeight === '') {
                // Expandir
                content.style.maxHeight = content.scrollHeight + 'px';
                if (chevron) chevron.style.transform = 'rotate(180deg)';
            } else {
                // Colapsar
                content.style.maxHeight = '0px';
                if (chevron) chevron.style.transform = 'rotate(0deg)';
            }
        }
        
        function setMobileView(){ document.getElementById('main-container').className='kobo-container mobile-mode'; document.getElementById('btn-mobile').classList.add('active'); document.getElementById('btn-desktop').classList.remove('active'); }
        function setDesktopView(){ document.getElementById('main-container').className='kobo-container desktop-mode'; document.getElementById('btn-mobile').classList.remove('active'); document.getElementById('btn-desktop').classList.add('active'); }
        // Alias: mantenemos la lógica existente de escritorio, pero la exponemos como 'Tablet'
        function setTabletView(){ setDesktopView(); }
        window.addEventListener('load',function(){ 
            const n=new Date(); 
            document.getElementById('start_time').value=n.toLocaleDateString('es-CR')+' '+n.toLocaleTimeString('es-CR'); 
            document.getElementById('end_time_clock').value='Pendiente de iniciar'; 
            initSpeciesDatalist(); 
            loadExpedientesFromSheet(); 
            // Stagger heavy DOM insertions to avoid freezing
            const steps = [addVertice, addArbol, addFuente, addAcompanante, addObservacion];
            let i = 0;
            function next() {
                if (i < steps.length) { steps[i](); i++; setTimeout(next, 50); }
                else { updateDashboard(); updateSectionStatus(); }
            }
            setTimeout(next, 100);
        });
        
        // Base de datos de expedientes desde Google Sheets
        let expedientesDB = {};

        // ====== BLOQUEO DE EXPEDIENTE (EVITA CAMBIOS ACCIDENTALES) ======
        let expedienteLocked = false;
        let lockedExpedienteId = '';

        function setExpedienteLockState(lock, persist=true){
            expedienteLocked = !!lock;

            const sel = document.getElementById('expediente_id');
            const btnRefresh = document.getElementById('btn_refresh_expedientes');
            const btnLock = document.getElementById('btn_lock_expediente');
            const icon = document.getElementById('icon_lock_expediente');

            // mantener memoria del expediente fijado
            if(expedienteLocked){
                const _id = sel ? (sel.value || '') : '';
                if(_id) lockedExpedienteId = _id;
            }else{
                lockedExpedienteId = '';
            }

            if(sel) sel.disabled = expedienteLocked;
            if(btnRefresh) btnRefresh.disabled = expedienteLocked;

            if(icon){
                icon.classList.remove('fa-lock', 'fa-lock-open');
                icon.classList.add(expedienteLocked ? 'fa-lock' : 'fa-lock-open');
            }
            if(btnLock){
                btnLock.title = expedienteLocked
                    ? 'Desfijar expediente (permitir cambios)'
                    : 'Fijar expediente (evita cambios accidentales)';
            }

            if(persist){
                try{
                    if(expedienteLocked){
                        const id = sel ? (sel.value || '') : '';
                        localStorage.setItem('pp01_expediente_locked', '1');
                        localStorage.setItem('pp01_expediente_locked_id', id);
                    }else{
                        localStorage.setItem('pp01_expediente_locked', '0');
                        localStorage.removeItem('pp01_expediente_locked_id');
                    }
                }catch(e){}
            }
        }

        function toggleExpedienteLock(){
            const sel = document.getElementById('expediente_id');
            const id = sel ? (sel.value || '') : '';

            if(!expedienteLocked){
                if(!id){
                    alert('Seleccione un expediente antes de fijarlo.');
                    return;
                }
                // asegurar que los datos visibles correspondan al expediente actual
                try{ loadExpedienteData(); }catch(e){}
                setExpedienteLockState(true, true);
            }else{
                setExpedienteLockState(false, true);
            }
        }

        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbyAy42TFA31tCs389AUEjHRnix2RQVRIJv25yobzB6Tnysbjerb2Ho3iwGl841JCsmK/exec';
        
        // Cargar expedientes desde Google Apps Script
        function loadExpedientesFromSheet() {
            const select = document.getElementById('expediente_id');
            select.innerHTML = '<option value="">Cargando expedientes...</option>';
            select.disabled = true;
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);
            
            fetch(SHEET_API_URL, { signal: controller.signal })
                .then(response => { clearTimeout(timeoutId); return response.json(); })
                .then(data => {
                    if (!data || data.length < 2) {
                        select.innerHTML = '<option value="">Error: Sin datos</option>';
                        select.disabled = expedienteLocked ? true : false;
                        return;
                    }
                    
                    expedientesDB = {};
                    let optionsHTML = '<option value="">Seleccione una opción...</option>';
                    
                    // data[0] son los encabezados, desde data[1] son los datos
                    // Índices: A=0 EXPEDIENTE, G=6 SOLICITANTE, H=7 CEDULA, I=8 TELEFONO, K=10 FINCA, L=11 PLANO, M=12 AREA
                    for (let i = 1; i < data.length; i++) {
                        const row = data[i];
                        const expediente = row[0] ? String(row[0]).trim() : '';
                        if (expediente !== '') {
                            const solicitante = row[6] ? String(row[6]).trim() : '';
                            
                            expedientesDB[expediente] = {
                                recepcion: row[1] ? String(row[1]).trim() : '',
                                finca: row[10] ? String(row[10]).trim() : '',
                                plano: row[11] ? String(row[11]).trim() : '',
                                area: row[12] ? String(row[12]).trim() : '',
                                solicitante: solicitante,
                                cedula: row[7] ? String(row[7]).trim() : '',
                                telefono: row[8] ? String(row[8]).trim() : ''
                            };
                            
                            optionsHTML += `<option value="${expediente}">${expediente} - ${solicitante}</option>`;
                        }
                    }
                    
                    select.innerHTML = optionsHTML;

                    // Restaurar expediente fijado (si aplica)
                    try {
                        const lockEnabled = localStorage.getItem('pp01_expediente_locked') === '1';
                        const lockedId = localStorage.getItem('pp01_expediente_locked_id') || '';
                        if (lockEnabled && lockedId && expedientesDB[lockedId]) {
                            select.value = lockedId;
                            lockedExpedienteId = lockedId;
                            loadExpedienteData();
                            setExpedienteLockState(true, false);
                        } else {
                            setExpedienteLockState(false, false);
                        }
                    } catch(e) {}

                    // Si está fijado, mantener deshabilitado; si no, habilitar
                    select.disabled = expedienteLocked ? true : false;
                    console.log('Expedientes cargados:', Object.keys(expedientesDB).length);
                })
                .catch(error => {
                    console.error('Error cargando expedientes:', error);
                    select.innerHTML = '<option value="">Error al cargar datos</option>';
                    select.disabled = expedienteLocked ? true : false;
                });
        }
        
        
        // Normaliza fechas de expediente para mostrar SOLO la fecha (sin hora)
        function _pp01_dateOnly(v){
            if(v === null || v === undefined) return '';
            // Si viene como número (timestamp) o Date, lo convertimos
            try{
                if(typeof v === 'number'){
                    const dt = new Date(v);
                    return isNaN(dt.getTime()) ? String(v) : dt.toISOString().slice(0,10);
                }
                if(v instanceof Date){
                    return isNaN(v.getTime()) ? '' : v.toISOString().slice(0,10);
                }
            }catch(e){}
            // Convertir a string de forma segura
            let s = '';
            try{ s = String(v); }catch(e){ return ''; }
            s = s.trim();
            if(!s) return '';
            // ISO 8601: 2026-01-30T10:12:00Z
            if(s.includes('T')) return s.split('T')[0];
            // Formatos con espacio: 30/01/2026 10:12, 2026-01-30 10:12:00
            if(s.includes(' ')) return s.split(' ')[0];
            // Formatos con milisegundos: 2026-01-30.000Z
            if(s.includes('.')) return s.split('.')[0];
            // Si ya es fecha sin hora, devolver tal cual
            return s;
        }


        function loadExpedienteData(){
            const sel = document.getElementById('expediente_id');
            const id = sel ? (sel.value || '') : '';

            // Si el expediente está fijado, impedir cambios (incluye cambios programáticos)
            if(expedienteLocked && lockedExpedienteId && id !== lockedExpedienteId){
                if(sel) sel.value = lockedExpedienteId;
                alert('El expediente está fijado. Desfíjelo para cambiarlo.');
                return;
            }

            if(expedientesDB[id]){
                const d = expedientesDB[id];
                let fechaRecepcion = _pp01_dateOnly(d.recepcion || '');
                document.getElementById('fecha_recepcion').value = fechaRecepcion;
                document.getElementById('finca_num').value = d.finca;
                document.getElementById('plano_num').value = d.plano;
                document.getElementById('area_ha').value = d.area;
                document.getElementById('solicitante').value = d.solicitante;
                document.getElementById('cedula').value = d.cedula;
                document.getElementById('telefono').value = d.telefono;
                document.getElementById('data_fields').classList.remove('opacity-50');
                document.getElementById('found_msg').classList.remove('hidden');
                document.getElementById('not_found_msg').classList.add('hidden');
            }else{
                document.getElementById('data_fields').classList.add('opacity-50');
                document.getElementById('found_msg').classList.add('hidden');
                document.getElementById('not_found_msg').classList.remove('hidden');
                ['fecha_recepcion','finca_num','plano_num','area_ha','solicitante','cedula','telefono'].forEach(fid=>{
                    const el = document.getElementById(fid);
                    if(el) el.value = '';
                });
            }
        }
        let gpsIntervals={};
        // --- Conversión WGS84 ↔ CRTM05 (aprox. consistente con saveManualCoord) ---
        function wgs84ToCrtm05(lat, lon) {
            const norte = lat * 111319.9 + 1000000;
            const este = (lon + 84.0) * 111319.9 * Math.cos(lat * Math.PI / 180) + 500000;
            return { norte, este };
        }

        // --- GPS real con watchPosition + PROMEDIADO PONDERADO ---
        // Técnica profesional: acumula lecturas buenas y promedia ponderando por 1/accuracy²
        // Reduce error efectivo ~40-60% vs lectura única
        const gpsWatchIds = {};
        const gpsReadings = {};     // array de lecturas buenas por id
        const GPS_MAX_ACC = 25;     // descartar lecturas peores que 25m
        const GPS_MIN_READINGS = 3; // mínimo para promediar

        function _gpsWeightedAvg(readings) {
            // Promedio ponderado: peso = 1/accuracy² (lecturas más precisas pesan más)
            let wLat = 0, wLon = 0, wEle = 0, wSum = 0;
            let minAcc = Infinity;
            readings.forEach(r => {
                const w = 1 / (r.acc * r.acc);
                wLat += r.lat * w;
                wLon += r.lon * w;
                wEle += r.ele * w;
                wSum += w;
                if (r.acc < minAcc) minAcc = r.acc;
            });
            const avgLat = wLat / wSum;
            const avgLon = wLon / wSum;
            const avgEle = wEle / wSum;
            // Incertidumbre estimada: mejora con √n de lecturas buenas
            const effAcc = minAcc / Math.sqrt(Math.min(readings.length, 20));
            return { lat: avgLat, lon: avgLon, ele: avgEle, acc: effAcc, n: readings.length, bestAcc: minAcc };
        }

        function startGPS(id){
            document.getElementById(`btn_start_gps_${id}`).classList.add('hidden');
            document.getElementById(`btn_stop_gps_${id}`).classList.remove('hidden');
            document.getElementById(`map_overlay_${id}`).classList.add('hidden');
            document.getElementById(`gps_display_${id}`).classList.remove('hidden');

            const d = document.getElementById(`gps_display_${id}`);
            d.innerHTML=`<div class="bg-gray-50 border border-gray-300 rounded p-2 text-center shadow-inner"><div class="flex items-center justify-between mb-2 pb-2 border-b border-gray-200"><div class="flex items-center gap-2"><div class="gps-active-dot"></div><span id="gps_label_${id}" class="text-xs font-bold text-gray-700 animate-pulse">Buscando satélites...</span></div><div class="text-right"><span class="text-xs text-gray-500">Incertidumbre:</span><br><span id="gps_unc_${id}" class="text-lg font-mono font-bold text-red-600">± -- m</span></div></div><div class="grid grid-cols-2 gap-2 text-left mb-2"><div class="bg-white p-1 rounded border"><span class="text-[10px] text-gray-400 block uppercase">Norte (Y)</span><span id="gps_n_${id}" class="font-mono font-bold text-sm text-gray-800">---</span></div><div class="bg-white p-1 rounded border"><span class="text-[10px] text-gray-400 block uppercase">Este (X)</span><span id="gps_e_${id}" class="font-mono font-bold text-sm text-gray-800">---</span></div></div><div id="gps_avg_info_${id}" class="text-[10px] text-blue-600 font-bold mb-1 hidden"><i class="fas fa-layer-group mr-1"></i>Promediando: <span id="gps_avg_n_${id}">0</span> lecturas</div><div class="w-full bg-gray-200 rounded-full h-1"><div id="gps_bar_${id}" class="bg-red-500 h-1 rounded-full" style="width:5%;transition:width 0.5s"></div></div><div class="text-[10px] text-gray-400 mt-1 text-right">CR-SIRGAS / CRTM05 (EPSG:8908)</div></div>`;

            gpsReadings[id] = [];

            if (!("geolocation" in navigator)) {
                const u = document.getElementById(`gps_unc_${id}`);
                if (u) { u.textContent = 'GPS no disponible'; u.className = 'text-sm font-mono font-bold text-red-600'; }
                return;
            }

            gpsWatchIds[id] = navigator.geolocation.watchPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const acc = position.coords.accuracy;
                    const ele = position.coords.altitude || 0;

                    // Descartar lecturas muy malas
                    if (acc > GPS_MAX_ACC) {
                        const lbl = document.getElementById(`gps_label_${id}`);
                        if (lbl && gpsReadings[id].length === 0) lbl.textContent = `Precisión baja (±${Math.round(acc)}m), esperando...`;
                        return;
                    }

                    // Acumular lectura buena
                    gpsReadings[id].push({ lat, lon, ele, acc });

                    // Limitar a últimas 30 lecturas (ventana deslizante)
                    if (gpsReadings[id].length > 30) gpsReadings[id].shift();

                    // Calcular promedio ponderado
                    const avg = _gpsWeightedAvg(gpsReadings[id]);
                    const crtm = wgs84ToCrtm05(avg.lat, avg.lon);

                    // Actualizar dataset con el promediado
                    d.dataset.norte = crtm.norte.toFixed(2);
                    d.dataset.este = crtm.este.toFixed(2);
                    d.dataset.lat = avg.lat.toFixed(6);
                    d.dataset.lon = avg.lon.toFixed(6);
                    d.dataset.ele = String(Math.round(avg.ele));

                    // Actualizar UI
                    const p = avg.acc;
                    let c = "text-red-600", bC = "bg-red-500", w = "10%";
                    if (p < 12) { c = "text-yellow-600"; bC = "bg-yellow-500"; w = "40%"; }
                    if (p < 6)  { c = "text-amber-500";  bC = "bg-amber-500";  w = "65%"; }
                    if (p < 3)  { c = "text-green-600";  bC = "bg-green-600";  w = "100%"; }

                    const uEl = document.getElementById(`gps_unc_${id}`);
                    if (uEl) { uEl.textContent = `± ${p.toFixed(1)} m`; uEl.className = `text-lg font-mono font-bold ${c}`; }

                    const nEl = document.getElementById(`gps_n_${id}`);
                    if (nEl) nEl.textContent = crtm.norte.toFixed(2);

                    const eEl = document.getElementById(`gps_e_${id}`);
                    if (eEl) eEl.textContent = crtm.este.toFixed(2);

                    const bar = document.getElementById(`gps_bar_${id}`);
                    if (bar) { bar.className = `${bC} h-1 rounded-full`; bar.style.width = w; bar.style.transition = 'width 0.5s'; }

                    // Mostrar contador de promediado
                    const lbl = document.getElementById(`gps_label_${id}`);
                    if (lbl) {
                        if (avg.n < GPS_MIN_READINGS) lbl.textContent = 'Triangulando...';
                        else lbl.textContent = `Promediando (${avg.n} lecturas)`;
                    }
                    const avgInfo = document.getElementById(`gps_avg_info_${id}`);
                    const avgN = document.getElementById(`gps_avg_n_${id}`);
                    if (avgInfo && avg.n >= GPS_MIN_READINGS) {
                        avgInfo.classList.remove('hidden');
                        if (avgN) avgN.textContent = avg.n;
                    }
                },
                function(error) {
                    console.warn('GPS error (' + id + '):', error.message);
                    const uEl = document.getElementById(`gps_unc_${id}`);
                    if (uEl) { uEl.textContent = 'Error GPS'; uEl.className = 'text-sm font-mono font-bold text-red-600'; }
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }

        function stopGPS(id){
            // Detener watchPosition
            if (gpsWatchIds[id] !== undefined) {
                navigator.geolocation.clearWatch(gpsWatchIds[id]);
                delete gpsWatchIds[id];
            }
            // Limpiar interval viejo si existe (compat)
            if (gpsIntervals[id]) { clearInterval(gpsIntervals[id]); delete gpsIntervals[id]; }

            const b = document.getElementById(`btn_stop_gps_${id}`);
            const d = document.getElementById(`gps_display_${id}`);
            b.innerHTML = '<i class="fas fa-check mr-2"></i> Guardado';
            b.classList.remove('bg-red-100','text-red-700','hover:bg-red-200');
            b.classList.add('bg-green-600','text-white','hover:bg-green-700','cursor-not-allowed');
            b.disabled = true;
            document.getElementById(`btn_reset_gps_${id}`).classList.remove('hidden');
            const w = d.querySelector('.bg-gray-50');
            if (w) { w.classList.remove('bg-gray-50'); w.classList.add('bg-green-50'); w.classList.remove('border-gray-300'); w.classList.add('border-green-300'); }
            const dot = d.querySelector('.gps-active-dot');
            if (dot) dot.classList.add('hidden');
            const pulse = d.querySelector('.animate-pulse');
            if (pulse) {
                pulse.classList.remove('animate-pulse');
                const n = gpsReadings[id] ? gpsReadings[id].length : 0;
                pulse.textContent = n >= GPS_MIN_READINGS ? `FIJA (${n} lecturas prom.)` : 'COORDENADA FIJA';
            }
        }

        function resetGPS(id){
            // Detener watchPosition si aún corre
            if (gpsWatchIds[id] !== undefined) {
                navigator.geolocation.clearWatch(gpsWatchIds[id]);
                delete gpsWatchIds[id];
            }
            if (gpsIntervals[id]) { clearInterval(gpsIntervals[id]); delete gpsIntervals[id]; }
            delete gpsReadings[id];

            document.getElementById(`btn_start_gps_${id}`).classList.remove('hidden');
            const b = document.getElementById(`btn_stop_gps_${id}`);
            b.classList.add('hidden');
            b.classList.remove('bg-green-600','text-white','hover:bg-green-700','cursor-not-allowed');
            b.classList.add('bg-red-100','text-red-700','hover:bg-red-200');
            b.innerHTML = '<i class="fas fa-stop-circle mr-1"></i> Finalizar';
            b.disabled = false;
            document.getElementById(`btn_reset_gps_${id}`).classList.add('hidden');
            document.getElementById(`map_overlay_${id}`).classList.remove('hidden');
            const d = document.getElementById(`gps_display_${id}`);
            d.classList.add('hidden');
            d.innerHTML = '';
            d.dataset.norte = '';
            d.dataset.este = '';
            d.dataset.lat = '';
            d.dataset.lon = '';
        }
        function saveSimpleField(id){ document.getElementById(`input_${id}`).disabled=true; document.getElementById(`btn_save_${id}`).classList.add('hidden'); document.getElementById(`btn_edit_${id}`).classList.remove('hidden'); document.getElementById(`container_${id}`).classList.add('opacity-75'); updateSectionStatus(); }
        function editSimpleField(id){ document.getElementById(`input_${id}`).disabled=false; document.getElementById(`btn_save_${id}`).classList.remove('hidden'); document.getElementById(`btn_edit_${id}`).classList.add('hidden'); document.getElementById(`container_${id}`).classList.remove('opacity-75'); updateSectionStatus(); }
        function clearSimpleField(id){ document.getElementById(`input_${id}`).value=""; if(document.getElementById(`input_${id}`).disabled) editSimpleField(id); }
        function removeElement(id){ document.getElementById(id).remove(); updateDashboard(); updateSectionStatus(); }
        function toggleBlock(blockId, toggleBtn) {
            const content = document.getElementById(`content_${blockId}`);
            const toggle = toggleBtn || document.querySelector(`#${blockId} .block-toggle`);
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.style.maxHeight = content.scrollHeight + 'px';
                toggle.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
            }
        }
        function collapseBlock(blockId) {
            const content = document.getElementById(`content_${blockId}`);
            const toggle = document.querySelector(`#${blockId} .block-toggle`);
            if (content && !content.classList.contains('collapsed')) {
                content.classList.add('collapsed');
                if (toggle) toggle.classList.add('collapsed');
            }
        }
        function updateBlockSummary(type, id) {
            let summary = '';
            if (type === 't') { // Árbol
                const sp = document.getElementById(`sp_arbol_${id}`);
                if (sp && sp.value) {
                    const parts = sp.value.match(/\(([^)]+)\)/);
                    summary = parts ? parts[1].split('/')[0].trim() : sp.value.substring(0, 20);
                }
            } else if (type === 'w') { // Fuente
                const tipo = document.getElementById(`tipo_fuente_${id}`);
                summary = tipo && tipo.value ? tipo.value : 'Sin tipo';
            } else if (type === 'v') { // Vértice
                const obs = document.getElementById(`obs_vertice_${id}`);
                summary = obs && obs.value ? obs.value.substring(0, 20) : 'Sin observación';
            } else if (type === 'o') { // Observación
                const det = document.getElementById(`detalle_obs_${id}`);
                summary = det && det.value ? det.value.substring(0, 25) + '...' : 'Sin detalle';
            }
            const el = document.getElementById(`summary_${type}${id}`);
            if (el) el.textContent = summary || 'Sin datos';
        }
        function escapeCSV(s){ if(!s)return ''; s=String(s); if(s.includes(','))return '"'+s+'"'; return s; }
        function generateGPX(){ let g=`<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1"><metadata><name>Levantamiento Forestal ACOPAC</name></metadata>`; document.querySelectorAll('[id^="vertice_block_"]').forEach(b=>{ const id=b.id.split('_')[2]; const d=document.getElementById(`gps_display_v${id}`); const lat=d.dataset.lat||"0.0"; const lon=d.dataset.lon||"0.0"; if(lat!=="0.0") g+=`<wpt lat="${lat}" lon="${lon}"><name>Vértice ${document.getElementById(`num_vertice_${id}`).value}</name><sym>Flag, Blue</sym></wpt>`; }); document.querySelectorAll('[id^="arbol_"][data-saved="true"]').forEach(b=>{ const id=b.id.split('_')[1]; const d=document.getElementById(`gps_display_t${id}`); const lat=d.dataset.lat||"0.0"; const lon=d.dataset.lon||"0.0"; if(lat!=="0.0") g+=`<wpt lat="${lat}" lon="${lon}"><name>Árbol ${document.getElementById(`num_arbol_${id}`).value}</name><sym>Tree</sym></wpt>`; }); g+=`</gpx>`; return g; }
        function generateCSV(){ let c="Tipo,Numero,Desc,N,E,Vol\n"; document.querySelectorAll('[id^="arbol_"][data-saved="true"]').forEach(b=>{ const id=b.id.split('_')[1]; const d=document.getElementById(`gps_display_t${id}`); const n=d.dataset.norte||""; const e=d.dataset.este||""; const num=document.getElementById(`num_arbol_${id}`).value; const vol=document.getElementById(`res_volumen_${id}`).innerText.replace(' m3',''); c+=`Arbol,${num},,${n},${e},${vol}\n`; }); return c; }
        function addAsistente(){ let c=document.querySelectorAll('[id^="container_asistente_extra_"]').length; const id='asistente_extra_'+c; const d=document.createElement('div'); d.className='repeat-block p-4 border border-gray-200 relative mb-4 shadow-sm'; d.id='container_'+id; d.innerHTML=`<div class="flex justify-between items-center mb-2"><label class="font-bold text-gray-700">Asistente ${c+2} (Adicional)</label><div class="flex items-center gap-3"><button onclick="saveSimpleField('${id}')" id="btn_save_${id}" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded shadow-sm transition-colors" title="Guardar"><i class="fas fa-save fa-lg"></i></button><button onclick="editSimpleField('${id}')" id="btn_edit_${id}" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 px-3 py-2 rounded shadow-sm transition-colors hidden" title="Editar"><i class="fas fa-edit fa-lg"></i></button><button onclick="removeElement('container_${id}')" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded shadow-sm transition-colors" title="Borrar"><i class="fas fa-trash fa-lg"></i></button></div></div><input type="text" id="input_${id}" class="input-field" placeholder="Nombre">`; document.getElementById('container_asistentes_extras').appendChild(d); }
        function addAcompanante(){ let c=document.querySelectorAll('[id^="acompanante_"]').length+1; const d=document.createElement('div'); d.className='repeat-block p-4 border border-gray-200 relative mb-4 shadow-sm'; d.id='acompanante_'+c; d.innerHTML=`<div class="flex justify-between items-center mb-4 bg-gray-50 p-2 rounded border-b border-gray-200"><div class="flex items-center gap-2"><label class="font-bold text-gray-700 text-sm">Acompañante ${c}</label></div><div class="flex items-center gap-3"><button onclick="saveAcompananteData(${c})" id="btn_save_acomp_${c}" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded shadow-sm transition-colors" title="Guardar"><i class="fas fa-save fa-lg"></i></button><button onclick="editAcompananteData(${c})" id="btn_edit_acomp_${c}" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 px-3 py-2 rounded shadow-sm transition-colors hidden" title="Editar"><i class="fas fa-edit fa-lg"></i></button><button onclick="removeElement('${d.id}')" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded shadow-sm transition-colors" title="Borrar"><i class="fas fa-trash fa-lg"></i></button></div></div><div id="fields_acomp_${c}" class="transition-opacity"><div class="grid grid-cols-1 md:grid-cols-2 gap-3"><div><label class="block text-sm font-medium text-gray-700">Nombre</label><input type="text" class="input-field" placeholder="Nombre completo"></div><div><label class="block text-sm font-medium text-gray-700">Cédula</label><input type="text" class="input-field" placeholder="Cédula"></div></div></div>`; document.getElementById('container_acompanantes').appendChild(d); }
        function saveAcompananteData(id){ const f=document.getElementById(`fields_acomp_${id}`); f.querySelectorAll('input').forEach(e=>e.disabled=true); document.getElementById(`btn_save_acomp_${id}`).classList.add('hidden'); document.getElementById(`btn_edit_acomp_${id}`).classList.remove('hidden'); f.classList.add('opacity-75'); updateSectionStatus(); }
        function editAcompananteData(id){ const f=document.getElementById(`fields_acomp_${id}`); f.querySelectorAll('input').forEach(e=>e.disabled=false); document.getElementById(`btn_save_acomp_${id}`).classList.remove('hidden'); document.getElementById(`btn_edit_acomp_${id}`).classList.add('hidden'); f.classList.remove('opacity-75'); updateSectionStatus(); }
        function addObservacion(){ let c=document.querySelectorAll('[id^="obs_final_"]').length+1; const blockId='obs_final_'+c; const d=document.createElement('div'); d.className='repeat-block border border-gray-200 relative mb-4 shadow-sm rounded-lg'; d.id=blockId; const id='o'+c; d.innerHTML=`<div class="block-header" onclick="toggleBlock('${blockId}', this.querySelector('.block-toggle'))"><div class="block-header-left"><span class="block-number text-gray-700"><i class="fas fa-clipboard-list mr-2 text-purple-500"></i>Observación #${c}</span><span class="block-summary" id="summary_o${c}">Sin detalle</span><span class="block-status pending" id="status_o${c}">Pendiente</span></div><div class="block-header-right"><button class="block-toggle" onclick="event.stopPropagation()"><i class="fas fa-chevron-down"></i></button></div></div><div id="content_${blockId}" class="block-content p-4" style="max-height: 1500px;"><div id="fields_obs_${c}" class="transition-opacity"><div class="mb-3"><textarea id="detalle_obs_${c}" class="input-field" rows="3" placeholder="Detalle..." onchange="updateBlockSummary('o',${c})"></textarea></div><div class="mb-3 border-t border-gray-100 pt-2"><label class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label><div class="flex gap-2 mb-3"><button type="button" onclick="toggleCoordMode('${id}','gps')" id="btn_mode_gps_${id}" class="flex-1 py-2 px-3 rounded-l-lg font-semibold text-sm bg-blue-600 text-white border-2 border-blue-600"><i class="fas fa-satellite-dish mr-1"></i> GPS Auto</button><button type="button" onclick="toggleCoordMode('${id}','manual')" id="btn_mode_manual_${id}" class="flex-1 py-2 px-3 rounded-r-lg font-semibold text-sm bg-gray-100 text-gray-600 border-2 border-gray-300"><i class="fas fa-edit mr-1"></i> Manual</button></div><div id="coord_gps_${id}"><div class="flex gap-2 mb-2"><button onclick="startGPS('${id}')" id="btn_start_gps_${id}" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-2 rounded w-1/3 flex items-center justify-center text-sm"><i class="fas fa-satellite-dish mr-1"></i> Iniciar</button><button onclick="stopGPS('${id}')" id="btn_stop_gps_${id}" class="bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-3 px-2 rounded w-1/3 flex items-center justify-center text-sm hidden"><i class="fas fa-stop-circle mr-1"></i> Finalizar</button><button onclick="resetGPS('${id}')" id="btn_reset_gps_${id}" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 font-semibold py-3 px-2 rounded w-1/3 flex items-center justify-center text-sm hidden"><i class="fas fa-redo mr-1"></i> Reiniciar</button></div><div class="relative"><div id="map_overlay_${id}" class="map-preview text-gray-500 z-0"><div class="map-overlay"><i class="fas fa-map mb-1 text-2xl"></i><span class="text-xs">Esperando señal...</span></div></div><div id="gps_display_${id}" class="relative z-10 hidden pt-2"></div></div></div><div id="coord_manual_${id}" class="hidden"><div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-3"><div class="text-xs text-amber-700 mb-2 font-semibold"><i class="fas fa-info-circle mr-1"></i> Ingrese coordenadas CR-SIRGAS / CRTM05 (EPSG:8908)</div><div class="grid grid-cols-2 gap-3 mb-3"><div><label class="block text-xs font-bold text-gray-600 mb-1">Norte (Y)</label><input type="text" id="manual_norte_${id}" class="input-field text-sm py-2" placeholder="Ej: 1095200.00"></div><div><label class="block text-xs font-bold text-gray-600 mb-1">Este (X)</label><input type="text" id="manual_este_${id}" class="input-field text-sm py-2" placeholder="Ej: 445300.00"></div></div><div class="grid grid-cols-1 gap-3 mb-3">
    <div>
        <label class="block text-xs font-bold text-gray-600 mb-1">Incertidumbre (m)</label>
        <input type="number" id="manual_incertidumbre_${id}" class="input-field text-sm py-2" placeholder="Ej: 5.0" step="0.1" min="0.1" value="5.0">
        <span class="text-xs text-gray-500">Incertidumbre del dispositivo GPS (metros)</span>
    </div>
</div><button type="button" onclick="saveManualCoord('${id}')" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded text-sm"><i class="fas fa-check mr-1"></i> Guardar Coordenadas</button></div></div></div><div class="mb-3 border-t border-gray-100 pt-2"><div id="photos_container_obs_${c}" class="grid grid-cols-2 gap-2 mb-2"></div><button onclick="addObservacionPhoto(${c})" class="bg-gray-200 text-gray-700 py-2 px-3 rounded w-full text-sm font-bold hover:bg-gray-300 flex items-center justify-center gap-2"><i class="fas fa-camera"></i> Agregar Foto</button></div></div><div class="mt-4 pt-3 border-t border-gray-100 flex gap-2"><button onclick="saveObservacionData(${c})" id="btn_save_obs_${c}" class="bg-blue-100 text-blue-700 py-3 px-4 rounded flex-1 font-bold">Guardar</button><button onclick="editObservacionData(${c})" id="btn_edit_obs_${c}" class="bg-yellow-100 text-yellow-700 py-3 px-4 rounded hidden font-bold">Editar</button><button onclick="removeElement('${blockId}')" class="bg-red-100 hover:bg-red-200 text-red-700 py-3 px-4 rounded font-bold">Borrar</button></div><button class="btn-collapse-bottom" onclick="collapseBlockFromBottom('${blockId}')"><i class="fas fa-chevron-up"></i> Cerrar</button></div>`; document.getElementById('container_obs_finales').appendChild(d); updateSectionStatus(); }
        function addObservacionPhoto(oid){ const c=document.getElementById(`photos_container_obs_${oid}`); const pc=c.children.length+1; const iid=`input_obs_${oid}_${pc}`; const bid=`btn_obs_${oid}_${pc}`; const d=document.createElement('div'); d.innerHTML=`<input type="file" accept="image/*" capture="environment" id="${iid}" class="hidden" onchange="photoSelected(this,'${bid}')"><div class="btn-camera h-24 flex items-center justify-center" id="${bid}" onclick="triggerCamera('${iid}')"><div class="text-center"><i class="fas fa-plus fa-lg"></i><br><span class="text-xs">Foto ${pc}</span></div></div>`; c.appendChild(d); }
        function saveObservacionData(id){ if(!inspeccionIniciada){ alert('Debe iniciar la inspección primero presionando el botón "Iniciar".'); return; } document.getElementById('obs_final_'+id).dataset.saved="true"; const f=document.getElementById(`fields_obs_${id}`); f.querySelectorAll('textarea, button, input').forEach(e=>e.disabled=true); document.getElementById(`btn_save_obs_${id}`).classList.add('hidden'); document.getElementById(`btn_edit_obs_${id}`).classList.remove('hidden'); f.classList.add('opacity-75'); document.getElementById(`status_o${id}`).className='block-status saved'; document.getElementById(`status_o${id}`).textContent='Guardado'; collapseBlock('obs_final_'+id); updateSectionStatus(); }
        function editObservacionData(id){ delete document.getElementById('obs_final_'+id).dataset.saved; const f=document.getElementById(`fields_obs_${id}`); f.querySelectorAll('textarea, button, input').forEach(e=>e.disabled=false); document.getElementById(`btn_save_obs_${id}`).classList.remove('hidden'); document.getElementById(`btn_edit_obs_${id}`).classList.add('hidden'); f.classList.remove('opacity-75'); document.getElementById(`status_o${id}`).className='block-status pending'; document.getElementById(`status_o${id}`).textContent='Pendiente'; updateSectionStatus(); }
        let countVertices=0;
        function addVertice(){ countVertices++; const id='v'+countVertices; const blockId='vertice_block_'+countVertices; const d=document.createElement('div'); d.className='repeat-block border border-gray-200 relative mb-4 shadow-sm rounded-lg'; d.id=blockId; const cid=`cam_vertice_${countVertices}`; const bid=`btn_cam_vertice_${countVertices}`; d.innerHTML=`<div class="block-header" onclick="toggleBlock('${blockId}', this.querySelector('.block-toggle'))"><div class="block-header-left"><span class="block-number"><i class="fas fa-map-marker-alt mr-2 text-orange-400"></i>Vértice #<span id="num_display_v${countVertices}">${countVertices}</span></span><span class="block-summary" id="summary_v${countVertices}">Sin coordenadas</span><span class="block-status pending" id="status_v${countVertices}">Pendiente</span></div><div class="block-header-right"><button class="block-toggle" onclick="event.stopPropagation()"><i class="fas fa-chevron-down"></i></button></div></div><div id="content_${blockId}" class="block-content p-4" style="max-height: 1500px;"><div id="fields_vertice_${countVertices}" class="transition-opacity"><div class="mb-3"><label class="block text-sm font-medium text-gray-700">Número de Vértice</label><input type="number" id="num_vertice_${countVertices}" class="input-field" value="${countVertices}" min="1" oninput="updateNumDisplay('v',${countVertices})"></div><div class="mb-3"><label class="block text-sm font-medium text-gray-700">Observación (Opcional)</label><input type="text" id="obs_vertice_${countVertices}" class="input-field" onchange="updateBlockSummary('v',${countVertices})"></div><div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-1">Capturar Coordenada</label><div class="flex gap-2 mb-3"><button type="button" onclick="toggleCoordMode('${id}','gps')" id="btn_mode_gps_${id}" class="flex-1 py-2 px-3 rounded-l-lg font-semibold text-sm bg-blue-600 text-white border-2 border-blue-600"><i class="fas fa-satellite-dish mr-1"></i> GPS Auto</button><button type="button" onclick="toggleCoordMode('${id}','manual')" id="btn_mode_manual_${id}" class="flex-1 py-2 px-3 rounded-r-lg font-semibold text-sm bg-gray-100 text-gray-600 border-2 border-gray-300"><i class="fas fa-edit mr-1"></i> Manual</button></div><div id="coord_gps_${id}"><div class="flex gap-2 mb-2"><button onclick="startGPS('${id}')" id="btn_start_gps_${id}" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-2 rounded w-1/3 flex items-center justify-center text-sm"><i class="fas fa-satellite-dish mr-1"></i> Iniciar</button><button onclick="stopGPS('${id}')" id="btn_stop_gps_${id}" class="bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-3 px-2 rounded w-1/3 flex items-center justify-center text-sm hidden"><i class="fas fa-stop-circle mr-1"></i> Finalizar</button><button onclick="resetGPS('${id}')" id="btn_reset_gps_${id}" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 font-semibold py-3 px-2 rounded w-1/3 flex items-center justify-center text-sm hidden"><i class="fas fa-redo mr-1"></i> Reiniciar</button></div><div class="relative"><div id="map_overlay_${id}" class="map-preview text-gray-500 z-0"><div class="map-overlay"><i class="fas fa-map mb-1 text-2xl"></i><span class="text-xs">Esperando señal...</span></div></div><div id="gps_display_${id}" class="relative z-10 hidden pt-2"></div></div></div><div id="coord_manual_${id}" class="hidden"><div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-3"><div class="text-xs text-amber-700 mb-2 font-semibold"><i class="fas fa-info-circle mr-1"></i> Ingrese coordenadas CR-SIRGAS / CRTM05 (EPSG:8908)</div><div class="grid grid-cols-2 gap-3 mb-3"><div><label class="block text-xs font-bold text-gray-600 mb-1">Norte (Y)</label><input type="text" id="manual_norte_${id}" class="input-field text-sm py-2" placeholder="Ej: 1095200.00"></div><div><label class="block text-xs font-bold text-gray-600 mb-1">Este (X)</label><input type="text" id="manual_este_${id}" class="input-field text-sm py-2" placeholder="Ej: 445300.00"></div></div><div class="grid grid-cols-1 gap-3 mb-3">
    <div>
        <label class="block text-xs font-bold text-gray-600 mb-1">Incertidumbre (m)</label>
        <input type="number" id="manual_incertidumbre_${id}" class="input-field text-sm py-2" placeholder="Ej: 5.0" step="0.1" min="0.1" value="5.0">
        <span class="text-xs text-gray-500">Incertidumbre del dispositivo GPS (metros)</span>
    </div>
</div><button type="button" onclick="saveManualCoord('${id}')" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded text-sm"><i class="fas fa-check mr-1"></i> Guardar Coordenadas</button></div></div></div><div class="mb-3"><input type="file" accept="image/*" capture="environment" id="${cid}" class="hidden" onchange="photoSelected(this,'${bid}')"><div class="btn-camera" id="${bid}" onclick="triggerCamera('${cid}')"><i class="fas fa-camera fa-2x"></i><br>Tomar Foto</div></div></div><div class="mt-4 pt-3 border-t border-gray-100 flex gap-2"><button onclick="saveVerticeData(${countVertices})" id="btn_save_vertice_${countVertices}" class="bg-blue-100 hover:bg-blue-200 text-blue-700 py-3 px-4 rounded flex-1 font-bold">Guardar</button><button onclick="editVerticeData(${countVertices})" id="btn_edit_vertice_${countVertices}" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 py-3 px-4 rounded hidden font-bold">Editar</button><button onclick="removeElement('${blockId}')" class="bg-red-100 hover:bg-red-200 text-red-700 py-3 px-4 rounded font-bold">Borrar</button></div><button class="btn-collapse-bottom" onclick="collapseBlockFromBottom('${blockId}')"><i class="fas fa-chevron-up"></i> Cerrar</button></div>`; document.getElementById('container_vertices').appendChild(d); updateSectionStatus(); }
        function saveVerticeData(id){ if(!inspeccionIniciada){ alert('Debe iniciar la inspección primero presionando el botón "Iniciar".'); return; } document.getElementById('vertice_block_'+id).dataset.saved="true"; const f=document.getElementById(`fields_vertice_${id}`); f.querySelectorAll('input, button').forEach(e=>e.disabled=true); document.getElementById(`num_vertice_${id}`).disabled=true; document.getElementById(`btn_save_vertice_${id}`).classList.add('hidden'); document.getElementById(`btn_edit_vertice_${id}`).classList.remove('hidden'); f.classList.add('opacity-75'); document.getElementById(`status_v${id}`).className='block-status saved'; document.getElementById(`status_v${id}`).textContent='Guardado'; collapseBlock('vertice_block_'+id); updateSectionStatus(); }
        function editVerticeData(id){ delete document.getElementById('vertice_block_'+id).dataset.saved; const f=document.getElementById(`fields_vertice_${id}`); f.querySelectorAll('input, button').forEach(e=>e.disabled=false); document.getElementById(`num_vertice_${id}`).disabled=false; document.getElementById(`btn_save_vertice_${id}`).classList.remove('hidden'); document.getElementById(`btn_edit_vertice_${id}`).classList.add('hidden'); f.classList.remove('opacity-75'); document.getElementById(`status_v${id}`).className='block-status pending'; document.getElementById(`status_v${id}`).textContent='Pendiente'; updateSectionStatus(); }
        let countFuentes=0;
        function addFuente(){ countFuentes++; const id='w'+countFuentes; const blockId='fuente_block_'+countFuentes; const d=document.createElement('div'); d.className='repeat-block border border-blue-200 relative mb-4 shadow-sm rounded-lg'; d.id=blockId; const cid=`cam_fuente_${countFuentes}`; const bid=`btn_cam_fuente_${countFuentes}`; d.innerHTML=`<div class="block-header" onclick="toggleBlock('${blockId}', this.querySelector('.block-toggle'))"><div class="block-header-left"><span class="block-number text-blue-700"><i class="fas fa-water mr-2 text-blue-500"></i>Fuente #<span id="num_display_w${countFuentes}">${countFuentes}</span></span><span class="block-summary" id="summary_w${countFuentes}">Sin tipo</span><span class="block-status pending" id="status_w${countFuentes}">Pendiente</span></div><div class="block-header-right"><button class="block-toggle" onclick="event.stopPropagation()"><i class="fas fa-chevron-down"></i></button></div></div><div id="content_${blockId}" class="block-content p-4" style="max-height: 1500px;"><input type="hidden" id="num_fuente_${countFuentes}" value="${countFuentes}"><div id="fields_fuente_${countFuentes}" class="transition-opacity"><div class="mb-3"><label class="block text-sm font-medium text-gray-700">Tipo</label><select id="tipo_fuente_${countFuentes}" class="input-field" onchange="updateBlockSummary('w',${countFuentes})"><option value="">Seleccione...</option><option value="Naciente">Naciente</option><option value="Cauce">Cauce</option><option value="Lago/Laguna">Lago/Laguna</option><option value="Otro">Otro</option></select></div><div class="mb-3"><label class="block text-sm font-medium text-gray-700">Observación (Opcional)</label><input type="text" class="input-field"></div><div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label><div class="flex gap-2 mb-3"><button type="button" onclick="toggleCoordMode('${id}','gps')" id="btn_mode_gps_${id}" class="flex-1 py-2 px-3 rounded-l-lg font-semibold text-sm bg-blue-600 text-white border-2 border-blue-600"><i class="fas fa-satellite-dish mr-1"></i> GPS Auto</button><button type="button" onclick="toggleCoordMode('${id}','manual')" id="btn_mode_manual_${id}" class="flex-1 py-2 px-3 rounded-r-lg font-semibold text-sm bg-gray-100 text-gray-600 border-2 border-gray-300"><i class="fas fa-edit mr-1"></i> Manual</button></div><div id="coord_gps_${id}"><div class="flex gap-2 mb-2"><button onclick="startGPS('${id}')" id="btn_start_gps_${id}" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-2 rounded w-1/3 text-sm">Iniciar</button><button onclick="stopGPS('${id}')" id="btn_stop_gps_${id}" class="bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-3 px-2 rounded w-1/3 text-sm hidden">Finalizar</button><button onclick="resetGPS('${id}')" id="btn_reset_gps_${id}" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 font-semibold py-3 px-2 rounded w-1/3 text-sm hidden"><i class="fas fa-redo mr-1"></i> Reiniciar</button></div><div class="relative"><div id="map_overlay_${id}" class="map-preview text-gray-500 z-0"><div class="map-overlay"><i class="fas fa-map mb-1 text-2xl"></i><span class="text-xs">Esperando señal...</span></div></div><div id="gps_display_${id}" class="relative z-10 hidden pt-2"></div></div></div><div id="coord_manual_${id}" class="hidden"><div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-3"><div class="text-xs text-amber-700 mb-2 font-semibold"><i class="fas fa-info-circle mr-1"></i> Ingrese coordenadas CR-SIRGAS / CRTM05 (EPSG:8908)</div><div class="grid grid-cols-2 gap-3 mb-3"><div><label class="block text-xs font-bold text-gray-600 mb-1">Norte (Y)</label><input type="text" id="manual_norte_${id}" class="input-field text-sm py-2" placeholder="Ej: 1095200.00"></div><div><label class="block text-xs font-bold text-gray-600 mb-1">Este (X)</label><input type="text" id="manual_este_${id}" class="input-field text-sm py-2" placeholder="Ej: 445300.00"></div></div><div class="grid grid-cols-1 gap-3 mb-3">
    <div>
        <label class="block text-xs font-bold text-gray-600 mb-1">Incertidumbre (m)</label>
        <input type="number" id="manual_incertidumbre_${id}" class="input-field text-sm py-2" placeholder="Ej: 5.0" step="0.1" min="0.1" value="5.0">
        <span class="text-xs text-gray-500">Incertidumbre del dispositivo GPS (metros)</span>
    </div>
</div><button type="button" onclick="saveManualCoord('${id}')" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded text-sm"><i class="fas fa-check mr-1"></i> Guardar Coordenadas</button></div></div></div><div class="mb-3"><input type="file" accept="image/*" capture="environment" id="${cid}" class="hidden" onchange="photoSelected(this,'${bid}')"><div class="btn-camera" id="${bid}" onclick="triggerCamera('${cid}')"><i class="fas fa-camera fa-2x"></i><br>Tomar Foto</div></div></div><div class="mt-4 pt-3 border-t border-gray-100 flex gap-2"><button onclick="saveFuenteData(${countFuentes})" id="btn_save_fuente_${countFuentes}" class="bg-blue-100 text-blue-700 py-3 px-4 rounded flex-1 font-bold">Guardar</button><button onclick="editFuenteData(${countFuentes})" id="btn_edit_fuente_${countFuentes}" class="bg-yellow-100 text-yellow-700 py-3 px-4 rounded hidden font-bold">Editar</button><button onclick="removeElement('${blockId}')" class="bg-red-100 text-red-700 py-3 px-4 rounded font-bold">Borrar</button></div><button class="btn-collapse-bottom" onclick="collapseBlockFromBottom('${blockId}')"><i class="fas fa-chevron-up"></i> Cerrar</button></div>`; document.getElementById('container_agua').appendChild(d); updateSectionStatus(); }
        function saveFuenteData(id){ if(!inspeccionIniciada){ alert('Debe iniciar la inspección primero presionando el botón "Iniciar".'); return; } const f=document.getElementById(`fields_fuente_${id}`); f.querySelectorAll('input, select, textarea, button').forEach(e=>e.disabled=true); document.getElementById(`num_fuente_${id}`).disabled=true; document.getElementById(`btn_save_fuente_${id}`).classList.add('hidden'); document.getElementById(`btn_edit_fuente_${id}`).classList.remove('hidden'); f.classList.add('opacity-75'); document.getElementById(`status_w${id}`).className='block-status saved'; document.getElementById(`status_w${id}`).textContent='Guardado'; collapseBlock('fuente_block_'+id); updateSectionStatus(); }
        function editFuenteData(id){ const f=document.getElementById(`fields_fuente_${id}`); f.querySelectorAll('input, select, textarea, button').forEach(e=>e.disabled=false); document.getElementById(`num_fuente_${id}`).disabled=false; document.getElementById(`btn_save_fuente_${id}`).classList.remove('hidden'); document.getElementById(`btn_edit_fuente_${id}`).classList.add('hidden'); f.classList.remove('opacity-75'); document.getElementById(`status_w${id}`).className='block-status pending'; document.getElementById(`status_w${id}`).textContent='Pendiente'; updateSectionStatus(); }
        let countArboles=0;
        function addArbol(){ countArboles++; const id='t'+countArboles; const blockId='arbol_'+countArboles; const d=document.createElement('div'); d.className='repeat-block border border-green-200 relative mb-4 shadow-sm rounded-lg'; d.id=blockId; const cid1=`cam_arbol_${countArboles}_1`; const cid2=`cam_arbol_${countArboles}_2`; const cid3=`cam_arbol_${countArboles}_3`; const bid1=`btn_cam_arbol_${countArboles}_1`; const bid2=`btn_cam_arbol_${countArboles}_2`; const bid3=`btn_cam_arbol_${countArboles}_3`; d.innerHTML=`<div class="block-header" onclick="toggleBlock('${blockId}', this.querySelector('.block-toggle'))"><div class="block-header-left"><span class="block-number"><i class="fas fa-tree mr-2 text-green-400"></i>Árbol #<span id="num_display_t${countArboles}">${countArboles}</span></span><span class="block-summary" id="summary_t${countArboles}">Sin especie</span><span class="block-status pending" id="status_t${countArboles}">Pendiente</span></div><div class="block-header-right"><button class="block-toggle" onclick="event.stopPropagation()"><i class="fas fa-chevron-down"></i></button></div></div><div id="content_${blockId}" class="block-content p-4" style="max-height: 3000px;"><div id="fields_arbol_${countArboles}" class="transition-opacity"><div class="mb-3"><label class="block text-sm font-medium text-gray-700">Número de Árbol</label><input type="number" id="num_arbol_${countArboles}" class="input-field" value="${countArboles}" min="1" oninput="updateNumDisplay('t',${countArboles})"></div><div class="mb-4 pb-4 border-b border-gray-200"><h6 class="text-xs font-bold text-gray-500 uppercase mb-2">Contexto / Uso del Suelo</h6><div class="mb-3"><label class="block text-sm font-medium text-gray-700">Uso del suelo</label><select id="tipo_uso_arbol_${countArboles}" class="input-field" onchange="toggleUsoSueloArbol(${countArboles})"><option value="">Seleccione...</option><option value="agropecuario">Agropecuario</option><option value="urbano">Urbano</option><option value="regeneracion">Regeneración natural</option><option value="parche">Ecosistema boscoso</option><option value="agroforestal">Sistema agroforestal</option><option value="plantacion">Plantación forestal</option><option value="otro">Otro</option></select></div><div id="field_sp_agronomicas_${countArboles}" class="mb-3 hidden-field bg-yellow-50 p-2 rounded border border-yellow-100"><label class="block text-sm font-medium text-gray-700">Especies agronómicas</label><input type="text" class="input-field" placeholder="Ej: Café..."></div><div id="field_uso_otro_${countArboles}" class="mb-3 hidden-field bg-purple-50 p-2 rounded border border-purple-100"><label class="block text-sm font-medium text-gray-700">Especifique el uso del suelo</label><input type="text" id="input_uso_otro_${countArboles}" class="input-field" placeholder="Describa el uso del suelo..."></div><div class="mb-3"><label class="block text-sm font-medium text-gray-700">Observaciones contexto</label><textarea class="input-field" rows="1"></textarea></div><div class="mb-3"><label class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-mountain mr-1 text-gray-500"></i> Inclinación del terreno</label><div class="flex gap-1 mb-2"><button type="button" onclick="toggleSlopeMode(${countArboles},'pct')" id="btn_slope_pct_${countArboles}" class="flex-1 py-2 px-1 rounded-l-lg font-semibold text-xs bg-green-600 text-white border-2 border-green-600"><i class="fas fa-percent mr-1"></i>%</button><button type="button" onclick="toggleSlopeMode(${countArboles},'deg')" id="btn_slope_deg_${countArboles}" class="flex-1 py-2 px-1 font-semibold text-xs bg-gray-100 text-gray-600 border-2 border-gray-300"><i class="fas fa-compass mr-1"></i>Grados</button><button type="button" onclick="toggleSlopeMode(${countArboles},'calc')" id="btn_slope_calc_${countArboles}" class="flex-1 py-2 px-1 font-semibold text-xs bg-gray-100 text-gray-600 border-2 border-gray-300"><i class="fas fa-calculator mr-1"></i>Calc.</button><button type="button" onclick="toggleSlopeMode(${countArboles},'clino')" id="btn_slope_clino_${countArboles}" class="flex-1 py-2 px-1 rounded-r-lg font-semibold text-xs bg-gray-100 text-gray-600 border-2 border-gray-300"><i class="fas fa-mobile-alt mr-1"></i>Clinóm.</button></div><div id="slope_pct_${countArboles}"><input type="number" id="val_slope_pct_${countArboles}" class="input-field" placeholder="Ej: 25" step="0.1" oninput="updateSlopeResult(${countArboles},'pct')"><span class="text-xs text-gray-500">Ingrese directamente en %</span></div><div id="slope_deg_${countArboles}" class="hidden"><input type="number" id="val_slope_deg_${countArboles}" class="input-field" placeholder="Ej: 14" step="0.1" oninput="updateSlopeResult(${countArboles},'deg')"><span class="text-xs text-gray-500">Ingrese en grados (°)</span></div><div id="slope_calc_${countArboles}" class="hidden bg-blue-50 p-2 rounded border border-blue-200"><div class="grid grid-cols-2 gap-2 mb-2"><div><label class="text-xs text-gray-600">Distancia (m)</label><input type="number" id="val_slope_dist_${countArboles}" class="input-field text-sm py-2" placeholder="Dist." step="0.1" oninput="updateSlopeResult(${countArboles},'calc')"></div><div><label class="text-xs text-gray-600">Altura (m)</label><input type="number" id="val_slope_alt_${countArboles}" class="input-field text-sm py-2" placeholder="Alt." step="0.1" oninput="updateSlopeResult(${countArboles},'calc')"></div></div><span class="text-xs text-blue-600"><i class="fas fa-info-circle mr-1"></i>% = (Altura / Distancia) × 100</span></div><div id="slope_clino_${countArboles}" class="hidden bg-purple-50 p-3 rounded border-2 border-purple-200 text-center"><div class="text-purple-700 mb-2"><i class="fas fa-mobile-alt fa-2x mb-2"></i><div class="font-bold">Clinómetro Digital</div></div><button type="button" onclick="openClinometer(${countArboles})" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-sm"><i class="fas fa-mountain mr-1"></i> Iniciar Medición</button><div class="text-xs text-purple-500 mt-2"><i class="fas fa-info-circle mr-1"></i>Coloque el teléfono paralelo al terreno</div></div><div id="slope_result_${countArboles}" class="mt-2 text-center p-2 bg-gray-100 rounded border hidden"><span class="text-sm font-bold text-gray-700">Pendiente: </span><span id="slope_value_${countArboles}" class="text-lg font-bold text-green-700">0.0</span><span class="text-sm font-bold text-gray-700"> %</span></div></div></div><div class="mb-4"><label class="block text-sm font-bold mb-1">Nombre Científico</label><div class="species-autocomplete">
  <div class="flex flex-col gap-2">
    <div class="min-w-0">
      <input type="text" id="sp_arbol_${countArboles}" class="input-field"
        oninput="checkSpecies(${countArboles}); updateBlockSummary('t',${countArboles})"
        placeholder="Escriba para buscar...">
      <div id="suggestions_${countArboles}" class="species-suggestions"></div>
    </div>

    <!-- Pl@ntNet IA (sutil, debajo del campo) -->
    <div>
      <input type="file" id="plantnet_file_${countArboles}" accept="image/*" capture="environment" class="hidden"
        onchange="handlePlantNetIdentification(event, ${countArboles})">

      <button type="button"
        class="w-full rounded-lg border-2 border-gray-800 bg-gray-100 text-gray-900 font-bold"
        style="height:52px; box-shadow:none;"
        onclick="(function(){const f=document.getElementById('plantnet_file_${countArboles}'); if(f){ f.value=''; f.click(); }})();">
        📷 Identificar con IA (Pl@ntNet)
      </button>

      <div class="text-xs text-gray-700 mt-1" style="line-height:1.2;">
        Foto de hojas/flores/fruto mejora la precisión.
      </div>
    </div>
  </div>
</div><div class="mt-3 p-3 bg-emerald-50 border-3 border-emerald-200 rounded-lg"><div class="grid grid-cols-2 gap-3 mt-3">
    <div>
      <label class="block text-sm font-bold mb-1"> % Certeza (Pl@ntNet)</label>
      <input type="number" id="plantnet_score_${countArboles}" class="input-field read-only" readonly placeholder="0" step="0.1">
    </div>
    <div>
      <label class="block text-sm font-bold mb-1">Estado IA</label>
      <div id="plantnet_status_${countArboles}" class="input-field read-only" style="display:flex;align-items:center;min-height:55px;">Listo para identificar</div>
    </div>
  </div>
<div class="mt-2 flex items-center justify-between gap-2">
  <button type="button" class="px-3 py-2 rounded-lg border-2 border-gray-800 bg-white text-gray-900 text-sm font-bold"
    style="min-height:48px;"
    onclick="processPlantNetQueue({limit:10});">
    ⟳ Procesar pendientes IA
  </button>
  <div class="text-xs font-bold text-gray-700">
    Pendientes: <span data-plantnet-queue-count style="display:none;">0</span>
  </div>
</div>
</div>
<div id="alert_veda_${countArboles}" class="alert-box hidden">⚠️ ESPECIE EN VEDA - Requiere permisos especiales</div></div><div class="mb-4 p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border-2 border-green-200"><h6 class="text-xs font-bold text-green-700 uppercase mb-3"><i class="fas fa-ruler-combined mr-1"></i> Mediciones del Árbol</h6><div class="mb-3"><label class="block text-sm font-medium text-gray-700 mb-2">Tipo de medición</label><div class="flex gap-2"><button type="button" onclick="toggleMedidaTipo(${countArboles},'dap')" id="btn_medida_dap_${countArboles}" class="flex-1 py-3 px-3 rounded-lg font-bold text-sm bg-green-600 text-white border-2 border-green-600 shadow-md transition-all"><i class="fas fa-circle mr-1"></i> DAP<span class="block text-[10px] font-normal opacity-80">Diámetro</span></button><button type="button" onclick="toggleMedidaTipo(${countArboles},'circunferencia')" id="btn_medida_circ_${countArboles}" class="flex-1 py-3 px-3 rounded-lg font-bold text-sm bg-white text-gray-600 border-2 border-gray-300 transition-all"><i class="fas fa-sync-alt mr-1"></i> CAP<span class="block text-[10px] font-normal opacity-80">Circunferencia</span></button></div><input type="hidden" name="medida_tipo_${countArboles}" id="medida_tipo_hidden_${countArboles}" value="dap"></div><div class="grid grid-cols-2 gap-3 mb-3"><div><label class="block text-sm font-medium text-gray-700 mb-1" id="label_medida_${countArboles}">DAP (cm)</label><input type="number" id="val_medida_${countArboles}" class="input-field text-center font-mono text-lg" placeholder="0.0" step="0.1" oninput="calculateVolume(${countArboles})"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">LCT (m)</label><input type="number" id="val_lct_${countArboles}" class="input-field text-center font-mono text-lg" placeholder="0.0" step="0.1" oninput="calculateVolume(${countArboles})"></div></div><div class="grid grid-cols-2 gap-3"><div class="bg-white p-2 rounded border border-green-300 text-center"><span class="text-[10px] text-gray-500 block uppercase">DAP Calculado</span><span id="res_dap_${countArboles}" class="text-xl font-bold text-green-700">0.0</span><span class="text-sm text-gray-600"> cm</span></div><div class="bg-white p-2 rounded border border-green-300 text-center"><span class="text-[10px] text-gray-500 block uppercase">Volumen</span><span id="res_volumen_${countArboles}" class="text-xl font-bold text-green-700" data-vol="0">0.0000</span><span class="text-sm text-gray-600"> m³</span></div></div><div class="text-[10px] text-gray-400 mt-2 text-center" id="formula_debug_${countArboles}"></div></div><div class="mb-3"><label class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label><div class="flex gap-2 mb-3"><button type="button" onclick="toggleCoordMode('${id}','gps')" id="btn_mode_gps_${id}" class="flex-1 py-2 px-3 rounded-l-lg font-semibold text-sm bg-blue-600 text-white border-2 border-blue-600"><i class="fas fa-satellite-dish mr-1"></i> GPS Auto</button><button type="button" onclick="toggleCoordMode('${id}','manual')" id="btn_mode_manual_${id}" class="flex-1 py-2 px-3 rounded-r-lg font-semibold text-sm bg-gray-100 text-gray-600 border-2 border-gray-300"><i class="fas fa-edit mr-1"></i> Manual</button></div><div id="coord_gps_${id}"><div class="flex gap-2 mb-2"><button onclick="startGPS('${id}')" id="btn_start_gps_${id}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-2 rounded w-1/3 flex items-center justify-center text-sm"><i class="fas fa-satellite-dish mr-1"></i> Iniciar</button><button onclick="stopGPS('${id}')" id="btn_stop_gps_${id}" class="bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-3 px-2 rounded w-1/3 flex items-center justify-center text-sm hidden"><i class="fas fa-stop-circle mr-1"></i> Finalizar</button><button onclick="resetGPS('${id}')" id="btn_reset_gps_${id}" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 font-semibold py-3 px-2 rounded w-1/3 flex items-center justify-center text-sm hidden"><i class="fas fa-redo mr-1"></i> Reiniciar</button></div><div class="relative"><div id="map_overlay_${id}" class="map-preview text-gray-500 z-0"><div class="map-overlay"><i class="fas fa-map mb-1 text-2xl"></i><span class="text-xs">Esperando señal...</span></div></div><div id="gps_display_${id}" class="relative z-10 hidden pt-2"></div></div></div><div id="coord_manual_${id}" class="hidden"><div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-3"><div class="text-xs text-amber-700 mb-2 font-semibold"><i class="fas fa-info-circle mr-1"></i> Ingrese coordenadas CR-SIRGAS / CRTM05 (EPSG:8908)</div><div class="grid grid-cols-2 gap-3 mb-3"><div><label class="block text-xs font-bold text-gray-600 mb-1">Norte (Y)</label><input type="text" id="manual_norte_${id}" class="input-field text-sm py-2" placeholder="Ej: 1095200.00"></div><div><label class="block text-xs font-bold text-gray-600 mb-1">Este (X)</label><input type="text" id="manual_este_${id}" class="input-field text-sm py-2" placeholder="Ej: 445300.00"></div></div><div class="grid grid-cols-1 gap-3 mb-3">
    <div>
        <label class="block text-xs font-bold text-gray-600 mb-1">Incertidumbre (m)</label>
        <input type="number" id="manual_incertidumbre_${id}" class="input-field text-sm py-2" placeholder="Ej: 5.0" step="0.1" min="0.1" value="5.0">
        <span class="text-xs text-gray-500">Incertidumbre del dispositivo GPS (metros)</span>
    </div>
</div><button type="button" onclick="saveManualCoord('${id}')" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded text-sm"><i class="fas fa-check mr-1"></i> Guardar Coordenadas</button></div></div></div>
<div class="mb-4 pb-4 border-b border-gray-200">
  <h6 class="text-xs font-bold text-gray-500 uppercase mb-2">Relaciones Críticas con Vida Silvestre</h6>
  <div class="note mb-3">
    Documente interacciones ecológicas relevantes entre el árbol y especies de fauna/flora con estatus de conservación o importancia en Costa Rica. 
    <span class="text-xs text-gray-600 block mt-1">Fuente: SINAC / CITES / IUCN / ICT (según corresponda). Última actualización: 2026-01-29.</span>
  </div>
  <div id="container_relaciones_${id}" class="space-y-3"></div>
  <textarea id="wildlife_relations_json_${id}" class="hidden" rows="1">[]</textarea>
  <button type="button" class="btn-add" onclick="addWildlifeRelation(${countArboles})">
    <i class="fas fa-plus-circle"></i> Agregar Relación
  </button>
</div><div class="mb-3"><label class="block text-sm font-medium text-gray-700">Observaciones árbol</label><textarea class="input-field" rows="2"></textarea></div><div class="mb-3">
<input type="file" accept="image/*" capture="environment" id="${cid1}" class="hidden" onchange="photoSelected(this,'${bid1}')">
<div class="btn-camera" id="${bid1}" onclick="triggerCamera('${cid1}')">
<i class="fas fa-camera fa-2x"></i><br>
<div class="text-sm font-bold">Fotografía del árbol evaluado</div>
<div class="text-xs">Donde se vea el número del árbol estampado.</div>
</div>
</div>
<div class="mb-3">
<input type="file" accept="image/*" capture="environment" id="${cid2}" class="hidden" onchange="photoSelected(this,'${bid2}')">
<div class="btn-camera" id="${bid2}" onclick="triggerCamera('${cid2}')">
<i class="fas fa-camera fa-2x"></i><br>
<div class="text-sm font-bold">Fotografía del entorno</div>
<div class="text-xs">Donde se aprecie la estructura general de la vegetación y el terreno circundante.</div>
</div>
</div>
<div class="mb-3">
<input type="file" accept="image/*" capture="environment" id="${cid3}" class="hidden" onchange="photoSelected(this,'${bid3}')">
<div class="btn-camera" id="${bid3}" onclick="triggerCamera('${cid3}')">
<i class="fas fa-camera fa-2x"></i><br>
<div class="text-sm font-bold">Fotografía de detalle de interés</div>
<div class="text-xs">Que pueda capturar cuerpos de agua cercanos, daños físicos del árbol, relaciones con vida silvestre, u otros detalles relevantes.</div>
</div>
</div></div><div class="mt-4 pt-3 border-t border-gray-100 flex gap-2"><button onclick="saveArbolData(${countArboles})" id="btn_save_arbol_${countArboles}" class="bg-blue-100 text-blue-700 py-3 px-4 rounded flex-1 font-bold">Guardar</button><button onclick="editArbolData(${countArboles})" id="btn_edit_arbol_${countArboles}" class="bg-yellow-100 text-yellow-700 py-3 px-4 rounded hidden font-bold">Editar</button><button onclick="removeElement('${blockId}')" class="bg-red-100 hover:bg-red-200 text-red-700 py-3 px-4 rounded font-bold">Borrar</button></div><button class="btn-collapse-bottom" onclick="collapseBlockFromBottom('${blockId}')"><i class="fas fa-chevron-up"></i> Cerrar</button></div>`; document.getElementById('container_arboles').appendChild(d); updateSectionStatus(); setupSpeciesAutocomplete(`sp_arbol_${countArboles}`, countArboles); initWildlifeRelationsForArbol(countArboles); }
        // ============================================================================
        // INTEGRACIÓN Pl@ntNet (Identificación automática por fotografía)
        // - Rellena "Nombre Científico" (sp_arbol_{id}) y "% Certeza"
        // - Dispara checkSpecies() y updateBlockSummary() inmediatamente
        // ============================================================================
        const PLANTNET_API_KEY = '2b10CDckJdHR4RQNLyzxoGvZe';
        const PLANTNET_DIRECT_URL = 'https://my-api.plantnet.org/v2/identify/all?include-related-images=false&no-reject=false&lang=es&api-key=';

        // ── CORS Proxy config ──
        // Pl@ntNet bloquea llamadas directas desde GitHub Pages (CORS 403).
        // Opciones:
        //   1. (Recomendado) Tu propio Cloudflare Worker gratis → poné tu URL:
        //      const PLANTNET_CORS_PROXY = 'https://plantnet-proxy.TU-CUENTA.workers.dev/?url=';
        //   2. Proxy público (funcional, puede ser lento/caerse):
        const PLANTNET_CORS_PROXY = 'https://plantnet-proxy.psforestal.workers.dev/?url=';
        // Para deshabilitar el proxy y llamar directo, poné:
        // const PLANTNET_CORS_PROXY = '';

        // buildPlantNetEndpoint ya no se necesita — el fallback está en identifyWithPlantNet()


        // ===========================
        // Pl@ntNet Queue (offline)
        // ===========================
        // Cola separada para NO interferir con tu IndexedDB existente.
        const PLANTNET_QUEUE_DB   = 'PP01_ACOPAC_PLANTNET_QUEUE_DB';
        const PLANTNET_QUEUE_VER  = 1;
        const PLANTNET_QUEUE_STORE= 'queue';

        function openPlantNetQueueDB(){
            return new Promise((resolve, reject)=>{
                try{
                    const req = indexedDB.open(PLANTNET_QUEUE_DB, PLANTNET_QUEUE_VER);
                    req.onupgradeneeded = (e)=>{
                        const db = e.target.result;
                        if(!db.objectStoreNames.contains(PLANTNET_QUEUE_STORE)){
                            const st = db.createObjectStore(PLANTNET_QUEUE_STORE, { keyPath:'id', autoIncrement:true });
                            st.createIndex('byTime', 'ts', { unique:false });
                            st.createIndex('byArbol', 'arbolId', { unique:false });
                        }
                    };
                    req.onsuccess = ()=> resolve(req.result);
                    req.onerror = ()=> reject(req.error || new Error('IndexedDB error (PlantNet queue)'));
                }catch(err){ reject(err); }
            });
        }

        async function plantNetQueueCount(){
            try{
                const db = await openPlantNetQueueDB();
                return await new Promise((resolve, reject)=>{
                    const tx = db.transaction([PLANTNET_QUEUE_STORE],'readonly');
                    const st = tx.objectStore(PLANTNET_QUEUE_STORE);
                    const req = st.count();
                    req.onsuccess = ()=> resolve(req.result || 0);
                    req.onerror = ()=> reject(req.error);
                });
            }catch(_e){ return 0; }
        }

        async function updatePlantNetQueueBadges(){
            try{
                const n = await plantNetQueueCount();
                document.querySelectorAll('[data-plantnet-queue-count]').forEach(el=>{
                    el.textContent = String(n);
                    el.style.display = n > 0 ? '' : 'none';
                });
            }catch(_e){}
        }

        async function enqueuePlantNetJob(arbolId, file){
            const blob = file instanceof Blob ? file : null;
            if(!blob) return;
            const payload = {
                ts: Date.now(),
                arbolId: Number(arbolId),
                filename: file && file.name ? String(file.name) : 'plantnet.jpg',
                mime: file && file.type ? String(file.type) : (blob.type || 'image/jpeg'),
                blob: blob
            };
            const db = await openPlantNetQueueDB();
            await new Promise((resolve, reject)=>{
                const tx = db.transaction([PLANTNET_QUEUE_STORE],'readwrite');
                const st = tx.objectStore(PLANTNET_QUEUE_STORE);
                const req = st.add(payload);
                req.onsuccess = ()=> resolve(true);
                req.onerror = ()=> reject(req.error);
            });
            await updatePlantNetQueueBadges();
        }

        async function dequeuePlantNetJob(id){
            const db = await openPlantNetQueueDB();
            await new Promise((resolve, reject)=>{
                const tx = db.transaction([PLANTNET_QUEUE_STORE],'readwrite');
                const st = tx.objectStore(PLANTNET_QUEUE_STORE);
                const req = st.delete(id);
                req.onsuccess = ()=> resolve(true);
                req.onerror = ()=> reject(req.error);
            });
            await updatePlantNetQueueBadges();
        }

        // Procesa pendientes (se ejecuta automáticamente al volver el internet y también lo podés llamar desde UI)
        async function processPlantNetQueue(options){
            const opts = options || {};
            const limit = typeof opts.limit === 'number' ? opts.limit : 10;

            if(!navigator.onLine){
                // No hay red: no hacemos nada.
                return { processed: 0, remaining: await plantNetQueueCount(), offline: true };
            }

            const db = await openPlantNetQueueDB();

            const jobs = await new Promise((resolve, reject)=>{
                const out = [];
                const tx = db.transaction([PLANTNET_QUEUE_STORE],'readonly');
                const st = tx.objectStore(PLANTNET_QUEUE_STORE);
                const idx = st.index('byTime');
                const cursorReq = idx.openCursor();
                cursorReq.onsuccess = (e)=>{
                    const cur = e.target.result;
                    if(cur && out.length < limit){
                        out.push({ id: cur.primaryKey, ...cur.value });
                        cur.continue();
                    }else{
                        resolve(out);
                    }
                };
                cursorReq.onerror = ()=> reject(cursorReq.error);
            });

            let processed = 0;

            for(const job of jobs){
                try{
                    const res = await identifyWithPlantNet(job.blob, job.filename, job.mime);
                    // Si hay UI para ese árbol, rellenamos y disparamos lógica existente
                    const sciEl = document.getElementById('sp_arbol_' + job.arbolId);
                    const scoreEl = document.getElementById('plantnet_score_' + job.arbolId);
                    const statusEl = document.getElementById('plantnet_status_' + job.arbolId);

                    if(sciEl){
                        if(res && res.scientificName){
                            sciEl.value = res.scientificName;
                            sciEl.dispatchEvent(new Event('input', { bubbles:true }));
                            sciEl.dispatchEvent(new Event('change', { bubbles:true }));
                        }
                        if(scoreEl && res && typeof res.scorePct === 'number'){
                            scoreEl.value = (Math.round(res.scorePct * 10)/10).toString();
                            scoreEl.dispatchEvent(new Event('input', { bubbles:true }));
                            scoreEl.dispatchEvent(new Event('change', { bubbles:true }));
                        }
                        try{ checkSpecies(job.arbolId); }catch(_e){}
                        try{ updateBlockSummary('t', job.arbolId); }catch(_e){}
                        if(statusEl){
                            statusEl.textContent = 'Listo ✔ (pendiente procesado)';
                        }
                    }else{
                        // Si el árbol no está montado en DOM ahora, NO borramos el job (para cuando se recargue la inspección)
                        continue;
                    }

                    await dequeuePlantNetJob(job.id);
                    processed += 1;
                }catch(err){
                    // Si falla, dejamos el job para reintentar luego.
                    console.warn('PlantNet queue job failed (kept for retry):', err);
                }
            }

            return { processed, remaining: await plantNetQueueCount(), offline: false };
        }

        // Auto-procesar cuando vuelve conexión
        window.addEventListener('online', ()=>{ try{ processPlantNetQueue({limit:5}); }catch(_e){} });

        // Exponer por si querés llamarlo desde UI/console
        window.processPlantNetQueue = processPlantNetQueue;
        try{ setTimeout(updatePlantNetQueueBadges, 0); }catch(_e){}

        // ===========================
        // Pl@ntNet identify helper
        // ===========================
        async function identifyWithPlantNet(imageBlob, filename, mime){
            const form = new FormData();
            const file = (imageBlob instanceof File)
                ? imageBlob
                : new File([imageBlob], filename || 'plantnet.jpg', { type: mime || imageBlob.type || 'image/jpeg' });
            form.append('images', file);

            // Intentar: 1) directo, 2) si CORS falla → proxy
            const directUrl = PLANTNET_DIRECT_URL + encodeURIComponent(PLANTNET_API_KEY);
            const proxyUrl  = PLANTNET_CORS_PROXY
                ? PLANTNET_CORS_PROXY + encodeURIComponent(directUrl)
                : null;

            let res, usedProxy = false;
            try {
                res = await fetch(directUrl, { method:'POST', body: form });
            } catch(directErr) {
                // TypeError = CORS / red block → intentar proxy
                if(proxyUrl){
                    // Re-crear FormData (el body se consumió)
                    const form2 = new FormData();
                    form2.append('images', file);
                    usedProxy = true;
                    res = await fetch(proxyUrl, { method:'POST', body: form2 });
                } else {
                    throw new Error('CORS bloqueado y no hay proxy configurado. ' + directErr.message);
                }
            }

            if(!res.ok){
                // Si la respuesta directa da 403/CORS y hay proxy, reintentar
                if(!usedProxy && proxyUrl && (res.status === 403 || res.status === 0)){
                    const form3 = new FormData();
                    form3.append('images', file);
                    usedProxy = true;
                    res = await fetch(proxyUrl, { method:'POST', body: form3 });
                }
            }
            if(!res.ok){
                const txt = await res.text().catch(()=> '');
                throw new Error('Pl@ntNet HTTP ' + res.status + (usedProxy ? ' (vía proxy)' : '') + ' ' + (txt ? ('- ' + txt.slice(0,120)) : ''));
            }
            const data = await res.json();

            const best = data && data.results && data.results[0] ? data.results[0] : null;
            const scientificName =
                best && best.species && best.species.scientificNameWithoutAuthor
                    ? String(best.species.scientificNameWithoutAuthor)
                    : '';

            const score = best && typeof best.score === 'number' ? best.score : null;
            const scorePct = score === null ? null : (score * 100);

            return { scientificName, scorePct, raw: data };
        }

        async function handlePlantNetIdentification(event, arbolId){
            try{
                const input = event && event.target ? event.target : null;
                const file = input && input.files && input.files[0] ? input.files[0] : null;
                if(!file){ return; }

                // UI elements
                const statusEl = document.getElementById('plantnet_status_' + arbolId);
                const scoreEl  = document.getElementById('plantnet_score_' + arbolId);
                const sciEl    = document.getElementById('sp_arbol_' + arbolId);

                // Si no hay internet, encolamos y salimos.
                if(!navigator.onLine){
                    if(statusEl){ statusEl.textContent = 'Sin internet: guardado para procesar luego'; }
                    await enqueuePlantNetJob(arbolId, file);
                    await updatePlantNetQueueBadges();
                    return;
                }

                if(statusEl){ statusEl.textContent = 'Analizando...'; }
                if(scoreEl){ scoreEl.value = ''; }
                if(sciEl){ sciEl.classList.add('opacity-75'); }

                // Identify
                const out = await identifyWithPlantNet(file, file.name, file.type);

                const scientificName = out && out.scientificName ? out.scientificName : '';
                const scorePct = out && typeof out.scorePct === 'number' ? out.scorePct : null;

                if(sciEl){
                    sciEl.value = scientificName;
                    // Disparar listeners existentes (autoguardado / backups / validaciones)
                    sciEl.dispatchEvent(new Event('input', { bubbles:true }));
                    sciEl.dispatchEvent(new Event('change', { bubbles:true }));
                }
                if(scoreEl && scorePct !== null){
                    scoreEl.value = (Math.round(scorePct * 10)/10).toString();
                    scoreEl.dispatchEvent(new Event('input', { bubbles:true }));
                    scoreEl.dispatchEvent(new Event('change', { bubbles:true }));
                }

                // Disparar lógica existente de alertas/resumen
                try{ checkSpecies(arbolId); }catch(_e){}
                try{ updateBlockSummary('t', arbolId); }catch(_e){}

                if(statusEl){
                    statusEl.textContent = 'Listo ✔';
                }
                if(sciEl){ sciEl.classList.remove('opacity-75'); }
            }catch(err){
                // Si falla por red/CORS, encolamos para reintento.
                try{
                    const input = event && event.target ? event.target : null;
                    const file = input && input.files && input.files[0] ? input.files[0] : null;
                    if(file){
                        const statusEl = document.getElementById('plantnet_status_' + arbolId);
                        if(statusEl){ statusEl.textContent = 'Error de red: guardado para reintentar'; }
                        await enqueuePlantNetJob(arbolId, file);
                        await updatePlantNetQueueBadges();
                    }
                }catch(_e2){}

                const statusEl = document.getElementById('plantnet_status_' + arbolId);
                const sciEl    = document.getElementById('sp_arbol_' + arbolId);
                if(statusEl){
                    statusEl.textContent = 'Error IA: ' + (err && err.message ? err.message : 'desconocido');
                }
                if(sciEl){ sciEl.classList.remove('opacity-75'); }
                console.error('PlantNet identification error:', err);
            }
        }

        function saveArbolData(id){ if(!inspeccionIniciada){ alert('Debe iniciar la inspección primero presionando el botón "Iniciar".'); return; } document.getElementById('arbol_'+id).dataset.saved="true"; const f=document.getElementById(`fields_arbol_${id}`); f.querySelectorAll('input, select, textarea, button').forEach(e=>e.disabled=true); document.getElementById(`num_arbol_${id}`).disabled=true; document.getElementById(`btn_save_arbol_${id}`).classList.add('hidden'); document.getElementById(`btn_edit_arbol_${id}`).classList.remove('hidden'); f.classList.add('opacity-75'); document.getElementById(`status_t${id}`).className='block-status saved'; document.getElementById(`status_t${id}`).textContent='Guardado'; updateDashboard(); collapseBlock('arbol_'+id); updateSectionStatus(); }
        function editArbolData(id){ delete document.getElementById('arbol_'+id).dataset.saved; const f=document.getElementById(`fields_arbol_${id}`); f.querySelectorAll('input, select, textarea, button').forEach(e=>e.disabled=false); document.getElementById(`num_arbol_${id}`).disabled=false; document.getElementById(`btn_save_arbol_${id}`).classList.remove('hidden'); document.getElementById(`btn_edit_arbol_${id}`).classList.add('hidden'); f.classList.remove('opacity-75'); document.getElementById(`status_t${id}`).className='block-status pending'; document.getElementById(`status_t${id}`).textContent='Pendiente'; updateDashboard(); updateSectionStatus(); }
        function checkSpecies(id){ 
            const v=document.getElementById(`sp_arbol_${id}`).value; 
            const isVedada = v.includes("VEDADA");
            document.getElementById(`alert_veda_${id}`).classList.toggle('hidden', !isVedada);
            
            // Mostrar info de conservación solo si NO es vedada
            let infoDiv = document.getElementById(`conservation_info_${id}`);
            if (!infoDiv) {
                infoDiv = document.createElement('div');
                infoDiv.id = `conservation_info_${id}`;
                const alertVeda = document.getElementById(`alert_veda_${id}`);
                alertVeda.parentNode.insertBefore(infoDiv, alertVeda.nextSibling);
            }
            
            if (!isVedada && v) {
                const info = getConservationInfo(v);
                if (info) {
                    let statusClass = 'lc';
                    if (info.status.includes('Crítico')) statusClass = 'cr';
                    else if (info.status.includes('En Peligro')) statusClass = 'en';
                    else if (info.status.includes('Vulnerable')) statusClass = 'vu';
                    else if (info.status.includes('Casi')) statusClass = 'nt';
                    
                    let html = `<div class="conservation-info ${statusClass}">`;
                    html += `<span class="status-label">Estado: ${info.status}</span>`;
                    if (info.cites) {
                        html += `<span class="cites-badge">CITES ${info.cites}</span>`;
                    }
                    html += `<div class="source">Fuente: ${info.source}</div>`;
                    html += `</div>`;
                    infoDiv.innerHTML = html;
                } else {
                    infoDiv.innerHTML = '';
                }
            } else {
                infoDiv.innerHTML = '';
            }
        }
        function validateAndCalc(id){ const hiddenInput = document.getElementById(`medida_tipo_hidden_${id}`); const tipoMedida = hiddenInput ? hiddenInput.value : 'dap'; let medida=parseFloat(document.getElementById(`val_medida_${id}`).value)||0; const h=parseFloat(document.getElementById(`val_lct_${id}`).value)||0; let dap = medida; if(tipoMedida === 'circunferencia'){ dap = medida / Math.PI; } const resDap = document.getElementById(`res_dap_${id}`); if(resDap) resDap.innerText = dap.toFixed(1); if(dap>0&&h>0){ const v=0.00008379*Math.pow(dap,2.03986)*Math.pow(h,0.779); document.getElementById(`res_volumen_${id}`).innerText=v.toFixed(4); document.getElementById(`res_volumen_${id}`).dataset.vol=v; document.getElementById(`formula_debug_${id}`).innerText=`V = 0.00008379 × ${dap.toFixed(2)}^2.04 × ${h.toFixed(2)}^0.78`; }else{ document.getElementById(`res_volumen_${id}`).innerText="0.0000"; document.getElementById(`res_volumen_${id}`).dataset.vol=0; document.getElementById(`formula_debug_${id}`).innerText=""; } }
        function updateDashboard(){ const s=document.querySelectorAll('[id^="arbol_"][data-saved="true"]'); document.getElementById('summary_count').innerText=s.length; let t=0; s.forEach(tree=>{ const id=tree.id.split('_')[1]; const v=document.getElementById('res_volumen_'+id); if(v) t+=parseFloat(v.dataset.vol||0); }); document.getElementById('summary_vol').innerText=t.toFixed(3); }
        function toggleUsoSueloArbol(id){ const sel=document.getElementById(`tipo_uso_arbol_${id}`); const v=sel.value; const fAgro=document.getElementById(`field_sp_agronomicas_${id}`); const fOtro=document.getElementById(`field_uso_otro_${id}`); fAgro.classList.add('hidden-field'); fOtro.classList.add('hidden-field'); if(v==='agropecuario' || v==='agroforestal') fAgro.classList.remove('hidden-field'); if(v==='otro') fOtro.classList.remove('hidden-field'); }
        function toggleSlopeMode(id, mode) {
            const btnPct = document.getElementById('btn_slope_pct_' + id);
            const btnDeg = document.getElementById('btn_slope_deg_' + id);
            const btnCalc = document.getElementById('btn_slope_calc_' + id);
            const btnClino = document.getElementById('btn_slope_clino_' + id);
            const divPct = document.getElementById('slope_pct_' + id);
            const divDeg = document.getElementById('slope_deg_' + id);
            const divCalc = document.getElementById('slope_calc_' + id);
            const divClino = document.getElementById('slope_clino_' + id);
            
            // Reset all buttons
            [btnPct, btnDeg, btnCalc, btnClino].forEach(btn => {
                if(btn) {
                    btn.classList.remove('bg-green-600', 'bg-purple-600', 'text-white', 'border-green-600', 'border-purple-600');
                    btn.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-300');
                }
            });
            
            // Hide all divs
            [divPct, divDeg, divCalc, divClino].forEach(div => { if(div) div.classList.add('hidden'); });
            
            // Activate selected
            if (mode === 'pct') {
                btnPct.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-300');
                btnPct.classList.add('bg-green-600', 'text-white', 'border-green-600');
                divPct.classList.remove('hidden');
            } else if (mode === 'deg') {
                btnDeg.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-300');
                btnDeg.classList.add('bg-green-600', 'text-white', 'border-green-600');
                divDeg.classList.remove('hidden');
            } else if (mode === 'calc') {
                btnCalc.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-300');
                btnCalc.classList.add('bg-green-600', 'text-white', 'border-green-600');
                divCalc.classList.remove('hidden');
            } else if (mode === 'clino') {
                btnClino.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-300');
                btnClino.classList.add('bg-purple-600', 'text-white', 'border-purple-600');
                divClino.classList.remove('hidden');
            }
        }
        
        // ============================================================
        // CLINÓMETRO DIGITAL - Mide inclinación con sensores del teléfono
        // ============================================================
        let _clinoState = {
            active: false,
            arbolId: null,
            orientHandler: null,
            countdownTimer: null,
            beepInterval: null,
            stabilityTimer: null,
            readings: [],
            locked: false,
            audioCtx: null,
            phase: 'idle', // idle, countdown, measuring, locked, calibrating
            calibOffset: 0 // MEJORA: offset de calibración en grados
        };

        // MEJORA: Cargar calibración previa del clinómetro desde localStorage
        try {
            const savedCalib = localStorage.getItem('pp01_clino_calibration');
            if (savedCalib) {
                const calibData = JSON.parse(savedCalib);
                if (calibData && typeof calibData.offset === 'number') {
                    _clinoState.calibOffset = calibData.offset;
                }
            }
        } catch(e) { /* localStorage no disponible */ }

        function _clinoBeep(freq, duration, type) {
            try {
                if (!_clinoState.audioCtx) _clinoState.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const ctx = _clinoState.audioCtx;
                if (ctx.state === 'suspended') ctx.resume();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type || 'sine';
                osc.frequency.value = freq;
                gain.gain.value = 0.3;
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration / 1000);
                osc.stop(ctx.currentTime + duration / 1000);
            } catch(e) { /* Audio not supported */ }
        }

        function _clinoCalcTilt(beta, gamma) {
            // Calcula ángulo de inclinación desde la horizontal
            // beta = inclinación frontal (-180 a 180), gamma = inclinación lateral (-90 a 90)
            const bRad = (beta || 0) * Math.PI / 180;
            const gRad = (gamma || 0) * Math.PI / 180;
            // Ángulo total desde la horizontal
            const tiltRad = Math.acos(Math.min(1, Math.abs(Math.cos(bRad) * Math.cos(gRad))));
            let tiltDeg = tiltRad * 180 / Math.PI;
            // MEJORA: Aplicar offset de calibración
            tiltDeg = Math.max(0, tiltDeg - _clinoState.calibOffset);
            return tiltDeg; // en grados
        }

        function _clinoGetStdDev(arr) {
            if (arr.length < 2) return 999;
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            const variance = arr.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / arr.length;
            return Math.sqrt(variance);
        }

        function openClinometer(arbolId) {
            _clinoState.arbolId = arbolId;
            _clinoState.locked = false;
            _clinoState.readings = [];
            _clinoState.phase = 'idle';

            // Crear modal
            let modal = document.getElementById('clinometer_modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'clinometer_modal';
                modal.innerHTML = `
                <div style="position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:10000;display:flex;align-items:center;justify-content:center;padding:16px;">
                    <div style="background:#1a1a2e;border-radius:20px;width:100%;max-width:380px;padding:24px;color:white;text-align:center;position:relative;">
                        <div style="font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:#a78bfa;margin-bottom:8px;">
                            <i class="fas fa-mountain" style="margin-right:6px;"></i>Clinómetro Digital
                        </div>
                        <div id="clino_instruction" style="font-size:13px;color:#94a3b8;margin-bottom:16px;">
                            Coloque el teléfono con la pantalla paralela a la superficie del terreno
                        </div>
                        
                        <!-- Indicador visual circular -->
                        <div style="position:relative;width:200px;height:200px;margin:0 auto 16px;">
                            <svg viewBox="0 0 200 200" style="width:100%;height:100%;">
                                <circle cx="100" cy="100" r="90" fill="none" stroke="#334155" stroke-width="4"/>
                                <circle cx="100" cy="100" r="60" fill="none" stroke="#1e293b" stroke-width="1" stroke-dasharray="4,4"/>
                                <circle cx="100" cy="100" r="30" fill="none" stroke="#1e293b" stroke-width="1" stroke-dasharray="4,4"/>
                                <!-- Ticks cada 10 grados -->
                                <g id="clino_ticks" stroke="#475569" stroke-width="1"></g>
                                <!-- Aguja indicadora -->
                                <line id="clino_needle" x1="100" y1="100" x2="100" y2="20" stroke="#f97316" stroke-width="3" stroke-linecap="round" transform="rotate(0,100,100)"/>
                                <circle cx="100" cy="100" r="6" fill="#f97316"/>
                            </svg>
                            <div id="clino_angle_display" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);margin-top:30px;">
                                <div id="clino_big_value" style="font-size:48px;font-weight:800;color:#f97316;line-height:1;">--</div>
                                <div style="font-size:14px;color:#94a3b8;">grados</div>
                            </div>
                        </div>
                        
                        <!-- Resultado en porcentaje -->
                        <div id="clino_pct_display" style="background:#0f172a;border-radius:12px;padding:12px;margin-bottom:16px;">
                            <span style="color:#94a3b8;font-size:13px;">Pendiente: </span>
                            <span id="clino_pct_value" style="font-size:28px;font-weight:800;color:#22c55e;">--</span>
                            <span style="color:#94a3b8;font-size:16px;font-weight:700;"> %</span>
                        </div>
                        
                        <!-- Estado -->
                        <div id="clino_status" style="font-size:13px;padding:8px;border-radius:8px;margin-bottom:16px;background:#1e293b;color:#64748b;">
                            <i class="fas fa-hand-point-up" style="margin-right:4px;"></i> Presione "Iniciar Medición"
                        </div>
                        
                        <!-- Barra de estabilidad -->
                        <div id="clino_stability_bar_wrap" style="display:none;margin-bottom:16px;">
                            <div style="font-size:11px;color:#94a3b8;margin-bottom:4px;">Estabilidad</div>
                            <div style="background:#1e293b;border-radius:6px;height:8px;overflow:hidden;">
                                <div id="clino_stability_bar" style="height:100%;width:0%;background:linear-gradient(90deg,#ef4444,#f59e0b,#22c55e);border-radius:6px;transition:width 0.3s;"></div>
                            </div>
                        </div>
                        
                        <!-- Botones -->
                        <div id="clino_btn_start_wrap">
                            <button onclick="_clinoStart()" style="background:linear-gradient(135deg,#7c3aed,#6d28d9);color:white;font-weight:700;font-size:15px;padding:14px 32px;border-radius:12px;border:none;width:100%;cursor:pointer;">
                                <i class="fas fa-play mr-2"></i> Iniciar Medición
                            </button>
                        </div>
                        <div id="clino_btn_actions_wrap" style="display:none;">
                            <div style="display:flex;gap:8px;">
                                <button onclick="_clinoAccept()" id="clino_btn_accept" style="flex:1;background:#22c55e;color:white;font-weight:700;font-size:14px;padding:12px;border-radius:10px;border:none;cursor:pointer;display:none;">
                                    <i class="fas fa-check mr-1"></i> Aceptar
                                </button>
                                <button onclick="_clinoRetry()" id="clino_btn_retry" style="flex:1;background:#f59e0b;color:white;font-weight:700;font-size:14px;padding:12px;border-radius:10px;border:none;cursor:pointer;">
                                    <i class="fas fa-redo mr-1"></i> Reintentar
                                </button>
                                <button onclick="_clinoCancel()" style="flex:1;background:#64748b;color:white;font-weight:700;font-size:14px;padding:12px;border-radius:10px;border:none;cursor:pointer;">
                                    <i class="fas fa-times mr-1"></i> Cancelar
                                </button>
                            </div>
                        </div>
                        <!-- MEJORA: Calibración y diagnóstico -->
                        <div id="clino_calib_section" style="margin-top:12px;padding-top:12px;border-top:1px solid #334155;">
                            <div id="clino_calib_status" style="font-size:11px;color:#64748b;margin-bottom:6px;">
                                <i class="fas fa-info-circle" style="margin-right:3px;"></i>
                                <span id="clino_calib_text">Sin calibrar</span>
                            </div>
                            <div style="display:flex;gap:6px;">
                                <button onclick="_clinoStartCalibration()" id="clino_btn_calibrate" style="flex:1;background:#1e293b;color:#94a3b8;font-weight:600;font-size:12px;padding:8px;border-radius:8px;border:1px solid #334155;cursor:pointer;">
                                    <i class="fas fa-crosshairs mr-1"></i> Calibrar en plano
                                </button>
                                <button onclick="_clinoResetCalibration()" style="background:#1e293b;color:#64748b;font-weight:600;font-size:12px;padding:8px 12px;border-radius:8px;border:1px solid #334155;cursor:pointer;">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button onclick="_clinoRunDiagnostic()" style="background:#1e293b;color:#64748b;font-weight:600;font-size:12px;padding:8px 12px;border-radius:8px;border:1px solid #334155;cursor:pointer;" title="Diagnóstico de sensores">
                                    <i class="fas fa-stethoscope"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
                document.body.appendChild(modal);
                // Generar ticks del dial
                const ticksG = document.getElementById('clino_ticks');
                for (let a = 0; a <= 90; a += 10) {
                    const rad = (a - 90) * Math.PI / 180;
                    const x1 = 100 + 82 * Math.cos(rad), y1 = 100 + 82 * Math.sin(rad);
                    const x2 = 100 + 90 * Math.cos(rad), y2 = 100 + 90 * Math.sin(rad);
                    ticksG.innerHTML += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}"/>`;
                }
            }
            modal.style.display = '';
            // Reset UI
            document.getElementById('clino_big_value').textContent = '--';
            document.getElementById('clino_pct_value').textContent = '--';
            document.getElementById('clino_status').innerHTML = '<i class="fas fa-hand-point-up" style="margin-right:4px;"></i> Presione "Iniciar Medición"';
            document.getElementById('clino_status').style.background = '#1e293b';
            document.getElementById('clino_status').style.color = '#64748b';
            document.getElementById('clino_stability_bar_wrap').style.display = 'none';
            document.getElementById('clino_btn_start_wrap').style.display = '';
            document.getElementById('clino_btn_actions_wrap').style.display = 'none';
            document.getElementById('clino_btn_accept').style.display = 'none';
            document.getElementById('clino_btn_retry').style.display = '';
            document.getElementById('clino_needle').setAttribute('transform', 'rotate(0,100,100)');
            // MEJORA: Actualizar indicador de calibración
            _clinoUpdateCalibStatus();
        }

        async function _clinoStart() {
            // Solicitar permiso de sensores (requerido en iOS 13+)
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const perm = await DeviceOrientationEvent.requestPermission();
                    if (perm !== 'granted') {
                        alert('Se requiere permiso para acceder a los sensores del teléfono.');
                        return;
                    }
                } catch(e) {
                    alert('Error solicitando permiso de sensores: ' + e.message);
                    return;
                }
            }
            // Verificar soporte
            if (typeof DeviceOrientationEvent === 'undefined') {
                alert('Este dispositivo no soporta sensores de orientación.\nUse otro método de medición.');
                return;
            }

            _clinoState.locked = false;
            _clinoState.readings = [];
            _clinoState.phase = 'countdown';

            document.getElementById('clino_btn_start_wrap').style.display = 'none';
            document.getElementById('clino_btn_actions_wrap').style.display = '';
            document.getElementById('clino_btn_accept').style.display = 'none';
            document.getElementById('clino_btn_retry').style.display = '';
            document.getElementById('clino_stability_bar_wrap').style.display = 'none';

            // Countdown 3 segundos para acomodar el teléfono
            let countdown = 3;
            const statusEl = document.getElementById('clino_status');
            statusEl.style.background = '#312e81';
            statusEl.style.color = '#c4b5fd';

            const updateCountdown = () => {
                if (countdown > 0) {
                    statusEl.innerHTML = `<i class="fas fa-hourglass-half" style="margin-right:4px;"></i> Acomode el teléfono... <span style="font-size:24px;font-weight:800;">${countdown}</span>`;
                    _clinoBeep(800, 150, 'sine');
                    countdown--;
                    _clinoState.countdownTimer = setTimeout(updateCountdown, 1000);
                } else {
                    // Iniciar medición real
                    _clinoState.phase = 'measuring';
                    statusEl.style.background = '#1e3a5f';
                    statusEl.style.color = '#7dd3fc';
                    statusEl.innerHTML = '<i class="fas fa-satellite-dish" style="margin-right:4px;"></i> Midiendo... mantenga estable';
                    document.getElementById('clino_stability_bar_wrap').style.display = '';
                    _clinoStartListening();
                }
            };
            updateCountdown();
        }

        function _clinoStartListening() {
            _clinoState.readings = [];
            // Beep periódico cada 600ms mientras mide
            _clinoState.beepInterval = setInterval(() => {
                if (_clinoState.phase === 'measuring' && !_clinoState.locked) {
                    _clinoBeep(600, 80, 'square');
                }
            }, 600);

            _clinoState.orientHandler = function(e) {
                if (_clinoState.locked) return;
                const tiltDeg = _clinoCalcTilt(e.beta, e.gamma);
                const tiltPct = Math.tan(tiltDeg * Math.PI / 180) * 100;

                // Actualizar display en tiempo real
                const clampedDeg = Math.min(tiltDeg, 90);
                document.getElementById('clino_big_value').textContent = clampedDeg.toFixed(1);
                document.getElementById('clino_pct_value').textContent = tiltPct.toFixed(1);
                // Rotar aguja (0° = vertical arriba, 90° = horizontal derecha)
                document.getElementById('clino_needle').setAttribute('transform', `rotate(${clampedDeg},100,100)`);

                if (_clinoState.phase === 'measuring') {
                    _clinoState.readings.push(tiltDeg);
                    // Mantener ventana de últimas 30 lecturas (~1.5s a 50Hz)
                    if (_clinoState.readings.length > 30) _clinoState.readings.shift();

                    // Calcular estabilidad
                    const stdDev = _clinoGetStdDev(_clinoState.readings);
                    // Barra de estabilidad: 0% cuando stdDev>=3, 100% cuando stdDev<=0.3
                    const stability = Math.max(0, Math.min(100, (3 - stdDev) / 2.7 * 100));
                    document.getElementById('clino_stability_bar').style.width = stability + '%';

                    // Si estable (stdDev < 0.5°) y al menos 20 lecturas
                    if (stdDev < 0.5 && _clinoState.readings.length >= 20) {
                        _clinoLock();
                    }
                }
            };
            window.addEventListener('deviceorientation', _clinoState.orientHandler);
        }

        function _clinoLock() {
            if (_clinoState.locked) return;
            _clinoState.locked = true;
            _clinoState.phase = 'locked';

            // Parar beep periódico
            if (_clinoState.beepInterval) { clearInterval(_clinoState.beepInterval); _clinoState.beepInterval = null; }

            // Alerta sonora diferente (tono más agudo, más largo)
            _clinoBeep(1200, 100, 'sine');
            setTimeout(() => _clinoBeep(1500, 150, 'sine'), 150);
            setTimeout(() => _clinoBeep(1800, 300, 'sine'), 350);

            // Calcular promedio final
            const avg = _clinoState.readings.reduce((a, b) => a + b, 0) / _clinoState.readings.length;
            const avgPct = Math.tan(avg * Math.PI / 180) * 100;

            // Fijar resultado
            document.getElementById('clino_big_value').textContent = avg.toFixed(1);
            document.getElementById('clino_pct_value').textContent = avgPct.toFixed(1);
            document.getElementById('clino_big_value').style.color = '#22c55e';
            document.getElementById('clino_stability_bar').style.width = '100%';

            const statusEl = document.getElementById('clino_status');
            statusEl.style.background = '#14532d';
            statusEl.style.color = '#86efac';
            statusEl.innerHTML = '<i class="fas fa-check-circle" style="margin-right:4px;"></i> ¡Medición completada! — ' + avg.toFixed(1) + '° (' + avgPct.toFixed(1) + '%)';

            // Mostrar botón aceptar
            document.getElementById('clino_btn_accept').style.display = '';

            // Vibrar si disponible
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);
        }

        function _clinoAccept() {
            const avgDeg = parseFloat(document.getElementById('clino_big_value').textContent) || 0;
            const avgPct = parseFloat(document.getElementById('clino_pct_value').textContent) || 0;
            const arbolId = _clinoState.arbolId;
            _clinoCleanup();

            // Cerrar modal
            document.getElementById('clinometer_modal').style.display = 'none';

            // Llenar el campo de inclinación en porcentaje
            setSlopeFromClinometer(arbolId, avgPct);
        }

        function _clinoRetry() {
            _clinoCleanup();
            _clinoState.locked = false;
            _clinoState.readings = [];
            document.getElementById('clino_big_value').style.color = '#f97316';
            document.getElementById('clino_big_value').textContent = '--';
            document.getElementById('clino_pct_value').textContent = '--';
            document.getElementById('clino_needle').setAttribute('transform', 'rotate(0,100,100)');
            document.getElementById('clino_stability_bar').style.width = '0%';
            document.getElementById('clino_stability_bar_wrap').style.display = 'none';
            document.getElementById('clino_btn_accept').style.display = 'none';
            document.getElementById('clino_btn_start_wrap').style.display = '';
            document.getElementById('clino_btn_actions_wrap').style.display = 'none';
            const statusEl = document.getElementById('clino_status');
            statusEl.style.background = '#1e293b';
            statusEl.style.color = '#64748b';
            statusEl.innerHTML = '<i class="fas fa-hand-point-up" style="margin-right:4px;"></i> Presione "Iniciar Medición"';
            // Relanzar automáticamente
            _clinoStart();
        }

        function _clinoCancel() {
            _clinoCleanup();
            document.getElementById('clinometer_modal').style.display = 'none';
        }

        function _clinoCleanup() {
            if (_clinoState.orientHandler) {
                window.removeEventListener('deviceorientation', _clinoState.orientHandler);
                _clinoState.orientHandler = null;
            }
            if (_clinoState.countdownTimer) { clearTimeout(_clinoState.countdownTimer); _clinoState.countdownTimer = null; }
            if (_clinoState.beepInterval) { clearInterval(_clinoState.beepInterval); _clinoState.beepInterval = null; }
            _clinoState.phase = 'idle';
        }

        // ============================================================
        // MEJORA: Calibración del clinómetro en superficie plana
        // ============================================================
        function _clinoUpdateCalibStatus() {
            const el = document.getElementById('clino_calib_text');
            if (!el) return;
            if (_clinoState.calibOffset > 0) {
                el.innerHTML = `<span style="color:#22c55e;">✓ Calibrado</span> (offset: ${_clinoState.calibOffset.toFixed(2)}°)`;
            } else {
                el.textContent = 'Sin calibrar — para mayor precisión, calibre en superficie plana';
            }
        }

        async function _clinoStartCalibration() {
            // Solicitar permiso de sensores si es iOS
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const perm = await DeviceOrientationEvent.requestPermission();
                    if (perm !== 'granted') { alert('Se requiere permiso para calibrar.'); return; }
                } catch(e) { alert('Error: ' + e.message); return; }
            }
            if (typeof DeviceOrientationEvent === 'undefined') {
                alert('Sensores no disponibles en este dispositivo.'); return;
            }

            // Deshabilitar botón de calibrar durante proceso
            const btn = document.getElementById('clino_btn_calibrate');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Calibrando...'; }

            const statusEl = document.getElementById('clino_status');
            if (statusEl) {
                statusEl.style.background = '#312e81';
                statusEl.style.color = '#c4b5fd';
                statusEl.innerHTML = '<i class="fas fa-crosshairs" style="margin-right:4px;"></i> Coloque en superficie PLANA — midiendo offset...';
            }

            const calibReadings = [];
            let calibHandler = null;

            // Temporalmente desactivar offset para leer el crudo
            const prevOffset = _clinoState.calibOffset;
            _clinoState.calibOffset = 0;

            calibHandler = function(e) {
                const tilt = _clinoCalcTilt(e.beta, e.gamma);
                calibReadings.push(tilt);
                // Actualizar display en tiempo real
                document.getElementById('clino_big_value').textContent = tilt.toFixed(1);
                document.getElementById('clino_pct_value').textContent = (Math.tan(tilt * Math.PI / 180) * 100).toFixed(1);
            };
            window.addEventListener('deviceorientation', calibHandler);

            // Esperar 3 segundos, luego recolectar por 3 segundos más
            await new Promise(r => setTimeout(r, 3000));
            const startIdx = calibReadings.length;
            await new Promise(r => setTimeout(r, 3000));

            window.removeEventListener('deviceorientation', calibHandler);

            // Calcular offset promedio de las lecturas estables
            const stableReadings = calibReadings.slice(startIdx);
            if (stableReadings.length > 10) {
                // Eliminar outliers (percentiles 10-90)
                const sorted = [...stableReadings].sort((a, b) => a - b);
                const p10 = Math.floor(sorted.length * 0.1);
                const p90 = Math.floor(sorted.length * 0.9);
                const trimmed = sorted.slice(p10, p90);
                const avgOffset = trimmed.reduce((a, b) => a + b, 0) / trimmed.length;

                _clinoState.calibOffset = Math.max(0, avgOffset);

                // Persistir en localStorage
                try {
                    localStorage.setItem('pp01_clino_calibration', JSON.stringify({
                        offset: _clinoState.calibOffset,
                        date: new Date().toISOString(),
                        samples: stableReadings.length
                    }));
                } catch(e) {}

                _clinoBeep(1000, 150, 'sine');
                setTimeout(() => _clinoBeep(1200, 200, 'sine'), 200);

                if (statusEl) {
                    statusEl.style.background = '#14532d';
                    statusEl.style.color = '#86efac';
                    statusEl.innerHTML = `<i class="fas fa-check-circle" style="margin-right:4px;"></i> Calibrado — offset: ${_clinoState.calibOffset.toFixed(2)}° (${stableReadings.length} muestras)`;
                }
            } else {
                _clinoState.calibOffset = prevOffset; // Restaurar
                if (statusEl) {
                    statusEl.style.background = '#7f1d1d';
                    statusEl.style.color = '#fca5a5';
                    statusEl.innerHTML = '<i class="fas fa-exclamation-triangle" style="margin-right:4px;"></i> Calibración fallida — pocas lecturas. Reintente.';
                }
            }

            _clinoUpdateCalibStatus();
            if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-crosshairs mr-1"></i> Calibrar en plano'; }
        }

        function _clinoResetCalibration() {
            _clinoState.calibOffset = 0;
            try { localStorage.removeItem('pp01_clino_calibration'); } catch(e) {}
            _clinoUpdateCalibStatus();
            const statusEl = document.getElementById('clino_status');
            if (statusEl) {
                statusEl.style.background = '#1e293b';
                statusEl.style.color = '#64748b';
                statusEl.innerHTML = '<i class="fas fa-undo" style="margin-right:4px;"></i> Calibración eliminada';
            }
        }

        // ============================================================
        // MEJORA: Diagnóstico rápido de sensores
        // ============================================================
        async function _clinoRunDiagnostic() {
            const results = [];

            // 1. DeviceOrientation
            const hasOrientation = typeof DeviceOrientationEvent !== 'undefined';
            results.push({
                name: 'Sensor de orientación',
                icon: hasOrientation ? 'fa-check-circle' : 'fa-times-circle',
                color: hasOrientation ? '#22c55e' : '#ef4444',
                detail: hasOrientation ? 'DeviceOrientation disponible' : 'No disponible'
            });

            // 2. GPS
            const hasGeo = 'geolocation' in navigator;
            results.push({
                name: 'GPS / Geolocalización',
                icon: hasGeo ? 'fa-check-circle' : 'fa-times-circle',
                color: hasGeo ? '#22c55e' : '#ef4444',
                detail: hasGeo ? 'Navigator.geolocation disponible' : 'No disponible'
            });

            // 3. localStorage
            let hasStorage = false;
            try { localStorage.setItem('_test', '1'); localStorage.removeItem('_test'); hasStorage = true; } catch(e) {}
            results.push({
                name: 'Almacenamiento local',
                icon: hasStorage ? 'fa-check-circle' : 'fa-exclamation-triangle',
                color: hasStorage ? '#22c55e' : '#f59e0b',
                detail: hasStorage ? 'localStorage funcional' : 'No disponible (calibración no persistirá)'
            });

            // 4. Calibración actual
            const hasCalib = _clinoState.calibOffset > 0;
            results.push({
                name: 'Calibración clinómetro',
                icon: hasCalib ? 'fa-check-circle' : 'fa-info-circle',
                color: hasCalib ? '#22c55e' : '#94a3b8',
                detail: hasCalib ? `Offset: ${_clinoState.calibOffset.toFixed(2)}°` : 'Sin calibrar'
            });

            // 5. Test rápido del sensor (1 segundo)
            if (hasOrientation) {
                let gotReading = false;
                const testHandler = (e) => {
                    if (e.beta !== null || e.gamma !== null) gotReading = true;
                };
                window.addEventListener('deviceorientation', testHandler);
                await new Promise(r => setTimeout(r, 1200));
                window.removeEventListener('deviceorientation', testHandler);
                results.push({
                    name: 'Lectura de sensores',
                    icon: gotReading ? 'fa-check-circle' : 'fa-exclamation-triangle',
                    color: gotReading ? '#22c55e' : '#f59e0b',
                    detail: gotReading ? 'Recibiendo datos del acelerómetro' : 'Sin datos (¿permisos denegados?)'
                });
            }

            // Mostrar resultados
            const html = results.map(r =>
                `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #1e293b;">
                    <i class="fas ${r.icon}" style="color:${r.color};font-size:16px;width:20px;text-align:center;"></i>
                    <div><div style="font-weight:600;font-size:13px;color:#e2e8f0;">${r.name}</div>
                    <div style="font-size:11px;color:#94a3b8;">${r.detail}</div></div>
                </div>`
            ).join('');

            const statusEl = document.getElementById('clino_status');
            if (statusEl) {
                statusEl.style.background = '#0f172a';
                statusEl.style.color = '#e2e8f0';
                statusEl.innerHTML = `<div style="text-align:left;">
                    <div style="font-weight:700;margin-bottom:6px;font-size:12px;text-transform:uppercase;letter-spacing:1px;color:#7dd3fc;">
                        <i class="fas fa-stethoscope" style="margin-right:4px;"></i>Diagnóstico de Sensores
                    </div>
                    ${html}
                    <div style="margin-top:8px;font-size:11px;color:#475569;text-align:center;">Toque "Iniciar Medición" cuando esté listo</div>
                </div>`;
            }
        }

        function setSlopeFromClinometer(arbolId, pendientePct) {
            // Función para recibir el resultado del clinómetro
            const resultDiv = document.getElementById('slope_result_' + arbolId);
            const valueSpan = document.getElementById('slope_value_' + arbolId);
            // También llenar el campo de porcentaje directo para que sea editable
            const pctInput = document.getElementById('val_slope_pct_' + arbolId);
            if (resultDiv && valueSpan) {
                resultDiv.classList.remove('hidden');
                valueSpan.textContent = pendientePct.toFixed(1);
            }
            if (pctInput) {
                pctInput.value = pendientePct.toFixed(1);
            }
        }
        
        function updateSlopeResult(id, mode) {
            let pct = 0;
            const resultDiv = document.getElementById('slope_result_' + id);
            const valueSpan = document.getElementById('slope_value_' + id);
            
            if (mode === 'pct') {
                pct = parseFloat(document.getElementById('val_slope_pct_' + id).value) || 0;
            } else if (mode === 'deg') {
                const deg = parseFloat(document.getElementById('val_slope_deg_' + id).value) || 0;
                pct = Math.tan(deg * Math.PI / 180) * 100;
            } else if (mode === 'calc') {
                const dist = parseFloat(document.getElementById('val_slope_dist_' + id).value) || 0;
                const alt = parseFloat(document.getElementById('val_slope_alt_' + id).value) || 0;
                if (dist > 0) {
                    pct = (alt / dist) * 100;
                }
            }
            
            if (pct !== 0) {
                resultDiv.classList.remove('hidden');
                valueSpan.textContent = pct.toFixed(1);
            } else {
                resultDiv.classList.add('hidden');
            }
        }
        
        function toggleMedidaTipo(id, tipo) {
            const btnDap = document.getElementById('btn_medida_dap_' + id);
            const btnCirc = document.getElementById('btn_medida_circ_' + id);
            const labelMedida = document.getElementById('label_medida_' + id);
            const hiddenInput = document.getElementById('medida_tipo_hidden_' + id);
            
            if (tipo === 'dap') {
                btnDap.classList.remove('bg-white', 'text-gray-600', 'border-gray-300');
                btnDap.classList.add('bg-green-600', 'text-white', 'border-green-600', 'shadow-md');
                btnCirc.classList.remove('bg-green-600', 'text-white', 'border-green-600', 'shadow-md');
                btnCirc.classList.add('bg-white', 'text-gray-600', 'border-gray-300');
                labelMedida.textContent = 'DAP (cm)';
                hiddenInput.value = 'dap';
            } else {
                btnCirc.classList.remove('bg-white', 'text-gray-600', 'border-gray-300');
                btnCirc.classList.add('bg-green-600', 'text-white', 'border-green-600', 'shadow-md');
                btnDap.classList.remove('bg-green-600', 'text-white', 'border-green-600', 'shadow-md');
                btnDap.classList.add('bg-white', 'text-gray-600', 'border-gray-300');
                labelMedida.textContent = 'CAP (cm)';
                hiddenInput.value = 'circunferencia';
            }
            
            calculateVolume(id);
        }
        
        function toggleCoordMode(id, mode) {
            const btnGps = document.getElementById('btn_mode_gps_' + id);
            const btnManual = document.getElementById('btn_mode_manual_' + id);
            const divGps = document.getElementById('coord_gps_' + id);
            const divManual = document.getElementById('coord_manual_' + id);
            
            if (mode === 'gps') {
                btnGps.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-300');
                btnGps.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                btnManual.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                btnManual.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-300');
                divGps.classList.remove('hidden');
                divManual.classList.add('hidden');
            } else {
                btnManual.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-300');
                btnManual.classList.add('bg-amber-500', 'text-white', 'border-amber-500');
                btnGps.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                btnGps.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-300');
                divGps.classList.add('hidden');
                divManual.classList.remove('hidden');
            }
        }
        
        function saveManualCoord(id) {
            const norteInput = document.getElementById('manual_norte_' + id);
            const esteInput = document.getElementById('manual_este_' + id);
            const norte = parseFloat(norteInput.value) || 0;
            const este = parseFloat(esteInput.value) || 0;
            const incertidumbreInput = document.getElementById('manual_incertidumbre_' + id);
            const incertidumbre = parseFloat(incertidumbreInput.value) || 5.0;
            
            if (norte === 0 || este === 0) {
                alert('Por favor ingrese valores válidos para Norte y Este.');
                return;
            }
            
            // Convertir CRTM05 a WGS84 (aproximación)
            const lat = ((norte - 1000000) / 111319.9).toFixed(6);
            const lon = ((-84.0) + ((este - 500000) / (111319.9 * Math.cos(9.9 * Math.PI / 180)))).toFixed(6);
            
            // Crear o actualizar el display de coordenadas
            const displayDiv = document.getElementById('gps_display_' + id);
            const mapOverlay = document.getElementById('map_overlay_' + id);
            
            displayDiv.dataset.norte = norte.toFixed(2);
            displayDiv.dataset.este = este.toFixed(2);
            displayDiv.dataset.lat = lat;
            displayDiv.dataset.lon = lon;
            displayDiv.dataset.ele = "0";
            displayDiv.dataset.incertidumbre = incertidumbre.toFixed(1);
            
            displayDiv.innerHTML = '<div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-3 text-center"><div class="flex items-center justify-center gap-2 mb-2"><i class="fas fa-edit text-amber-600"></i><span class="text-sm font-bold text-amber-700">COORDENADA MANUAL</span></div><div class="grid grid-cols-2 gap-2 text-left mb-2"><div class="bg-white p-2 rounded border border-amber-200"><span class="text-[10px] text-gray-400 block uppercase">Norte (Y)</span><span class="font-mono font-bold text-sm text-gray-800">' + norte.toFixed(2) + '</span></div><div class="bg-white p-2 rounded border border-amber-200"><span class="text-[10px] text-gray-400 block uppercase">Este (X)</span><span class="font-mono font-bold text-sm text-gray-800">' + este.toFixed(2) + '</span></div></div><div class="bg-white p-2 rounded border border-amber-200 mb-2"><span class="text-[10px] text-gray-400 block uppercase">Incertidumbre</span><span class="font-mono font-bold text-sm text-amber-700">± ' + incertidumbre.toFixed(1) + ' m</span></div><div class="text-[10px] text-gray-400 mt-2 text-right">CR-SIRGAS / CRTM05 (EPSG:8908)</div></div>';
            
            displayDiv.classList.remove('hidden');
            if (mapOverlay) mapOverlay.classList.add('hidden');
            
            // Deshabilitar inputs después de guardar
            norteInput.disabled = true;
            esteInput.disabled = true;
            norteInput.classList.add('bg-gray-100');
            esteInput.classList.add('bg-gray-100');
            
            if (incertidumbreInput) {
                incertidumbreInput.disabled = true;
                incertidumbreInput.classList.add('bg-gray-100');
            }
            
            // Cambiar botón a "Editar"
            const saveBtn = document.querySelector('#coord_manual_' + id + ' button');
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-edit mr-1"></i> Editar Coordenadas';
                saveBtn.onclick = function() { editManualCoord(id); };
                saveBtn.classList.remove('bg-amber-500', 'hover:bg-amber-600');
                saveBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
            }
        }
        
        function editManualCoord(id) {
            const norteInput = document.getElementById('manual_norte_' + id);
            const esteInput = document.getElementById('manual_este_' + id);
            
            norteInput.disabled = false;
            esteInput.disabled = false;
            norteInput.classList.remove('bg-gray-100');
            esteInput.classList.remove('bg-gray-100');
            
            const incertidumbreInput = document.getElementById('manual_incertidumbre_' + id);
            if (incertidumbreInput) {
                incertidumbreInput.disabled = false;
                incertidumbreInput.classList.remove('bg-gray-100');
            }
            
            const saveBtn = document.querySelector('#coord_manual_' + id + ' button');
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Guardar Coordenadas';
                saveBtn.onclick = function() { saveManualCoord(id); };
                saveBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                saveBtn.classList.add('bg-amber-500', 'hover:bg-amber-600');
            }
        }
        
        function updateNumDisplay(type, id) {
            const input = document.getElementById('num_' + (type === 'v' ? 'vertice' : 'arbol') + '_' + id);
            const display = document.getElementById('num_display_' + type + id);
            if (input && display) {
                display.textContent = input.value || id;
            }
        }
        function calculateVolume(id){ validateAndCalc(id); }

        // =============================================================================
        // MAPA INTERACTIVO (Leaflet) - Integración NO invasiva (sin tocar funciones existentes)
        // =============================================================================

        // Variables globales nuevas
        let inspeccionMap = null;
        let mapLayers = {
            trees: { group: null, visible: true },
            vertices: { group: null, visible: true },
            observations: { group: null, visible: true },
            track: { layer: null, visible: true }
        };
        let mapCurrentLocationMarker = null;
        let mapAccuracyCircle = null;
        let mapAutoRefreshInterval = null;

        // MEJORA: Bing Aerial tile layer (usa quadkeys en vez de z/x/y)
        L.TileLayer.BingAerial = L.TileLayer.extend({
            options: { subdomains: '0123', maxNativeZoom: 19, maxZoom: 22, attribution: 'Tiles &copy; Microsoft Bing', errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQI12NgAAIABQABNjN9GQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAA0lEQVQI12P4z8BQDwAEgAF/QualzQAAAABJRU5ErkJggg==' },
            getTileUrl: function(c) {
                let q = '';
                for (let i = c.z; i > 0; i--) { let d = 0; const m = 1 << (i - 1); if ((c.x & m) !== 0) d++; if ((c.y & m) !== 0) d += 2; q += d; }
                return 'https://ecn.t' + this.options.subdomains[Math.abs(c.x + c.y) % 4] + '.tiles.virtualearth.net/tiles/a' + q + '.jpeg?g=14205';
            }
        });

        // MEJORA: Variables globales para consulta multi-capa WMS
        window._mapQueryMode = false;
        window._wmsQueryLayers = [];
        window._lastWmsQueryResults = null;
        window._lastWmsQueryLatLng = null;

        function initializeMap() {
            try {
                if (!inspeccionIniciada) return;

                const mapContainer = document.getElementById('inspeccion_map');
                if (!mapContainer) return;

                // Si ya existe, solo actualizar
                if (inspeccionMap) {
                    setTimeout(() => { try { inspeccionMap.invalidateSize(); } catch(e){} }, 200);
                    updateMapLayers();
                    return;
                }

                // Limpiar placeholder
                mapContainer.innerHTML = "";

                // Crear mapa
                inspeccionMap = L.map('inspeccion_map', {
                    zoomControl: true,
                    attributionControl: true,
                    tap: true,
                    dragging: true,
                    maxZoom: 22
                });

                // ── Capas Base ──
                // MEJORA: OpenTopoMap con relieve (capa offline por defecto)
                const _errTile = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQI12NgAAIABQABNjN9GQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAA0lEQVQI12P4z8BQDwAEgAF/QualzQAAAABJRU5ErkJggg==';
                const openTopo = L.tileLayer(
                    'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
                    { subdomains: 'abc', maxNativeZoom: 17, maxZoom: 22, attribution: '&copy; OpenTopoMap', errorTileUrl: _errTile }
                );
                // Google Híbrido (satélite + etiquetas)
                const googleHybrid = L.tileLayer(
                    'https://mt{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
                    { subdomains: '0123', maxNativeZoom: 20, maxZoom: 22, attribution: 'Tiles &copy; Google', errorTileUrl: _errTile }
                );
                // Esri World Imagery
                const esriImagery = L.tileLayer(
                    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    { maxNativeZoom: 19, maxZoom: 22, attribution: 'Tiles &copy; Esri', errorTileUrl: _errTile }
                );
                // MEJORA: Bing Aerial
                const bingAerial = new L.TileLayer.BingAerial();

                openTopo.addTo(inspeccionMap); // Default — disponible offline

                // ── Capas WMS Overlay ──
                // Catastro SNIT (existente — se mantiene igual)
                const snitWmsUrl = 'https://siri.snitcr.go.cr/Geoservicios/wms';
                const snitZona1 = L.tileLayer.wms(snitWmsUrl, {
                    layers: 'RI_CA_AC_ZONA1_1K_5K', format: 'image/png', transparent: true,
                    version: '1.1.1', opacity: 0.7, maxZoom: 22, attribution: 'Catastro &copy; SNIT-IGN CR',
                    crs: L.CRS.EPSG4326
                });
                // MEJORA: Cauces y Drenaje (IGN Cartografía 1:25mil)
                const ignWmsUrl = 'https://geos.snitcr.go.cr/be/IGN_25/wms';
                const ignCauces = L.tileLayer.wms(ignWmsUrl, {
                    layers: 'caucedrenaje_25k', format: 'image/png', transparent: true,
                    version: '1.1.1', opacity: 0.8, maxZoom: 22, attribution: 'IGN-CR 1:25k',
                    styles: '', crs: L.CRS.EPSG4326
                });
                // MEJORA: Dictámenes Dirección de Agua (MINAE)
                const daWmsUrl = 'https://mapas.da.go.cr/geopc.php';
                const daDictPI = L.tileLayer.wms(daWmsUrl, {
                    layers: 'DA_Dictamenes_Punto_Inicial', format: 'image/png', transparent: true,
                    version: '1.1.1', opacity: 0.8, maxZoom: 22, attribution: 'DA-MINAE',
                    crs: L.CRS.EPSG4326
                });
                const daDictPF = L.tileLayer.wms(daWmsUrl, {
                    layers: 'DA_Dictamenes_Punto_Final', format: 'image/png', transparent: true,
                    version: '1.1.1', opacity: 0.8, maxZoom: 22, attribution: 'DA-MINAE',
                    crs: L.CRS.EPSG4326
                });

                // Control de capas Leaflet
                const baseLayers = {
                    '🏔️ Topográfico (offline)': openTopo,
                    'Google Híbrido': googleHybrid,
                    'Esri Aérea': esriImagery,
                    'Bing Aérea': bingAerial
                };
                const overlays = {
                    '📐 Catastro Zona 1': snitZona1,
                    '🌊 Cauces y Drenaje': ignCauces,
                    '💧 Dict. Pto. Inicial': daDictPI,
                    '💧 Dict. Pto. Final': daDictPF
                };
                L.control.layers(baseLayers, overlays, { position: 'topright', collapsed: true }).addTo(inspeccionMap);

                // ── Registro WMS para consulta multi-capa ──
                window._wmsQueryLayers = [
                    {
                        name: 'Catastro', layer: snitZona1, url: snitWmsUrl,
                        queryLayer: 'RI_CA_AC_ZONA1_1K_5K', icon: 'fa-map', color: '#1e40af',
                        fields: null, minZoom: 15 // null = handler especial para catastro
                    },
                    {
                        name: 'Cauces y Drenaje', layer: ignCauces, url: ignWmsUrl,
                        queryLayer: 'caucedrenaje_25k', icon: 'fa-water', color: '#2563eb',
                        fields: ['nom_objeto', 'nombre'], minZoom: 13
                    },
                    {
                        name: 'Dict. Pto. Inicial', layer: daDictPI, url: daWmsUrl,
                        queryLayer: 'DA_Dictamenes_Punto_Inicial', icon: 'fa-tint', color: '#0891b2',
                        fields: ['TIPO_DE_FUENTE', 'NUMERO_DE_OFICIO', 'CRITERIO'], minZoom: 10
                    },
                    {
                        name: 'Dict. Pto. Final', layer: daDictPF, url: daWmsUrl,
                        queryLayer: 'DA_Dictamenes_Punto_Final', icon: 'fa-tint', color: '#0e7490',
                        fields: ['TIPO_DE_FUENTE', 'NUMERO_DE_OFICIO', 'CRITERIO'], minZoom: 10
                    }
                ];

                // ── Botón toggle "Modo Consulta WMS" ──
                const QueryCtrl = L.Control.extend({
                    options: { position: 'topleft' },
                    onAdd: function() {
                        const c = L.DomUtil.create('div', 'leaflet-bar');
                        c.innerHTML = '<a id="btn_map_query" href="#" title="Activar/desactivar consulta WMS" style="width:36px;height:36px;line-height:36px;text-align:center;font-size:17px;background:#fff;color:#666;display:block;text-decoration:none;border-radius:4px;"><i class="fas fa-info-circle"></i></a>';
                        L.DomEvent.disableClickPropagation(c);
                        c.querySelector('a').addEventListener('click', function(ev) {
                            ev.preventDefault();
                            window._mapQueryMode = !window._mapQueryMode;
                            this.style.background = window._mapQueryMode ? '#2563eb' : '#fff';
                            this.style.color = window._mapQueryMode ? '#fff' : '#666';
                            this.title = window._mapQueryMode ? 'Consulta WMS ACTIVA — toque el mapa' : 'Activar consulta WMS';
                        });
                        return c;
                    }
                });
                new QueryCtrl().addTo(inspeccionMap);

                // ── Monitoreo de errores en tiles WMS ──
                [snitZona1, ignCauces, daDictPI, daDictPF].forEach((lyr, i) => {
                    const names = ['Catastro', 'Cauces IGN', 'Dict.PI DA', 'Dict.PF DA'];
                    let errCount = 0;
                    lyr.on('tileerror', function(e) {
                        errCount++;
                        if (errCount <= 3) console.warn('[WMS ' + names[i] + '] Error cargando tile #' + errCount + ':', e.tile?.src?.substring(0, 150));
                        if (errCount === 3) console.warn('[WMS ' + names[i] + '] ⚠️ Múltiples errores — posible problema con el servidor WMS');
                    });
                    lyr.on('tileload', function() {
                        if (!lyr._pp01logged) { console.log('[WMS ' + names[i] + '] ✅ Tiles cargando OK'); lyr._pp01logged = true; }
                    });
                    lyr.on('loading', function() {
                        console.log('[WMS ' + names[i] + '] 🔄 Solicitando tiles...');
                    });
                });

                // ── Click handler: consulta multi-capa WMS ──
                inspeccionMap.on('click', function(e) {
                    if (!window._mapQueryMode) return;
                    _queryAllWmsLayers(e);
                });

                console.log('[PP01] WMS configurado: 4 capas overlay (Catastro, Cauces, Dict.PI, Dict.PF), botón consulta ℹ️ activo');

                // Grupos (cluster para puntos)
                mapLayers.trees.group = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 45 });
                mapLayers.vertices.group = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 45 });
                mapLayers.observations.group = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 45 });

                if (mapLayers.trees.visible) inspeccionMap.addLayer(mapLayers.trees.group);
                if (mapLayers.vertices.visible) inspeccionMap.addLayer(mapLayers.vertices.group);
                if (mapLayers.observations.visible) inspeccionMap.addLayer(mapLayers.observations.group);

                // Track (polyline)
                mapLayers.track.layer = L.polyline([], { color: '#2563eb', weight: 5, opacity: 0.55 });
                if (mapLayers.track.visible) mapLayers.track.layer.addTo(inspeccionMap);

                // Vista inicial (Costa Rica aproximado)
                inspeccionMap.setView([9.9, -84.1], 15);

                // Ajuste de tamaño (responsive)
                setTimeout(() => { try { inspeccionMap.invalidateSize(); } catch(e){} }, 250);

                // Refresco automático (track + ubicación actual + puntos guardados)
                if (mapAutoRefreshInterval) clearInterval(mapAutoRefreshInterval);
                mapAutoRefreshInterval = setInterval(() => {
                    try {
                        if (inspeccionIniciada && inspeccionMap) updateMapLayers();
                    } catch(e){}
                }, 5000);

                updateMapLayers();
                centerMapOnData();
            } catch (err) {
                console.error('Error initializeMap:', err);
            }
        }

        function updateMapLayers() {
            try {
                if (!inspeccionIniciada || !inspeccionMap) return;

                // --- Árboles ---
                if (mapLayers.trees.group) mapLayers.trees.group.clearLayers();
                const arbolBlocks = Array.from(document.querySelectorAll('#container_arboles > div[id^="arbol_"][data-saved="true"]'));
                arbolBlocks.forEach((b) => {
                    const id = b.id.split('_')[1];
                    addTreeToMap(id);
                });

                // --- Vértices ---
                if (mapLayers.vertices.group) mapLayers.vertices.group.clearLayers();
                const vertBlocks = Array.from(document.querySelectorAll('#container_vertices > div[id^="vertice_"][data-saved="true"]'));
                vertBlocks.forEach((b) => {
                    const id = b.id.split('_').pop();
                    addVerticeToMap(id);
                });

                // --- Observaciones ---
                if (mapLayers.observations.group) mapLayers.observations.group.clearLayers();
                const obsBlocks = Array.from(document.querySelectorAll('#container_obs_finales > div[id^="obs_"][data-saved="true"]'));
                obsBlocks.forEach((b, idx) => {
                    const id = b.id.split('_').pop();
                    addObservationToMap(id, idx);
                });

                // --- Track ---
                updateTrackOnMap();

                // --- Ubicación actual + precisión (desde último punto del track) ---
                updateCurrentLocationOnMap();

            } catch (err) {
                console.error('Error updateMapLayers:', err);
            }
        }

        function addTreeToMap(treeId) {
            try {
                if (!mapLayers.trees.group) return;

                const gpsDisplay = document.getElementById(`gps_display_t${treeId}`);
                if (!gpsDisplay || !gpsDisplay.dataset || !gpsDisplay.dataset.lat || !gpsDisplay.dataset.lon) return;

                const lat = parseFloat(gpsDisplay.dataset.lat);
                const lon = parseFloat(gpsDisplay.dataset.lon);
                if (!isFinite(lat) || !isFinite(lon)) return;

                const treeNumEl = document.getElementById(`num_arbol_${treeId}`);
                const treeNum = treeNumEl ? String(treeNumEl.value || treeId) : String(treeId);

                const speciesEl = document.getElementById(`sp_arbol_${treeId}`);
                const species = speciesEl ? (speciesEl.value || '') : '';

                const icon = L.divIcon({
                    className: '',
                    html: `<div style="display:flex;flex-direction:column;align-items:center;transform:translateY(-4px);">
                            <div style="width:34px;height:34px;border-radius:10px;background:rgba(22,101,52,0.95);border:2px solid #052e16;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.35);">
                                <i class="fas fa-tree" style="color:white;font-size:18px;"></i>
                            </div>
                            <div style="margin-top:4px;padding:2px 7px;border-radius:8px;background:rgba(255,255,255,0.95);border:2px solid #166534;font-weight:900;font-size:12px;color:#166534;box-shadow:0 2px 6px rgba(0,0,0,0.2);">
                                ${treeNum}
                            </div>
                        </div>`,
                    iconSize: [34, 44],
                    iconAnchor: [17, 44],
                    popupAnchor: [0, -42]
                });

                const popup = `<div style="font-family:Roboto, sans-serif; font-size:14px;">
                                <div style="font-weight:900; color:#14532d;">Árbol #${treeNum}</div>
                                ${species ? `<div style="margin-top:4px;"><b>Especie:</b> ${escapeHtml(species)}</div>` : ''}
                                <div style="margin-top:6px; font-family:SF Mono, monospace; color:#111827;">
                                    ${lat.toFixed(6)}, ${lon.toFixed(6)}
                                </div>
                            </div>`;

                const marker = L.marker([lat, lon], { icon });
                marker.bindPopup(popup);

                mapLayers.trees.group.addLayer(marker);
            } catch (err) {
                console.error('Error addTreeToMap:', err);
            }
        }

        function addVerticeToMap(verticeId) {
            try {
                if (!mapLayers.vertices.group) return;

                const gpsDisplay = document.getElementById(`gps_display_v${verticeId}`);
                if (!gpsDisplay || !gpsDisplay.dataset || !gpsDisplay.dataset.lat || !gpsDisplay.dataset.lon) return;

                const lat = parseFloat(gpsDisplay.dataset.lat);
                const lon = parseFloat(gpsDisplay.dataset.lon);
                if (!isFinite(lat) || !isFinite(lon)) return;

                const numEl = document.getElementById(`num_vertice_${verticeId}`);
                const numVal = numEl ? String(numEl.value || verticeId) : String(verticeId);

                const label = `V${numVal}`;

                const icon = L.divIcon({
                    className: '',
                    html: `<div style="display:flex;flex-direction:column;align-items:center;transform:translateY(-4px);">
                            <div style="width:34px;height:34px;border-radius:10px;background:rgba(37,99,235,0.95);border:2px solid #1e3a8a;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.35);">
                                <i class="fas fa-flag" style="color:white;font-size:18px;"></i>
                            </div>
                            <div style="margin-top:4px;padding:2px 7px;border-radius:8px;background:rgba(255,255,255,0.95);border:2px solid #2563eb;font-weight:900;font-size:12px;color:#1d4ed8;box-shadow:0 2px 6px rgba(0,0,0,0.2);">
                                ${label}
                            </div>
                        </div>`,
                    iconSize: [34, 44],
                    iconAnchor: [17, 44],
                    popupAnchor: [0, -42]
                });

                const popup = `<div style="font-family:Roboto, sans-serif; font-size:14px;">
                                <div style="font-weight:900; color:#1d4ed8;">Vértice ${label}</div>
                                <div style="margin-top:6px; font-family:SF Mono, monospace; color:#111827;">
                                    ${lat.toFixed(6)}, ${lon.toFixed(6)}
                                </div>
                            </div>`;

                const marker = L.marker([lat, lon], { icon }).bindPopup(popup);
                mapLayers.vertices.group.addLayer(marker);
            } catch (err) {
                console.error('Error addVerticeToMap:', err);
            }
        }

        function addObservationToMap(obsId, obsIndex) {
            try {
                if (!mapLayers.observations.group) return;

                const gpsDisplay = document.getElementById(`gps_display_o${obsId}`);
                if (!gpsDisplay || !gpsDisplay.dataset || !gpsDisplay.dataset.lat || !gpsDisplay.dataset.lon) return;

                const lat = parseFloat(gpsDisplay.dataset.lat);
                const lon = parseFloat(gpsDisplay.dataset.lon);
                if (!isFinite(lat) || !isFinite(lon)) return;

                // Etiqueta A, B, C...
                const letter = String.fromCharCode(65 + (obsIndex % 26));

                const txtEl = document.getElementById(`detalle_obs_${obsId}`);
                const txt = txtEl ? (txtEl.value || '') : '';

                const icon = L.divIcon({
                    className: '',
                    html: `<div style="display:flex;flex-direction:column;align-items:center;transform:translateY(-4px);">
                            <div style="width:34px;height:34px;border-radius:10px;background:rgba(124,58,237,0.95);border:2px solid #4c1d95;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.35);">
                                <i class="fas fa-note-sticky" style="color:white;font-size:18px;"></i>
                            </div>
                            <div style="margin-top:4px;padding:2px 7px;border-radius:8px;background:rgba(255,255,255,0.95);border:2px solid #7c3aed;font-weight:900;font-size:12px;color:#5b21b6;box-shadow:0 2px 6px rgba(0,0,0,0.2);">
                                ${letter}
                            </div>
                        </div>`,
                    iconSize: [34, 44],
                    iconAnchor: [17, 44],
                    popupAnchor: [0, -42]
                });

                const popup = `<div style="font-family:Roboto, sans-serif; font-size:14px;">
                                <div style="font-weight:900; color:#5b21b6;">Observación ${letter}</div>
                                ${txt ? `<div style="margin-top:6px;"><b>Texto:</b> ${escapeHtml(txt).slice(0, 220)}${txt.length>220?'…':''}</div>` : ''}
                                <div style="margin-top:8px; font-family:SF Mono, monospace; color:#111827;">
                                    ${lat.toFixed(6)}, ${lon.toFixed(6)}
                                </div>
                            </div>`;

                const marker = L.marker([lat, lon], { icon }).bindPopup(popup);
                mapLayers.observations.group.addLayer(marker);
            } catch (err) {
                console.error('Error addObservationToMap:', err);
            }
        }

        function updateTrackOnMap() {
            try {
                if (!mapLayers.track.layer) return;

                const coords = (Array.isArray(trackPoints) ? trackPoints : [])
                    .filter(p => p && isFinite(p.lat) && isFinite(p.lon))
                    .map(p => [p.lat, p.lon]);

                mapLayers.track.layer.setLatLngs(coords);

                // Estilo visible / oculto
                if (mapLayers.track.visible) {
                    if (!inspeccionMap.hasLayer(mapLayers.track.layer)) mapLayers.track.layer.addTo(inspeccionMap);
                } else {
                    if (inspeccionMap.hasLayer(mapLayers.track.layer)) inspeccionMap.removeLayer(mapLayers.track.layer);
                }
            } catch (err) {
                console.error('Error updateTrackOnMap:', err);
            }
        }

        function updateCurrentLocationOnMap() {
            try {
                if (!Array.isArray(trackPoints) || trackPoints.length === 0) return;

                const last = trackPoints[trackPoints.length - 1];
                if (!last || !isFinite(last.lat) || !isFinite(last.lon)) return;

                let latlng = [last.lat, last.lon];

                // Suavizado visual para el marcador (NO altera trackPoints)
                const sm = getSmoothedLatLngFromBuffer();
                if (sm && sm.length === 2) { latlng = sm; }
                const acc = isFinite(last.accuracy) ? Number(last.accuracy) : null;

                const icon = L.divIcon({
                    className: '',
                    html: `<div style="width:20px;height:20px;border-radius:50%;background:#ef4444;border:3px solid white;box-shadow:0 2px 10px rgba(0,0,0,0.45);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                if (!mapCurrentLocationMarker) {
                    mapCurrentLocationMarker = L.marker(latlng, { icon }).addTo(inspeccionMap);
                } else {
                    mapCurrentLocationMarker.setLatLng(latlng);
                    if (!inspeccionMap.hasLayer(mapCurrentLocationMarker)) mapCurrentLocationMarker.addTo(inspeccionMap);
                }

                if (acc && acc > 0 && acc < 500) {
                    if (!mapAccuracyCircle) {
                        mapAccuracyCircle = L.circle(latlng, { radius: acc, color: '#ef4444', weight: 2, opacity: 0.6, fillOpacity: 0.08 });
                        mapAccuracyCircle.addTo(inspeccionMap);
                    } else {
                        mapAccuracyCircle.setLatLng(latlng);
                        mapAccuracyCircle.setRadius(acc);
                        if (!inspeccionMap.hasLayer(mapAccuracyCircle)) mapAccuracyCircle.addTo(inspeccionMap);
                    }
                } else if (mapAccuracyCircle && inspeccionMap.hasLayer(mapAccuracyCircle)) {
                    inspeccionMap.removeLayer(mapAccuracyCircle);
                }
            } catch (err) {
                console.error('Error updateCurrentLocationOnMap:', err);
            }
        }

        function toggleMapLayer(layerName) {
            try {
                if (!mapLayers[layerName]) return;

                // Alternar visibilidad
                mapLayers[layerName].visible = !mapLayers[layerName].visible;

                // Layer (group o polyline)
                const layerObj = mapLayers[layerName].group || mapLayers[layerName].layer;
                if (layerObj && inspeccionMap) {
                    const has = inspeccionMap.hasLayer(layerObj);
                    if (mapLayers[layerName].visible && !has) inspeccionMap.addLayer(layerObj);
                    if (!mapLayers[layerName].visible && has) inspeccionMap.removeLayer(layerObj);
                }

                // Estilo de botón
                const btn = document.querySelector(`.map-layer-btn[data-layer="${layerName}"]`);
                if (btn) {
                    if (mapLayers[layerName].visible) btn.classList.add('active');
                    else btn.classList.remove('active');
                }

                // Recalcular vista si se ocultó/mostró
                setTimeout(() => { try { centerMapOnData(); } catch(e){} }, 80);
            } catch (err) {
                console.error('Error toggleMapLayer:', err);
            }
        }

        function centerMapOnData() {
            try {
                if (!inspeccionMap) return;

                // Forzar recálculo de tamaño (crucial en PC / cambio de vista)
                try { inspeccionMap.invalidateSize(); } catch(e){}

                const bounds = L.latLngBounds([]);

                // Puntos de track (si visible)
                if (mapLayers.track.visible && Array.isArray(trackPoints) && trackPoints.length) {
                    trackPoints.forEach(p => {
                        if (p && isFinite(p.lat) && isFinite(p.lon)) bounds.extend([p.lat, p.lon]);
                    });
                }

                // Árboles / vértices / observaciones si visibles
                const extendFromGroup = (group) => {
                    if (!group) return;
                    try {
                        group.eachLayer((lyr) => {
                            if (lyr && lyr.getLatLng) bounds.extend(lyr.getLatLng());
                        });
                    } catch(e){}
                };
                if (mapLayers.trees.visible) extendFromGroup(mapLayers.trees.group);
                if (mapLayers.vertices.visible) extendFromGroup(mapLayers.vertices.group);
                if (mapLayers.observations.visible) extendFromGroup(mapLayers.observations.group);

                // Ubicación actual (marcador existente)
                if (mapCurrentLocationMarker && mapCurrentLocationMarker.getLatLng) bounds.extend(mapCurrentLocationMarker.getLatLng());

                if (bounds.isValid()) {
                    inspeccionMap.fitBounds(bounds, { padding: [18, 18], maxZoom: 18 });
                } else {
                    // Sin datos guardados: intentar obtener GPS en vivo
                    if ('geolocation' in navigator) {
                        navigator.geolocation.getCurrentPosition(
                            function(pos) {
                                const lat = pos.coords.latitude;
                                const lon = pos.coords.longitude;
                                if (isFinite(lat) && isFinite(lon)) {
                                    inspeccionMap.setView([lat, lon], 17);
                                    // Mostrar pulso de ubicación temporal
                                    const pulse = L.circleMarker([lat, lon], {
                                        radius: 10, color: '#2563eb', fillColor: '#3b82f6',
                                        fillOpacity: 0.5, weight: 2
                                    }).addTo(inspeccionMap);
                                    setTimeout(() => { try { inspeccionMap.removeLayer(pulse); } catch(e){} }, 3000);
                                }
                            },
                            function() {
                                // GPS falló: fallback a CR central
                                inspeccionMap.setView([9.93, -84.09], 15);
                            },
                            { enableHighAccuracy: true, timeout: 5000, maximumAge: 30000 }
                        );
                    } else {
                        inspeccionMap.setView([9.93, -84.09], 15);
                    }
                }
            } catch (err) {
                console.error('Error centerMapOnData:', err);
            }
        }

        // Utilidad: escapar HTML para popups (no altera nada existente)
        function escapeHtml(str) {
            try {
                return String(str)
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;')
                    .replaceAll('"', '&quot;')
                    .replaceAll("'", '&#039;');
            } catch(e) {
                return String(str);
            }
        }

        // Integración NO invasiva:
        // - Se activa al hacer click en "Iniciar"
        // - Se refresca al guardar Árbol/Vértice/Observación (por click en botones) sin tocar funciones existentes
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Iniciar inspección (sin tocar onclick existente)
                const btnStart = document.getElementById('btn_iniciar');
                if (btnStart) {
                    btnStart.addEventListener('click', () => {
                        setTimeout(() => {
                            try { initializeMap(); } catch(e){}
                        }, 150);
                    });
                }

                // Refresco al guardar/editar/borrar en cualquier sección (delegado)
                document.addEventListener('click', (ev) => {
                    try {
                        const el = ev.target.closest('button');
                        if (!el) return;

                        // detectar llamadas inline en onclick
                        const oc = el.getAttribute('onclick') || '';
                        const shouldRefresh =
                            oc.includes('saveArbolData(') ||
                            oc.includes('saveVerticeData(') ||
                            oc.includes('saveObservacionData(') ||
                            oc.includes('editArbolData(') ||
                            oc.includes('editVerticeData(') ||
                            oc.includes('editObservacionData(') ||
                            oc.includes('removeArbol(') ||
                            oc.includes('removeVertice(') ||
                            oc.includes('removeObservacion(');

                        if (shouldRefresh) {
                            setTimeout(() => {
                                try { if (inspeccionIniciada) { initializeMap(); updateMapLayers(); } } catch(e){}
                            }, 200);
                        }
                    } catch(e){}
                }, true);

                // Si la inspección ya está iniciada al cargar (caso de restauración), intentar mapa
                setTimeout(() => {
                    try { if (inspeccionIniciada) initializeMap(); } catch(e){}
                }, 400);

            } catch (err) {
                console.error('Error DOMContentLoaded map init:', err);
            }
        });

        // ============================================================================
        // MEJORA: Sistema de consulta multi-capa WMS (GetFeatureInfo)
        // ============================================================================

        async function _queryAllWmsLayers(e) {
            try {
                if (!inspeccionMap) return;
                const zoom = inspeccionMap.getZoom();
                const size = inspeccionMap.getSize();
                const bounds = inspeccionMap.getBounds();
                const sw = bounds.getSouthWest(), ne = bounds.getNorthEast();
                const bbox = `${sw.lng},${sw.lat},${ne.lng},${ne.lat}`;
                const pt = inspeccionMap.latLngToContainerPoint(e.latlng);

                // Filtrar capas WMS activas y visibles al zoom actual
                const active = (window._wmsQueryLayers || []).filter(wl =>
                    inspeccionMap.hasLayer(wl.layer) && zoom >= wl.minZoom
                );

                if (active.length === 0) {
                    L.popup({ maxWidth: 280 }).setLatLng(e.latlng)
                        .setContent('<div style="text-align:center;padding:8px;color:#888;font-size:13px"><i class="fas fa-layer-group" style="margin-right:4px;"></i> Active alguna capa WMS desde el control de capas (esquina superior derecha) y haga zoom suficiente para consultar</div>')
                        .openOn(inspeccionMap);
                    return;
                }

                // Popup de carga
                const popup = L.popup({ maxWidth: 320, maxHeight: 420 }).setLatLng(e.latlng)
                    .setContent(`<div style="text-align:center;padding:10px;font-size:13px"><i class="fas fa-spinner fa-spin" style="margin-right:4px;"></i> Consultando ${active.length} capa(s)...</div>`)
                    .openOn(inspeccionMap);

                // Helper: construir URL de GetFeatureInfo
                function _buildGfiUrl(wl, infoFormat) {
                    const sep = wl.url.includes('?') ? '&' : '?';
                    return wl.url + sep +
                        'SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo' +
                        '&LAYERS=' + encodeURIComponent(wl.queryLayer) +
                        '&QUERY_LAYERS=' + encodeURIComponent(wl.queryLayer) +
                        '&INFO_FORMAT=' + encodeURIComponent(infoFormat) +
                        '&SRS=EPSG%3A4326' +
                        '&BBOX=' + encodeURIComponent(bbox) +
                        '&WIDTH=' + size.x + '&HEIGHT=' + size.y +
                        '&X=' + Math.round(pt.x) + '&Y=' + Math.round(pt.y) +
                        '&FEATURE_COUNT=5';
                }

                // Consultar todas las capas en paralelo — con fallback CORS→iframe
                const results = await Promise.allSettled(active.map(async (wl) => {
                    // Paso 1: Intentar fetch con JSON (rápido, con timeout corto)
                    try {
                        const jsonUrl = _buildGfiUrl(wl, 'application/json');
                        const resp = await fetch(jsonUrl, { signal: AbortSignal.timeout(5000) });
                        if (!resp.ok) throw new Error('HTTP ' + resp.status);
                        const ct = resp.headers.get('content-type') || '';
                        if (ct.includes('json')) {
                            const data = await resp.json();
                            const features = data.features || [];
                            if (features.length > 0) return { wl, features, method: 'json' };
                            return { wl, features: [], method: 'json' };
                        }
                        // Respuesta no-JSON (XML, GML, texto)
                        const txt = await resp.text();
                        if (txt && txt.trim().length > 30 && !txt.includes('no features') && !txt.includes('<ServiceException')) {
                            return { wl, features: [{ properties: { _raw_text: txt }, _isText: true }], method: 'text' };
                        }
                        return { wl, features: [], method: 'text' };
                    } catch (fetchErr) {
                        // Paso 2: fetch falló (CORS, timeout, red) → marcar para iframe
                        console.warn('[WMS Query ' + wl.name + '] fetch falló (' + (fetchErr.message || 'CORS') + '), usando iframe');
                        return { wl, features: [], method: 'cors_blocked', iframeUrl: _buildGfiUrl(wl, 'text/html') };
                    }
                }));

                // Separar resultados con datos vs bloqueados por CORS
                const hits = [];
                const corsBlocked = [];
                results.forEach(r => {
                    if (r.status !== 'fulfilled') return;
                    const v = r.value;
                    if (v.method === 'cors_blocked') {
                        corsBlocked.push(v);
                    } else if (v.features.length > 0) {
                        hits.push(v);
                    }
                });

                // Caso 1: Hay datos JSON parseados
                if (hits.length > 0 && corsBlocked.length === 0) {
                    window._lastWmsQueryResults = hits;
                    window._lastWmsQueryLatLng = e.latlng;
                    popup.setContent(hits.length === 1 ? _fmtWmsResult(hits[0], false) : _fmtWmsSelector(hits));
                    return;
                }

                // Caso 2: Alguna capa bloqueada por CORS → mostrar resultados mixtos
                if (corsBlocked.length > 0) {
                    let h = '<div style="font-size:13px;">';

                    // Mostrar datos JSON primero (si hay)
                    if (hits.length > 0) {
                        window._lastWmsQueryResults = hits;
                        hits.forEach((hit, idx) => {
                            h += `<div style="margin-bottom:6px;padding:6px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:6px;">`;
                            h += `<div style="font-weight:bold;color:${hit.wl.color};font-size:12px;margin-bottom:2px;"><i class="fas ${hit.wl.icon}" style="margin-right:3px;"></i>${hit.wl.name}</div>`;
                            h += `<div style="font-size:11px;color:#334155;">${escapeHtml(_getWmsPreview(hit))}</div>`;
                            h += `</div>`;
                        });
                    }

                    // Mostrar capas bloqueadas en iframes
                    corsBlocked.forEach(cb => {
                        h += `<div style="margin-bottom:6px;">`;
                        h += `<div style="font-weight:bold;color:${cb.wl.color};font-size:12px;margin-bottom:2px;"><i class="fas ${cb.wl.icon}" style="margin-right:3px;"></i>${cb.wl.name}</div>`;
                        h += `<iframe src="${cb.iframeUrl}" style="width:100%;height:150px;border:1px solid #e2e8f0;border-radius:4px;background:#fff;" sandbox="allow-same-origin"></iframe>`;
                        h += `</div>`;
                    });

                    h += '</div>';
                    popup.setContent(h);
                    return;
                }

                // Caso 3: Sin datos en ninguna capa
                popup.setContent('<div style="text-align:center;padding:10px;color:#888;font-size:13px"><i class="fas fa-search" style="margin-right:4px;"></i> Sin datos en este punto</div>');

            } catch (err) {
                console.error('Error _queryAllWmsLayers:', err);
            }
        }

        // Selector cuando hay múltiples capas con resultados
        function _fmtWmsSelector(hits) {
            let h = '<div style="font-size:13px;"><div style="font-weight:bold;border-bottom:1px solid #ddd;padding-bottom:4px;margin-bottom:6px;color:#334155"><i class="fas fa-layer-group" style="margin-right:4px;"></i> Capas encontradas</div>';
            hits.forEach((hit, idx) => {
                const preview = _getWmsPreview(hit);
                h += `<div onclick="_showWmsResult(${idx})" style="cursor:pointer;padding:8px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;margin-bottom:4px;" onmouseenter="this.style.background='#eff6ff'" onmouseleave="this.style.background='#f8fafc'"><div style="display:flex;align-items:center;gap:6px;"><i class="fas ${hit.wl.icon}" style="color:${hit.wl.color};font-size:15px;width:18px;text-align:center;"></i><div style="flex:1;min-width:0;"><div style="font-weight:600;font-size:13px;color:#1e293b;">${hit.wl.name}</div><div style="font-size:11px;color:#64748b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(preview)}</div></div><i class="fas fa-chevron-right" style="color:#94a3b8;font-size:11px;"></i></div></div>`;
            });
            h += '</div>';
            return h;
        }

        // Vista previa breve de un resultado
        function _getWmsPreview(hit) {
            const p = hit.features[0]?.properties || {};
            if (hit.wl.fields === null) {
                // Catastro
                const finca = p.FINCA || p.finca || p.NFINCA || p.nfinca || p.NUM_FINCA || '';
                const plano = p.PLANO || p.plano || p.NPLANO || p.nplano || p.NUM_PLANO || '';
                if (finca) return 'Finca: ' + finca;
                if (plano) return 'Plano: ' + plano;
                return 'Datos disponibles';
            }
            for (const f of hit.wl.fields) {
                const v = p[f] || p[f.toLowerCase()] || p[f.toUpperCase()];
                if (v) return f + ': ' + String(v).slice(0, 45);
            }
            return hit.features.length + ' resultado(s)';
        }

        // Mostrar resultado de una capa específica
        function _showWmsResult(idx) {
            const hits = window._lastWmsQueryResults;
            if (!hits || !hits[idx] || !inspeccionMap || !inspeccionMap._popup) return;
            inspeccionMap._popup.setContent(_fmtWmsResult(hits[idx], hits.length > 1));
        }

        // Volver al selector
        function _showWmsSelector() {
            const hits = window._lastWmsQueryResults;
            if (!hits || !inspeccionMap || !inspeccionMap._popup) return;
            inspeccionMap._popup.setContent(_fmtWmsSelector(hits));
        }

        // Formatear resultado de una capa WMS
        function _fmtWmsResult(hit, showBack) {
            const wl = hit.wl;
            const feat = hit.features[0];
            const p = feat.properties || {};
            let h = '<div style="font-size:13px;line-height:1.6">';

            if (showBack) {
                h += '<div onclick="_showWmsSelector()" style="cursor:pointer;color:#2563eb;font-size:12px;margin-bottom:4px;font-weight:600;"><i class="fas fa-arrow-left" style="margin-right:3px;"></i> Volver a lista</div>';
            }

            h += `<div style="font-weight:bold;color:${wl.color};border-bottom:1px solid #ddd;padding-bottom:3px;margin-bottom:4px"><i class="fas ${wl.icon}" style="margin-right:3px;"></i> ${wl.name}</div>`;

            // Si es respuesta texto crudo (no JSON)
            if (feat._isText) {
                h += '<div style="font-size:12px;max-height:180px;overflow:auto">' + p._raw_text + '</div>';
                h += '</div>';
                return h;
            }

            if (wl.fields === null) {
                // Handler especial para Catastro (misma lógica original preservada)
                h += _fmtCatastroProps(p);
            } else {
                // Campos específicos solicitados
                let foundAny = false;
                wl.fields.forEach(f => {
                    const v = p[f] || p[f.toLowerCase()] || p[f.toUpperCase()] || '';
                    if (v !== '' && v !== null) {
                        h += `<div><span style="color:#666">${f}:</span> <strong>${escapeHtml(String(v))}</strong></div>`;
                        foundAny = true;
                    }
                });
                // Si ningún campo específico coincidió, mostrar todos los disponibles
                if (!foundAny) {
                    Object.entries(p).slice(0, 10).forEach(([k, v]) => {
                        if (v !== null && v !== '' && k !== 'geometry' && k !== 'bbox' && k !== '_raw_text') {
                            h += `<div><span style="color:#666">${k}:</span> <strong>${escapeHtml(String(v))}</strong></div>`;
                        }
                    });
                }
            }

            // Si hay múltiples features, indicar
            if (hit.features.length > 1) {
                h += `<div style="margin-top:4px;font-size:11px;color:#94a3b8;border-top:1px solid #eee;padding-top:3px;">${hit.features.length} elementos en este punto</div>`;
            }

            h += '</div>';
            return h;
        }

        // Formatear propiedades catastrales (lógica original preservada 1:1)
        function _fmtCatastroProps(p) {
            let h = '';
            const fields = [
                ['Finca', 'FINCA', 'finca', 'Finca', 'NFINCA', 'nfinca', 'NUM_FINCA', 'num_finca'],
                ['Plano', 'PLANO', 'plano', 'Plano', 'NPLANO', 'nplano', 'NUM_PLANO', 'num_plano'],
                ['Identifica', 'IDENTIFICA', 'identifica', 'Identifica', 'IDENTIFICADOR', 'ID'],
                ['Provincia', 'PROVINCIA', 'provincia'],
                ['Cantón', 'CANTON', 'canton', 'Cantón'],
                ['Distrito', 'DISTRITO', 'distrito']
            ];
            fields.forEach(aliases => {
                const label = aliases[0];
                for (let i = 0; i < aliases.length; i++) {
                    if (p[aliases[i]] !== undefined && p[aliases[i]] !== null && p[aliases[i]] !== '') {
                        h += `<div><span style="color:#666">${label}:</span> <strong>${p[aliases[i]]}</strong></div>`;
                        break;
                    }
                }
            });
            // Mostrar otros atributos no cubiertos (original)
            const shown = new Set(fields.flat());
            Object.keys(p).forEach(k => {
                if (!shown.has(k) && p[k] !== null && p[k] !== '' && k !== 'bbox' && k !== 'geometry') {
                    h += `<div><span style="color:#666">${k}:</span> ${p[k]}</div>`;
                }
            });
            return h;
        }

        // ============================================================================
        // MEJORA: Pre-cache de tiles OpenTopoMap para Costa Rica (offline)
        // ============================================================================

        function _precacheTilesCR() {
            if (!navigator.serviceWorker || !navigator.serviceWorker.controller) return;
            const lon2x = (lon, z) => Math.floor((lon + 180) / 360 * (1 << z));
            const lat2y = (lat, z) => Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * (1 << z));

            const urls = [];
            // Costa Rica: lat 8.0–11.2, lon -86.0 a -82.5
            const B = { latMin: 8.0, latMax: 11.2, lonMin: -86.0, lonMax: -82.5 };
            // Zoom 8-11 para todo CR (~350 tiles, ~10 MB)
            for (let z = 8; z <= 11; z++) {
                const x0 = lon2x(B.lonMin, z), x1 = lon2x(B.lonMax, z);
                const y0 = lat2y(B.latMax, z), y1 = lat2y(B.latMin, z);
                for (let x = x0; x <= x1; x++) {
                    for (let y = y0; y <= y1; y++) {
                        urls.push(`https://${['a','b','c'][(x+y)%3]}.tile.opentopomap.org/${z}/${x}/${y}.png`);
                    }
                }
            }
            navigator.serviceWorker.controller.postMessage({ type: 'PRECACHE_TILES', urls });
            console.log('[PP01] Pre-caching ' + urls.length + ' tiles de CR para uso offline');
        }

        // Disparar pre-cache al registrar SW (solo la primera vez)
        if (navigator.serviceWorker) {
            navigator.serviceWorker.ready.then(() => {
                if (!localStorage.getItem('pp01_tiles_cached_v1')) {
                    setTimeout(_precacheTilesCR, 3000);
                    localStorage.setItem('pp01_tiles_cached_v1', new Date().toISOString());
                }
            }).catch(() => {});
        }

        // ============================================================================
        // MEJORA: Diagnóstico WMS — ejecutar desde consola: _testWmsServices()
        // ============================================================================

        async function _testWmsServices() {
            const services = [
                {
                    name: 'SNIT Catastro',
                    url: 'https://siri.snitcr.go.cr/Geoservicios/wms',
                    layer: 'RI_CA_AC_ZONA1_1K_5K'
                },
                {
                    name: 'IGN Cauces 25k',
                    url: 'https://geos.snitcr.go.cr/be/IGN_25/wms',
                    layer: 'caucedrenaje_25k'
                },
                {
                    name: 'DA Dict. Pto. Inicial',
                    url: 'https://mapas.da.go.cr/geopc.php',
                    layer: 'DA_Dictamenes_Punto_Inicial'
                },
                {
                    name: 'DA Dict. Pto. Final',
                    url: 'https://mapas.da.go.cr/geopc.php',
                    layer: 'DA_Dictamenes_Punto_Final'
                }
            ];

            console.log('%c=== DIAGNÓSTICO WMS ===', 'color:cyan;font-weight:bold;font-size:14px');

            for (const svc of services) {
                try {
                    // Test 1: GetMap (imagen) - CR central
                    const sep = svc.url.includes('?') ? '&' : '?';
                    const getMapUrl = svc.url + sep +
                        'SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap' +
                        '&LAYERS=' + encodeURIComponent(svc.layer) +
                        '&STYLES=&SRS=EPSG%3A4326' +
                        '&BBOX=-84.2,9.8,-84.0,10.0' +
                        '&WIDTH=256&HEIGHT=256&FORMAT=image/png&TRANSPARENT=true';

                    console.log(`[${svc.name}] Probando GetMap...`);

                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    const imgResult = await new Promise((resolve) => {
                        img.onload = () => resolve({ ok: true, w: img.width, h: img.height });
                        img.onerror = (e) => resolve({ ok: false, err: e.type });
                        img.src = getMapUrl;
                        setTimeout(() => resolve({ ok: false, err: 'timeout 8s' }), 8000);
                    });

                    if (imgResult.ok) {
                        console.log(`%c  ✅ ${svc.name}: GetMap OK (${imgResult.w}x${imgResult.h}px)`, 'color:lime');
                    } else {
                        console.log(`%c  ❌ ${svc.name}: GetMap FALLÓ (${imgResult.err})`, 'color:red');
                    }

                    // Test 2: GetFeatureInfo (JSON via fetch)
                    const gfiUrl = svc.url + sep +
                        'SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo' +
                        '&LAYERS=' + encodeURIComponent(svc.layer) +
                        '&QUERY_LAYERS=' + encodeURIComponent(svc.layer) +
                        '&INFO_FORMAT=application/json&SRS=EPSG%3A4326' +
                        '&BBOX=-84.2,9.8,-84.0,10.0&WIDTH=256&HEIGHT=256' +
                        '&X=128&Y=128&FEATURE_COUNT=1';

                    try {
                        const r = await fetch(gfiUrl, { signal: AbortSignal.timeout(6000) });
                        const ct = r.headers.get('content-type') || '';
                        const cors = r.headers.get('access-control-allow-origin') || 'NO';
                        console.log(`%c  ℹ️ ${svc.name}: GetFeatureInfo ${r.status} (CORS: ${cors}, type: ${ct.split(';')[0]})`, r.ok ? 'color:cyan' : 'color:orange');
                    } catch (e) {
                        console.log(`%c  ⚠️ ${svc.name}: GetFeatureInfo bloqueado (${e.message || 'CORS/red'})`, 'color:orange');
                    }

                } catch (err) {
                    console.log(`%c  ❌ ${svc.name}: Error general: ${err.message}`, 'color:red');
                }
            }

            // Test GetCapabilities del IGN para descubrir capas
            console.log('%c\n=== CAPAS DISPONIBLES IGN 25k ===', 'color:cyan;font-weight:bold');
            try {
                const capUrl = 'https://geos.snitcr.go.cr/be/IGN_25/wms?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities';
                const r = await fetch(capUrl, { signal: AbortSignal.timeout(10000) });
                const txt = await r.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(txt, 'text/xml');
                const layers = doc.querySelectorAll('Layer > Name');
                const names = [];
                layers.forEach(n => names.push(n.textContent));
                if (names.length > 0) {
                    console.log('  Capas encontradas:', names.join(', '));
                    const cauceMatch = names.filter(n => n.toLowerCase().includes('cauce') || n.toLowerCase().includes('drenaje') || n.toLowerCase().includes('hidro'));
                    if (cauceMatch.length) console.log('%c  🌊 Capas de cauces/drenaje: ' + cauceMatch.join(', '), 'color:lime;font-weight:bold');
                    else console.log('%c  ⚠️ No se encontró capa de cauces/drenaje', 'color:orange');
                } else {
                    console.log('  No se pudieron parsear capas (posible CORS)');
                }
            } catch (e) {
                console.log(`%c  ⚠️ GetCapabilities IGN bloqueado: ${e.message}`, 'color:orange');
            }

            // Test GetCapabilities del DA para verificar nombres
            console.log('%c\n=== CAPAS DISPONIBLES Dir. Agua ===', 'color:cyan;font-weight:bold');
            try {
                const capUrl = 'https://mapas.da.go.cr/geopc.php?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities';
                const r = await fetch(capUrl, { signal: AbortSignal.timeout(10000) });
                const txt = await r.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(txt, 'text/xml');
                const layers = doc.querySelectorAll('Layer > Name');
                const names = [];
                layers.forEach(n => names.push(n.textContent));
                if (names.length > 0) {
                    console.log('  Capas encontradas:', names.join(', '));
                    const dictMatch = names.filter(n => n.toLowerCase().includes('dictam'));
                    if (dictMatch.length) console.log('%c  💧 Capas de dictámenes: ' + dictMatch.join(', '), 'color:lime;font-weight:bold');
                } else {
                    console.log('  No se pudieron parsear capas (posible CORS)');
                }
            } catch (e) {
                console.log(`%c  ⚠️ GetCapabilities DA bloqueado: ${e.message}`, 'color:orange');
            }

            console.log('%c\n=== FIN DIAGNÓSTICO ===', 'color:cyan;font-weight:bold');
        }

    

        // ============================================================================
        // SISTEMA DE AUTOGUARDADO, EXPORTACIÓN E IMPORTACIÓN
        // ============================================================================

        class BackupManager {
            constructor() {
                this.backupId = null;
                this.autoSaveInterval = null;
                this.lastSaveTime = null;
                this.isSaving = false;
                this.dbName = 'pp01-acopac-backups';
                this.storeName = 'inspecciones';
                this.autoSaveEnabled = true;
                this.autoSaveFrequency = 30; // segundos
                this.init();
            }

            async init() {
                // Verificar si hay backup pendiente al cargar
                await this.checkRecovery();

                // Configurar intervalo de autoguardado
                this.setupAutoSave();

                // Configurar evento beforeunload
                window.addEventListener('beforeunload', (e) => {
                    if (this.hasUnsavedChanges()) {
                        e.preventDefault();
                        e.returnValue = 'Tienes cambios sin guardar. ¿Seguro que quieres salir?';
                        return e.returnValue;
                    }
                });

                // Configurar eventos de cambio
                this.setupChangeListeners();

                // Actualizar contador de backups
                this.updateBackupCount();
            }

            hasUnsavedChanges() {
                // Verificar si hay datos que no se han guardado
                const elementos = document.querySelectorAll('[id^="arbol_"], [id^="vertice_"], [id^="fuente_"], [id^="obs_"]');
                const elementosPendientes = Array.from(elementos).filter(el => 
                    el.querySelector('.block-status.pending')
                );
                return elementosPendientes.length > 0 || this.backupId !== null;
            }

            async checkRecovery() {
                try {
                    const db = await this.openDB();
                    const tx = db.transaction(this.storeName, 'readonly');
                    const store = tx.objectStore(this.storeName);
                    const backups = await store.getAll();

                    // Filtrar backups no exportados
                    const pendingBackups = backups.filter(b => b.estado !== 'exportado' && !b.fecha_fin);

                    if (pendingBackups.length > 0) {
                        this.showRecoveryModal(pendingBackups);
                    }
                } catch (error) {
                    console.error('Error checking recovery:', error);
                }
            }

            showRecoveryModal(backups) {
                // Crear modal de recuperación
                const modalHTML = `
                    <div class="modal-overlay active" id="recovery_modal">
                        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                            <div class="modal-header">
                                <h3><i class="fas fa-history mr-2"></i>Recuperar Inspección</h3>
                                <button class="modal-close" onclick="backupManager.closeRecoveryModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-4">
                                    <p class="text-gray-700 mb-3 font-bold">Se encontró ${backups.length} inspección(es) no finalizada(s)</p>
                                </div>

                                <div class="space-y-2 mb-6">
                                    <button onclick="backupManager.recoverLastBackup()" 
                                            class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded font-bold">
                                        <i class="fas fa-play mr-2"></i> Continuar última inspección
                                    </button>
                                    <button onclick="backupManager.deleteCurrentBackupAndStartNew()" 
                                            class="w-full bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded font-bold">
                                        <i class="fas fa-trash-alt mr-2"></i> Borrar todas e iniciar nueva
                                    </button>
                                    <button onclick="backupManager.startNewInspection()" 
                                            class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded font-bold">
                                        <i class="fas fa-plus mr-2"></i> Nueva inspección (mantener datos)
                                    </button>
                                </div>

                                <!-- Listado de inspecciones no finalizadas -->
                                <div class="border-t-2 border-gray-300 pt-4">
                                    <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-list mr-2"></i>
                                        Inspecciones No Finalizadas
                                    </h4>
                                    <div class="space-y-3 max-h-96 overflow-y-auto">
                                        ${backups.map((backup, index) => `
                                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 border-2 border-gray-300 p-4 rounded-lg shadow-sm">
                                                <div class="flex justify-between items-start mb-2">
                                                    <div class="flex-1">
                                                        <div class="font-bold text-lg text-gray-800">
                                                            ${backup.expediente || 'Sin expediente'}
                                                        </div>
                                                        <div class="text-sm text-gray-600 mt-1">
                                                            <i class="fas fa-calendar-plus mr-1"></i>
                                                            <strong>Iniciada:</strong> ${new Date(backup.fecha_inicio).toLocaleString('es-CR')}
                                                        </div>
                                                        <div class="text-sm text-gray-600">
                                                            <i class="fas fa-save mr-1"></i>
                                                            <strong>Guardada:</strong> ${new Date(backup.last_save).toLocaleString('es-CR')}
                                                        </div>
                                                        ${backup.metadata ? `
                                                            <div class="text-xs text-gray-500 mt-1">
                                                                <i class="fas fa-tree mr-1"></i> Árboles: ${backup.metadata.count_arboles || 0} | 
                                                                <i class="fas fa-map-marker-alt mr-1"></i> Vértices: ${backup.metadata.count_vertices || 0} | 
                                                                <i class="fas fa-water mr-1"></i> Fuentes: ${backup.metadata.count_fuentes || 0}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                                <div class="grid grid-cols-2 gap-2 mt-3">
                                                    <button onclick="backupManager.recoverSpecificBackup('${backup.id}')" 
                                                            class="bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded font-bold text-sm">
                                                        <i class="fas fa-play mr-1"></i> Continuar
                                                    </button>
                                                    <button onclick="backupManager.deleteSpecificBackup('${backup.id}')" 
                                                            class="bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded font-bold text-sm">
                                                        <i class="fas fa-trash mr-1"></i> Eliminar
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Añadir modal al DOM
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }


            // ====== Helpers para el modal de recuperación (NO altera lógica de backups; solo UI/flujo) ======
            closeRecoveryModal() {
                const m = document.getElementById('recovery_modal');
                if (m) m.remove();
            }

            // Continúa con el backup pendiente más reciente (por fecha de guardado)
            async recoverLastBackup() {
                try {
                    // Evitar múltiples clicks
                    if (this._recovering) return;
                    this._recovering = true;

                    const db = await this.openDB();
                    const allBackups = await db.getAll(this.storeName);
                    const pending = allBackups
                        .filter(b => b && b.estado !== 'exportado' && !b.fecha_fin)
                        .sort((a, b) => {
                            const ta = new Date(a.last_save || a.fecha_inicio || 0).getTime();
                            const tb = new Date(b.last_save || b.fecha_inicio || 0).getTime();
                            return tb - ta;
                        });

                    if (!pending.length) {
                        alert('No hay backups pendientes para recuperar.');
                        this.closeRecoveryModal();
                        return;
                    }

                    // Importar para continuar usando el mecanismo existente (sin tocar su lógica)
                    await this.importToContinue(pending[0], pending[0].metadata || {});
                    this.closeRecoveryModal();
                } catch (error) {
                    console.error('Error recoverLastBackup:', error);
                    alert('No fue posible recuperar la inspección. Revisa la consola para más detalles.');
                } finally {
                    this._recovering = false;
                }
            }

            // Cierra el modal y permite iniciar una nueva inspección manualmente (sin borrar backups)
            startNewInspection() {
                this.closeRecoveryModal();
                // No reiniciamos ni borramos nada aquí para no alterar lógica/estado existente.
                // El usuario puede iniciar normalmente con el botón "Iniciar" del formulario.
            }

            async deleteCurrentBackupAndStartNew() {
                // Borrar el backup actual y limpiar todo para iniciar una inspección completamente nueva
                try {
                    // Confirmar acción
                    if (!confirm('¿Está seguro de eliminar todos los datos guardados e iniciar una inspección nueva? Esta acción no se puede deshacer.')) {
                        return;
                    }

                    // Borrar el backup actual de IndexedDB
                    if (this.backupId) {
                        const db = await this.openDB();
                        await db.delete(this.storeName, this.backupId);
                        this.backupId = null;
                    }

                    // Limpiar indicadores de backup
                    const indicator = document.getElementById('backup_status_indicator');
                    const statusText = document.getElementById('backup_status_text');
                    if (indicator) indicator.className = 'w-3 h-3 rounded-full bg-gray-300';
                    if (statusText) statusText.textContent = 'Sin cambios';

                    // Limpiar el formulario completamente
                    limpiarFormulario();

                    // Cerrar modal de recuperación
                    this.closeRecoveryModal();

                    // Detener tracking si estaba activo
                    if (typeof stopTracking === 'function') {
                        stopTracking();
                    }

                    // Actualizar contadores
                    this.updateBackupCount();

                    // Notificar al usuario
                    alert('Datos eliminados correctamente. Puede iniciar una nueva inspección.');

                } catch (error) {
                    console.error('Error eliminando backup y limpiando formulario:', error);
                    alert('Error al eliminar los datos. Por favor, intente nuevamente.');
                }
            }

            async recoverSpecificBackup(backupId) {
                // Recuperar una inspección específica por su ID
                try {
                    if (this._recovering) return;
                    this._recovering = true;

                    const db = await this.openDB();
                    const backup = await db.get(this.storeName, backupId);

                    if (!backup) {
                        alert('No se encontró la inspección seleccionada.');
                        return;
                    }

                    // Importar para continuar usando el mecanismo existente
                    await this.importToContinue(backup, backup.metadata || {});
                    this.closeRecoveryModal();
                    
                } catch (error) {
                    console.error('Error recuperando backup específico:', error);
                    alert('No fue posible recuperar la inspección. Revisa la consola para más detalles.');
                } finally {
                    this._recovering = false;
                }
            }

            async deleteSpecificBackup(backupId) {
                // Eliminar una inspección específica por su ID
                try {
                    // Confirmar acción
                    if (!confirm('¿Está seguro de eliminar esta inspección? Esta acción no se puede deshacer.')) {
                        return;
                    }

                    const db = await this.openDB();
                    await db.delete(this.storeName, backupId);

                    // Si el backup eliminado era el actual, limpiar referencia
                    if (this.backupId === backupId) {
                        this.backupId = null;
                        const indicator = document.getElementById('backup_status_indicator');
                        const statusText = document.getElementById('backup_status_text');
                        if (indicator) indicator.className = 'w-3 h-3 rounded-full bg-gray-300';
                        if (statusText) statusText.textContent = 'Sin cambios';
                    }

                    // Actualizar contadores
                    this.updateBackupCount();

                    // Cerrar y reabrir modal para actualizar lista
                    this.closeRecoveryModal();

                    // Verificar si quedan backups pendientes
                    const allBackups = await db.getAll(this.storeName);
                    const pending = allBackups.filter(b => b && b.estado !== 'exportado' && !b.fecha_fin);

                    if (pending.length > 0) {
                        // Si quedan backups, mostrar modal actualizado
                        this.showRecoveryModal(pending);
                    } else {
                        // Si no quedan backups, notificar y permitir iniciar nueva
                        alert('Inspección eliminada correctamente. No quedan inspecciones pendientes.');
                    }

                } catch (error) {
                    console.error('Error eliminando backup específico:', error);
                    alert('Error al eliminar la inspección. Por favor, intente nuevamente.');
                }
            }

            // Abre el gestor/listado de backups existente para ver detalles y opciones
            showBackupPreview() {
                try {
                    this.closeRecoveryModal();
                    if (typeof this.mostrarModalBackups === 'function') {
                        this.mostrarModalBackups();
                    }
                } catch (error) {
                    console.error('Error showBackupPreview:', error);
                }
            }

            setupAutoSave() {
                if (this.autoSaveInterval) {
                    clearInterval(this.autoSaveInterval);
                }

                if (this.autoSaveEnabled && this.autoSaveFrequency > 0) {
                    this.autoSaveInterval = setInterval(() => {
                        if (inspeccionIniciada) {
                            this.saveBackup();
                        }
                    }, this.autoSaveFrequency * 1000);
                }
            }

            setupChangeListeners() {
                // Escuchar cambios en campos de formulario
                document.addEventListener('input', (e) => {
                    if (inspeccionIniciada && e.target.matches('input, select, textarea')) {
                        this.queueSave();
                    }
                });

                // Escuchar cambios en botones de guardar
                document.addEventListener('click', (e) => {
                    if (inspeccionIniciada && e.target.closest('[id^="btn_save_"]')) {
                        setTimeout(() => this.saveBackup(), 500);
                    }
                });
            }

            queueSave() {
                // Actualizar indicador de estado
                const indicator = document.getElementById('backup_status_indicator');
                const statusText = document.getElementById('backup_status_text');

                if (indicator) {
                    indicator.className = 'w-3 h-3 rounded-full bg-yellow-500 animate-pulse';
                }
                if (statusText) {
                    statusText.textContent = 'Cambios pendientes...';
                }

                // Programar guardado (debouncing)
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => {
                    if (!this.isSaving) {
                        this.saveBackup();
                    }
                }, 2000);
            }

            async saveBackup() {
                if (this.isSaving || !inspeccionIniciada) return;

                this.isSaving = true;

                try {
                    // Actualizar indicador
                    const indicator = document.getElementById('backup_status_indicator');
                    const statusText = document.getElementById('backup_status_text');
                    const lastSaveTime = document.getElementById('last_save_time');

                    if (indicator) indicator.className = 'w-3 h-3 rounded-full bg-blue-500 animate-pulse';
                    if (statusText) statusText.textContent = 'Guardando...';

                    // Recopilar datos
                    const backupData = this.collectBackupData();

                    // Generar ID si no existe
                    if (!this.backupId) {
                        this.backupId = 'backup_' + Date.now();
                    }

                    // Guardar en IndexedDB
                    const db = await this.openDB();
                    const tx = db.transaction(this.storeName, 'readwrite');
                    const store = tx.objectStore(this.storeName);

                    backupData.id = this.backupId;
                    backupData.last_save = new Date().toISOString();

                    await store.put(backupData);

                    // Actualizar indicadores
                    this.lastSaveTime = new Date();
                    if (indicator) indicator.className = 'w-3 h-3 rounded-full bg-green-500';
                    if (statusText) statusText.textContent = 'Guardado';
                    if (lastSaveTime) lastSaveTime.textContent = 'Hace 0s';

                    // Actualizar contador
                    this.updateBackupCount();

                    console.log('Backup guardado:', this.backupId);

                } catch (error) {
                    console.error('Error guardando backup:', error);

                    const indicator = document.getElementById('backup_status_indicator');
                    const statusText = document.getElementById('backup_status_text');

                    if (indicator) indicator.className = 'w-3 h-3 rounded-full bg-red-500';
                    if (statusText) statusText.textContent = 'Error al guardar';
                } finally {
                    this.isSaving = false;
                }
            }

            collectBackupData() {
                // Recopilar todos los datos de la inspección
                const data = {
                    expediente: document.getElementById('expediente_id')?.value,
                    fecha_inicio: document.getElementById('start_time')?.value,
                    profesional: document.getElementById('input_profesional')?.value,
                    asistente1: document.getElementById('input_asistente1')?.value,
                    estado: inspeccionIniciada ? 'en_progreso' : 'borrador',

                    // Recopilar árboles
                    arboles: this.collectArboles(),

                    // Recopilar vértices
                    vertices: this.collectVertices(),

                    // Recopilar fuentes
                    fuentes: this.collectFuentes(),

                    // Recopilar observaciones
                    observaciones: this.collectObservaciones(),

                    // Recopilar acompañantes
                    acompanantes: this.collectAcompanantes(),

                    // Recopilar track GPS
                    track_points: trackPoints || [],

                    // Metadatos
                    metadata: {
                        version: '1.0',
                        dispositivo: navigator.userAgent,
                        timestamp: new Date().toISOString()
                    }
                };

                return data;
            }

            collectArboles() {
                const arboles = [];
                document.querySelectorAll('[id^="arbol_"]').forEach(block => {
                    const id = block.id.split('_')[1];
                    const saved = block.dataset.saved === 'true';

                    if (saved) {
                        arboles.push({
                            id: id,
                            numero: document.getElementById(`num_arbol_${id}`)?.value,
                            especie: document.getElementById(`sp_arbol_${id}`)?.value,
                            medida: document.getElementById(`val_medida_${id}`)?.value,
                            lct: document.getElementById(`val_lct_${id}`)?.value,
                            volumen: document.getElementById(`res_volumen_${id}`)?.dataset?.vol,
                            gps: this.getGPSData(`t${id}`),
                            relaciones_vida_silvestre: document.getElementById(`wildlife_relations_json_t${id}`)?.value || '[]'
                        });
                    }
                });
                return arboles;
            }

            collectVertices() {
                const vertices = [];
                document.querySelectorAll('[id^="vertice_block_"]').forEach(block => {
                    const id = block.id.split('_')[2];
                    const saved = block.querySelector('.block-status.saved');

                    if (saved) {
                        vertices.push({
                            id: id,
                            numero: document.getElementById(`num_vertice_${id}`)?.value,
                            observacion: document.getElementById(`obs_vertice_${id}`)?.value,
                            gps: this.getGPSData(`v${id}`)
                        });
                    }
                });
                return vertices;
            }

            collectFuentes() {
                const fuentes = [];
                document.querySelectorAll('[id^="fuente_block_"]').forEach(block => {
                    const id = block.id.split('_')[2];
                    const saved = block.querySelector('.block-status.saved');

                    if (saved) {
                        fuentes.push({
                            id: id,
                            numero: document.getElementById(`num_fuente_${id}`)?.value,
                            tipo: document.getElementById(`tipo_fuente_${id}`)?.value,
                            gps: this.getGPSData(`w${id}`)
                        });
                    }
                });
                return fuentes;
            }

            collectObservaciones() {
                const observaciones = [];
                document.querySelectorAll('[id^="obs_final_"]').forEach(block => {
                    const id = block.id.split('_')[2];
                    const saved = block.querySelector('.block-status.saved');

                    if (saved) {
                        observaciones.push({
                            id: id,
                            detalle: document.getElementById(`detalle_obs_${id}`)?.value,
                            gps: this.getGPSData(`o${id}`)
                        });
                    }
                });
                return observaciones;
            }

            collectAcompanantes() {
                const acompanantes = [];
                document.querySelectorAll('[id^="acompanante_"]').forEach(block => {
                    const inputs = block.querySelectorAll('input');
                    if (inputs.length >= 2) {
                        acompanantes.push({
                            nombre: inputs[0]?.value,
                            cedula: inputs[1]?.value
                        });
                    }
                });
                return acompanantes;
            }

            getGPSData(elementId) {
                const display = document.getElementById(`gps_display_${elementId}`);
                if (!display) return null;

                return {
                    norte: display.dataset.norte,
                    este: display.dataset.este,
                    lat: display.dataset.lat,
                    lon: display.dataset.lon,
                    ele: display.dataset.ele,
                    incertidumbre: display.dataset.incertidumbre
                };
            }

            async openDB() {
                return await idb.openDB(this.dbName, 1, {
                    upgrade(db) {
                        if (!db.objectStoreNames.contains('inspecciones')) {
                            const store = db.createObjectStore('inspecciones', { keyPath: 'id' });
                            store.createIndex('fecha_inicio', 'fecha_inicio');
                            store.createIndex('estado', 'estado');
                        }
                    }
                });
            }

            async updateBackupCount() {
                try {
                    const db = await this.openDB();
                    const count = await db.count(this.storeName);
                    const badge = document.getElementById('backup_count_badge');
                    if (badge) {
                        badge.textContent = count;
                    }
                } catch (error) {
                    console.error('Error updating backup count:', error);
                }
            }

            async exportarInspeccionAZip() {
                try {
                    if (!inspeccionIniciada) {
                        alert('Debe iniciar una inspección primero');
                        return;
                    }

                    const expediente = document.getElementById('expediente_id')?.value;
                    if (!expediente) {
                        alert('Seleccione un expediente antes de exportar');
                        return;
                    }

                    // Crear ZIP
                    const zip = new JSZip();

                    // 1. Datos principales
                    const datos = this.collectBackupData();
                    datos.fecha_exportacion = new Date().toISOString();
                    datos.estado = 'exportado';

                    zip.file("inspeccion.json", JSON.stringify(datos, null, 2));

                    // 2. CSV de árboles
                    let csvArboles = "Numero,Especie,Medida_cm,LCT_m,Volumen_m3,Norte,Este,Latitud,Longitud\n";
                    datos.arboles.forEach(a => {
                        csvArboles += `${a.numero},"${a.especie}",${a.medida},${a.lct},${a.volumen},${a.gps?.norte || ''},${a.gps?.este || ''},${a.gps?.lat || ''},${a.gps?.lon || ''}\n`;
                    });
                    zip.file("arboles.csv", csvArboles);

                    // 3. GPX de puntos
                    let gpxPuntos = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="PP01-ACOPAC">
<metadata>
<name>Inspección ${expediente}</name>
<time>${new Date().toISOString()}</time>
</metadata>`;

                    // Vértices
                    datos.vertices.forEach(v => {
                        if (v.gps?.lat && v.gps?.lon) {
                            gpxPuntos += `
<wpt lat="${v.gps.lat}" lon="${v.gps.lon}">
<name>Vértice ${v.numero}</name>
<sym>Flag</sym>
<desc>${v.observacion || ''}</desc>
</wpt>`;
                        }
                    });

                    // Árboles
                    datos.arboles.forEach(a => {
                        if (a.gps?.lat && a.gps?.lon) {
                            gpxPuntos += `
<wpt lat="${a.gps.lat}" lon="${a.gps.lon}">
<name>Árbol ${a.numero}</name>
<sym>Tree</sym>
<desc>${a.especie || ''}</desc>
</wpt>`;
                        }
                    });

                    gpxPuntos += "\n</gpx>";
                    zip.file("puntos_gps.gpx", gpxPuntos);

                    // 4. GPX del track
                    if (trackPoints && trackPoints.length > 0) {
                        const trackGpx = generateTrackGPX();
                        if (trackGpx) {
                            zip.file("track_recorrido.gpx", trackGpx);
                        }
                    }

                    // 5. Resumen
                    let resumen = `INSPECCIÓN FORESTAL PP-01 ACOPAC\n`;
                    resumen += `Exportada: ${new Date().toLocaleString()}\n`;
                    resumen += `Expediente: ${expediente}\n`;
                    resumen += `Profesional: ${datos.profesional}\n`;
                    resumen += `Asistente: ${datos.asistente1}\n`;
                    resumen += `\nRESUMEN:\n`;
                    resumen += `- Árboles: ${datos.arboles.length}\n`;
                    resumen += `- Vértices: ${datos.vertices.length}\n`;
                    resumen += `- Fuentes: ${datos.fuentes.length}\n`;
                    resumen += `- Observaciones: ${datos.observaciones.length}\n`;
                    resumen += `- Puntos de track: ${trackPoints.length}\n`;

                    zip.file("resumen.txt", resumen);

                    // 6. Metadatos
                    const metadata = {
                        version: "1.0",
                        aplicacion: "PP01-ACOPAC",
                        fecha_creacion: datos.metadata.timestamp,
                        fecha_exportacion: new Date().toISOString(),
                        expediente: expediente,
                        hash: "SHA256" // Se calcularía en producción
                    };
                    zip.file("metadata.json", JSON.stringify(metadata, null, 2));

                    // Generar y descargar ZIP
                    const content = await zip.generateAsync({ type: "blob" });
                    const fileName = `PP01_${expediente}_${new Date().getTime()}.zip`;
                    saveAs(content, fileName);

                    // Marcar backup como exportado
                    await this.markAsExported();

                    alert(`Inspección exportada correctamente: ${fileName}`);

                } catch (error) {
                    console.error('Error exportando ZIP:', error);
                    alert('Error al exportar la inspección: ' + error.message);
                }
            }

            async markAsExported() {
                try {
                    if (!this.backupId) return;

                    const db = await this.openDB();
                    const tx = db.transaction(this.storeName, 'readwrite');
                    const store = tx.objectStore(this.storeName);

                    const backup = await store.get(this.backupId);
                    if (backup) {
                        backup.estado = 'exportado';
                        backup.fecha_fin = new Date().toISOString();
                        await store.put(backup);
                    }

                    // Limpiar ID de backup actual
                    this.backupId = null;

                } catch (error) {
                    console.error('Error marcando como exportado:', error);
                }
            }

            async importarDesdeZip(file) {
                try {
                    if (!file) return;

                    // Leer archivo ZIP
                    const zip = await JSZip.loadAsync(file);

                    // Verificar estructura mínima
                    const requiredFiles = ['inspeccion.json', 'metadata.json'];
                    for (const file of requiredFiles) {
                        if (!zip.files[file]) {
                            throw new Error(`Archivo requerido no encontrado: ${file}`);
                        }
                    }

                    // Leer metadatos
                    const metadataContent = await zip.files['metadata.json'].async('string');
                    const metadata = JSON.parse(metadataContent);

                    // Confirmar importación
                    const confirmImport = confirm(
                        `¿Importar inspección del expediente ${metadata.expediente}?\n` +
                        `Fecha: ${new Date(metadata.fecha_exportacion).toLocaleString()}`
                    );

                    if (!confirmImport) return;

                    // Leer datos de inspección
                    const datosContent = await zip.files['inspeccion.json'].async('string');
                    const datos = JSON.parse(datosContent);

                    // Mostrar vista previa
                    this.showImportPreview(datos, metadata);

                } catch (error) {
                    console.error('Error importando ZIP:', error);
                    alert('Error al importar archivo ZIP: ' + error.message);
                }
            }

            showImportPreview(datos, metadata) {
                const modalHTML = `
                    <div class="modal-overlay active" id="import_preview_modal">
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h3><i class="fas fa-file-import mr-2"></i>Vista Previa de Importación</h3>
                                <button class="modal-close" onclick="document.getElementById('import_preview_modal').remove()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-4">
                                    <h4 class="font-bold text-gray-700 mb-2">Detalles de la Inspección</h4>
                                    <div class="bg-gray-50 p-3 rounded-lg">
                                        <div class="grid grid-cols-2 gap-2 text-sm">
                                            <div><span class="font-medium">Expediente:</span> ${datos.expediente || 'N/A'}</div>
                                            <div><span class="font-medium">Profesional:</span> ${datos.profesional || 'N/A'}</div>
                                            <div><span class="font-medium">Fecha inicio:</span> ${new Date(datos.fecha_inicio).toLocaleString()}</div>
                                            <div><span class="font-medium">Árboles:</span> ${datos.arboles?.length || 0}</div>
                                            <div><span class="font-medium">Vértices:</span> ${datos.vertices?.length || 0}</div>
                                            <div><span class="font-medium">Exportado:</span> ${new Date(metadata.fecha_exportacion).toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <h4 class="font-bold text-gray-700 mb-2">Opciones de Importación</h4>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="radio" name="import_mode" value="view" checked class="mr-2">
                                            <span>Ver como solo lectura</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="import_mode" value="continue" class="mr-2">
                                            <span>Continuar esta inspección</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="import_mode" value="compare" class="mr-2">
                                            <span>Comparar con inspección actual</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="flex gap-2">
                                    <button onclick="backupManager.confirmImport('${encodeURIComponent(JSON.stringify(datos))}', '${encodeURIComponent(JSON.stringify(metadata))}')" 
                                            class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded font-bold">
                                        Importar
                                    </button>
                                    <button onclick="document.getElementById('import_preview_modal').remove()" 
                                            class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded font-bold">
                                        Cancelar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            async confirmImport(datosEncoded, metadataEncoded) {
                try {
                    const datos = JSON.parse(decodeURIComponent(datosEncoded));
                    const metadata = JSON.parse(decodeURIComponent(metadataEncoded));
                    const importMode = document.querySelector('input[name="import_mode"]:checked')?.value || 'view';

                    // Cerrar modal de vista previa
                    const modal = document.getElementById('import_preview_modal');
                    if (modal) modal.remove();

                    switch (importMode) {
                        case 'view':
                            await this.importAsViewOnly(datos, metadata);
                            break;
                        case 'continue':
                            await this.importToContinue(datos, metadata);
                            break;
                        case 'compare':
                            this.showComparison(datos);
                            break;
                    }

                } catch (error) {
                    console.error('Error confirmando importación:', error);
                    alert('Error al procesar importación: ' + error.message);
                }
            }

            async importAsViewOnly(datos, metadata) {
                // Crear vista de solo lectura
                const viewHTML = `
                    <div class="modal-overlay active" id="view_import_modal" style="z-index: 2001;">
                        <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
                            <div class="modal-header">
                                <h3><i class="fas fa-eye mr-2"></i>Inspección Importada (Solo Lectura)</h3>
                                <button class="modal-close" onclick="document.getElementById('view_import_modal').remove()">&times;</button>
                            </div>
                            <div class="modal-body overflow-y-auto">
                                <!-- Aquí se mostrarían los datos en formato de solo lectura -->
                                <div class="mb-4">
                                    <h4 class="font-bold text-lg text-gray-700 mb-3">Resumen</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        <div class="bg-blue-50 p-3 rounded-lg">
                                            <div class="text-sm text-blue-600">Árboles</div>
                                            <div class="text-2xl font-bold">${datos.arboles?.length || 0}</div>
                                        </div>
                                        <div class="bg-green-50 p-3 rounded-lg">
                                            <div class="text-sm text-green-600">Vértices</div>
                                            <div class="text-2xl font-bold">${datos.vertices?.length || 0}</div>
                                        </div>
                                        <div class="bg-purple-50 p-3 rounded-lg">
                                            <div class="text-sm text-purple-600">Observaciones</div>
                                            <div class="text-2xl font-bold">${datos.observaciones?.length || 0}</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <h4 class="font-bold text-gray-700 mb-2">Detalles</h4>
                                    <pre class="bg-gray-50 p-3 rounded-lg text-sm overflow-x-auto">${JSON.stringify(datos, null, 2)}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', viewHTML);
            }

            async importToContinue(datos, metadata) {
                // Limpiar formulario actual
                limpiarFormulario();

                // Restaurar expediente
                if (datos.expediente) {
                    document.getElementById('expediente_id').value = datos.expediente;
                    loadExpedienteData();
                }

                // Restaurar profesional y asistente
                if (datos.profesional) {
                    document.getElementById('input_profesional').value = datos.profesional;
                }
                if (datos.asistente1) {
                    document.getElementById('input_asistente1').value = datos.asistente1;
                }

                // Iniciar inspección si no está iniciada
                if (!inspeccionIniciada) {
                    iniciarInspeccion();
                }

                // Restaurar árboles
                datos.arboles?.forEach((arbol, index) => {
                    // Buscar si ya existe un árbol con este número
                    let arbolExistente = document.querySelector(`[id^="arbol_"] #num_arbol_${arbol.id}`);

                    if (!arbolExistente) {
                        addArbol();
                    }

                    // Rellenar datos del árbol
                    setTimeout(() => {
                        if (document.getElementById(`num_arbol_${arbol.id}`)) {
                            document.getElementById(`num_arbol_${arbol.id}`).value = arbol.numero;
                            document.getElementById(`sp_arbol_${arbol.id}`).value = arbol.especie;
                            document.getElementById(`val_medida_${arbol.id}`).value = arbol.medida;
                            document.getElementById(`val_lct_${arbol.id}`).value = arbol.lct;
                            calculateVolume(arbol.id);

                            // Restaurar GPS si existe
                            if (arbol.gps) {
                                this.restoreGPSData(`t${arbol.id}`, arbol.gps);
                            }

                            // Guardar árbol
                            const saveBtn = document.getElementById(`btn_save_arbol_${arbol.id}`);
                            if (saveBtn) {
                                saveBtn.click();
                            }
                        }
                    }, 100 * index);
                });

                // Restaurar vértices, fuentes, observaciones de manera similar...

                alert('Inspección importada correctamente. Puede continuar trabajando en ella.');
            }

            restoreGPSData(elementId, gpsData) {
                // Restaurar coordenadas GPS
                const display = document.getElementById(`gps_display_${elementId}`);
                if (display && gpsData) {
                    display.dataset.norte = gpsData.norte;
                    display.dataset.este = gpsData.este;
                    display.dataset.lat = gpsData.lat;
                    display.dataset.lon = gpsData.lon;
                    display.dataset.ele = gpsData.ele;
                    display.dataset.incertidumbre = gpsData.incertidumbre;

                    // Actualizar visualización
                    display.innerHTML = `
                        <div class="bg-green-50 border-2 border-green-300 rounded-lg p-3 text-center">
                            <div class="flex items-center justify-center gap-2 mb-2">
                                <i class="fas fa-check-circle text-green-600"></i>
                                <span class="text-sm font-bold text-green-700">COORDENADA IMPORTADA</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-left mb-2">
                                <div class="bg-white p-2 rounded border border-green-200">
                                    <span class="text-[10px] text-gray-400 block uppercase">Norte (Y)</span>
                                    <span class="font-mono font-bold text-sm text-gray-800">${gpsData.norte || ''}</span>
                                </div>
                                <div class="bg-white p-2 rounded border border-green-200">
                                    <span class="text-[10px] text-gray-400 block uppercase">Este (X)</span>
                                    <span class="font-mono font-bold text-sm text-gray-800">${gpsData.este || ''}</span>
                                </div>
                            </div>
                            <div class="text-[10px] text-gray-400 mt-2 text-right">Importada</div>
                        </div>
                    `;
                    display.classList.remove('hidden');

                    const mapOverlay = document.getElementById(`map_overlay_${elementId}`);
                    if (mapOverlay) mapOverlay.classList.add('hidden');
                }
            }

            showComparison(datos) {
                // Mostrar comparación entre datos importados y actuales
                alert('Función de comparación en desarrollo. Por ahora, se importará como vista de solo lectura.');
                this.importAsViewOnly(datos, {});
            }

            async guardarBackupManual() {
                await this.saveBackup();
                alert('Backup guardado manualmente');
            }

            async limpiarBackupActual() {
                if (confirm('¿Está seguro de eliminar el backup actual? Esta acción no se puede deshacer.')) {
                    try {
                        if (this.backupId) {
                            const db = await this.openDB();
                            await db.delete(this.storeName, this.backupId);
                            this.backupId = null;
                        }

                        // Limpiar indicadores
                        const indicator = document.getElementById('backup_status_indicator');
                        const statusText = document.getElementById('backup_status_text');

                        if (indicator) indicator.className = 'w-3 h-3 rounded-full bg-gray-300';
                        if (statusText) statusText.textContent = 'Sin cambios';

                        this.updateBackupCount();
                        alert('Backup eliminado correctamente');

                    } catch (error) {
                        console.error('Error limpiando backup:', error);
                        alert('Error al eliminar backup');
                    }
                }
            }

            mostrarModalBackups() {
                document.getElementById('modal_backups').classList.remove('hidden');
                this.loadBackupList();
            }

            cerrarModalBackups() {
                document.getElementById('modal_backups').classList.add('hidden');
            }

            async loadBackupList() {
                try {
                    const db = await this.openDB();
                    const allBackups = await db.getAll(this.storeName);

                    // Separar por estado
                    const savedBackups = allBackups.filter(b => b.estado === 'exportado');
                    const pendingBackups = allBackups.filter(b => b.estado !== 'exportado');

                    // Actualizar pestaña actual
                    if (pendingBackups.length > 0) {
                        const current = pendingBackups[0];
                        document.getElementById('backup_current_start').textContent = 
                            new Date(current.fecha_inicio).toLocaleString();
                        document.getElementById('backup_current_last').textContent = 
                            new Date(current.last_save).toLocaleString();
                        document.getElementById('backup_current_items').textContent = 
                            (current.arboles?.length || 0) + (current.vertices?.length || 0);
                    }

                    // Actualizar lista guardada
                    const savedList = document.getElementById('saved_backups_list');
                    const noSaved = document.getElementById('no_saved_backups');

                    if (savedBackups.length === 0) {
                        savedList.innerHTML = '';
                        noSaved.classList.remove('hidden');
                    } else {
                        noSaved.classList.add('hidden');
                        savedList.innerHTML = savedBackups.map(backup => `
                            <div class="bg-gray-50 p-3 rounded-lg border">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-bold">${backup.expediente || 'Sin expediente'}</div>
                                        <div class="text-sm text-gray-600">
                                            ${new Date(backup.fecha_inicio).toLocaleString()}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            Árboles: ${backup.arboles?.length || 0} | 
                                            Vértices: ${backup.vertices?.length || 0}
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="backupManager.restoreBackup('${backup.id}')" 
                                                class="text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="backupManager.deleteBackup('${backup.id}')" 
                                                class="text-red-600 hover:text-red-800">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }

                } catch (error) {
                    console.error('Error cargando lista de backups:', error);
                }
            }

            async restoreBackup(backupId) {
                try {
                    const db = await this.openDB();
                    const backup = await db.get(this.storeName, backupId);

                    if (backup) {
                        const confirmRestore = confirm(
                            `¿Restaurar inspección del expediente ${backup.expediente}?\n` +
                            `Esta acción reemplazará la inspección actual.`
                        );

                        if (confirmRestore) {
                            this.backupId = backupId;
                            await this.importToContinue(backup, backup.metadata);
                            this.cerrarModalBackups();
                        }
                    }
                } catch (error) {
                    console.error('Error restaurando backup:', error);
                    alert('Error al restaurar backup');
                }
            }

            async deleteBackup(backupId) {
                if (confirm('¿Está seguro de eliminar este backup permanentemente?')) {
                    try {
                        const db = await this.openDB();
                        await db.delete(this.storeName, backupId);
                        this.loadBackupList();
                        this.updateBackupCount();
                        alert('Backup eliminado');
                    } catch (error) {
                        console.error('Error eliminando backup:', error);
                        alert('Error al eliminar backup');
                    }
                }
            }
        }

        // Inicializar Backup Manager cuando se cargue la página
        let backupManager;
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar después de un breve delay para asegurar que todo esté cargado
            setTimeout(() => {
                backupManager = new BackupManager();
            }, 1000);
        });

        // Hacer funciones disponibles globalmente
        function exportarInspeccionAZip() {
            if (backupManager) {
                backupManager.exportarInspeccionAZip();
            }
        }

        function importarDesdeZip(file) {
            if (backupManager) {
                backupManager.importarDesdeZip(file);
            }
        }

        function mostrarModalBackups() {
            if (backupManager) {
                backupManager.mostrarModalBackups();
            }
        }

        function cerrarModalBackups() {
            if (backupManager) {
                backupManager.cerrarModalBackups();
            }
        }

        function guardarBackupManual() {
            if (backupManager) {
                backupManager.guardarBackupManual();
            }
        }

        function limpiarBackupActual() {
            if (backupManager) {
                backupManager.limpiarBackupActual();
            }
        }

        // ============================================================================
        // AJUSTES DE INTEGRACIÓN (SIN MODIFICAR FUNCIONALIDAD EXISTENTE)
        // ============================================================================
        // - Tabs del modal de backups
        // - Configuración de autoguardado (checkbox + frecuencia)
        // - Visual de "Hace Xs" para último guardado
        // - Compatibilidad modal-overlay (hidden vs active)

        function _backupActivateTab(tabName) {
            const btns = document.querySelectorAll('#modal_backups .tab-btn');
            const panes = {
                current: document.getElementById('tab_current'),
                saved: document.getElementById('tab_saved'),
                imported: document.getElementById('tab_imported')
            };
            btns.forEach(b => b.classList.remove('active'));
            btns.forEach(b => {
                if (b.dataset.tab === tabName) b.classList.add('active');
            });
            Object.keys(panes).forEach(k => {
                if (!panes[k]) return;
                if (k === tabName) panes[k].classList.remove('hidden');
                else panes[k].classList.add('hidden');
            });
        }

        function _backupBindModalUI() {
            const modal = document.getElementById('modal_backups');
            if (!modal) return;

            // Tabs
            modal.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => _backupActivateTab(btn.dataset.tab));
            });

            // Config
            const freqSel = document.getElementById('autosave_frequency');
            const enableChk = document.getElementById('enable_autosave');

            if (freqSel) {
                freqSel.value = '30';
                freqSel.addEventListener('change', () => {
                    if (!backupManager) return;
                    const v = parseInt(freqSel.value, 10);
                    backupManager.autoSaveFrequency = isNaN(v) ? 30 : v;
                    backupManager.setupAutoSave();
                });
            }

            if (enableChk) {
                enableChk.checked = true;
                enableChk.addEventListener('change', () => {
                    if (!backupManager) return;
                    backupManager.autoSaveEnabled = !!enableChk.checked;
                    backupManager.setupAutoSave();
                });
            }
        }

        // Patch: mostrar/cerrar modal con compatibilidad de CSS existente
        (function() {
            const _origShow = BackupManager.prototype.mostrarModalBackups;
            const _origClose = BackupManager.prototype.cerrarModalBackups;

            BackupManager.prototype.mostrarModalBackups = function() {
                const el = document.getElementById('modal_backups');
                if (el) { el.classList.remove('hidden'); el.classList.add('active'); }
                _backupActivateTab('current');
                _backupBindModalUI();
                return this.loadBackupList();
            };

            BackupManager.prototype.cerrarModalBackups = function() {
                const el = document.getElementById('modal_backups');
                if (el) { el.classList.add('hidden'); el.classList.remove('active'); }
            };

            // Guardar interval para "Hace Xs"
            BackupManager.prototype._startLastSaveTicker = function() {
                if (this._lastSaveTicker) clearInterval(this._lastSaveTicker);
                this._lastSaveTicker = setInterval(() => {
                    const out = document.getElementById('last_save_time');
                    if (!out) return;
                    if (!this.lastSaveTime) { out.textContent = '—'; return; }
                    const diff = Math.max(0, Math.floor((Date.now() - this.lastSaveTime.getTime()) / 1000));
                    if (diff < 60) out.textContent = `Hace ${diff}s`;
                    else if (diff < 3600) out.textContent = `Hace ${Math.floor(diff/60)}m`;
                    else out.textContent = `Hace ${Math.floor(diff/3600)}h`;
                }, 1000);
            };

            const _origSave = BackupManager.prototype.saveBackup;
            BackupManager.prototype.saveBackup = async function() {
                const res = await _origSave.apply(this, arguments);
                // Asegurar ticker activo
                if (this.lastSaveTime) this._startLastSaveTicker();
                return res;
            };
        })();

</script>

    <!-- Modal de gestión de backups -->
    <div class="modal-overlay hidden" id="modal_backups">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-database mr-2"></i>Gestión de Backups</h3>
                <button class="modal-close" onclick="cerrarModalBackups()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Pestañas -->
                <div class="flex border-b border-gray-200 mb-4">
                    <button class="tab-btn active px-4 py-2 font-medium" data-tab="current">Inspección Actual</button>
                    <button class="tab-btn px-4 py-2 font-medium" data-tab="saved">Sesiones Guardadas</button>
                    <button class="tab-btn px-4 py-2 font-medium" data-tab="imported">Importadas</button>
                </div>

                <!-- Contenido de pestañas -->
                <div id="tab_current" class="tab-content">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <h4 class="font-bold text-blue-700 mb-2"><i class="fas fa-info-circle mr-2"></i>Estado Actual</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Iniciada:</span>
                                <span id="backup_current_start" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Último guardado:</span>
                                <span id="backup_current_last" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Elementos registrados:</span>
                                <span id="backup_current_items" class="font-medium">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="guardarBackupManual()" class="bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded font-medium">
                            <i class="fas fa-save mr-1"></i> Guardar Ahora
                        </button>
                        <button onclick="limpiarBackupActual()" class="bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded font-medium">
                            <i class="fas fa-trash mr-1"></i> Limpiar Backup
                        </button>
                    </div>
                </div>

                <div id="tab_saved" class="tab-content hidden">
                    <div class="text-center text-gray-500 py-8" id="no_saved_backups">
                        <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                        <p>No hay sesiones guardadas</p>
                    </div>
                    <div id="saved_backups_list" class="space-y-3 max-h-80 overflow-y-auto"></div>
                </div>

                <div id="tab_imported" class="tab-content hidden">
                    <div class="text-center text-gray-500 py-8" id="no_imported_backups">
                        <i class="fas fa-file-import fa-3x mb-3 opacity-50"></i>
                        <p>No hay inspecciones importadas</p>
                    </div>
                    <div id="imported_backups_list" class="space-y-3 max-h-80 overflow-y-auto"></div>
                </div>

                <!-- Configuración -->
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <h4 class="font-bold text-gray-700 mb-3"><i class="fas fa-cog mr-2"></i>Configuración</h4>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm">Frecuencia de autoguardado</span>
                            <select id="autosave_frequency" class="border rounded px-2 py-1 text-sm">
                                <option value="30">30 segundos</option>
                                <option value="60">1 minuto</option>
                                <option value="300">5 minutos</option>
                                <option value="0">Desactivado</option>
                            </select>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="enable_autosave" class="mr-2" checked>
                            <label for="enable_autosave" class="text-sm">Activar autoguardado</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


<script>
(function(){
  if(!('serviceWorker' in navigator)) return;
  window.addEventListener('load', async () => {
    try{
      await navigator.serviceWorker.register('./sw.js', { scope: './', updateViaCache: 'none' });
    }catch(e){
      console.warn('SW register failed', e);
    }
  });
})();
</script>

</body>
</html>